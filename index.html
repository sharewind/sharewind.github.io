<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="keywords" content=" 耐克赤足系列 耐克赤足2.0 3.0 4.0 5.0 7.0 耐克赤足跑鞋 耐克赤足二代 耐克编织跑鞋 耐克飞线系列 耐克飞线彩虹 耐克飞线气垫      耐克飞线价格 耐克飞线2014 耐克飞线鞋 耐克飞线登月 耐克飞线科技 耐克飞线2015 耐克登月系列 耐克登月3 4 5 6耐克登月系列跑步鞋 耐克阿甘鞋 耐克2013气垫鞋        耐克2014全掌气垫鞋 耐克2015气垫鞋 耐克max90高板反毛皮跑鞋" />
  <meta name="description" content="莆田批发高仿真标耐克系列跑鞋 耐克赤足滴塑新科技超轻NIKE FREE 5.0 耐克Nike Roshe Flyknit新款跑鞋 耐克2013磨砂皮            耐克赤足Nike Free 4.0 Flyknit赤足跑鞋 耐克登月6跑鞋 耐克2013男鞋 Nike Solarsoft Moccasin Woven 编织纹 超轻跑步鞋太阳神反毛皮 耐克2014飞线 耐克2015飞线      耐克登月NIKE FLYKNIT LUNAR2+编织版  耐克2013 耐克20K6代 7代 耐克87代系列轻量跑鞋" />
  
  <title>sharewind coder blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="sharewind coder blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="sharewind coder blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="sharewind coder blog">
  
    <link rel="alternate" href="/atom.xml" title="sharewind coder blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">sharewind coder blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="Flux RSS"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Rechercher"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/11/21/hello-world/" class="article-date">
  <time datetime="2017-11-21T14:35:13.556Z" itemprop="datePublished">2017-11-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/21/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

      
    </div>
    <footer class="article-footer2">
      <div id="footer-info" class="inner">
        <a href="http://www.618shoe.com/">莆田1:1精仿鞋微信号</a>
        <a href="http://www.618shoe.com/">莆田高仿鞋子的价格表</a>
        <a href="http://www.618shoe.com/">关于莆田仿鞋</a>
        <a href="http://www.618shoe.com/">莆田高仿鞋淘宝店店名</a>
        <a href="http://www.618shoe.com/">莆田精仿鞋官网</a>
         咨询QQ：<a title="点击这里给我发消息" href="http://wpa.qq.com/msgrd?v=3&amp;uin=2727291807&amp;site=www.cactussoft.cn&amp;menu=yes" target="_blank"><img src="http://wpa.qq.com/pa?p=2:2727291807:41"></a>
      </div>
        <div id="footer-info" class="inner">
          <a href="http://www.618shoe.com/">莆田高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">1：1高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">高仿鞋批发市场</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">高仿鞋网</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">广州高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">外贸尾单鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">精仿鞋专线</a>&nbsp;&nbsp;
      </div>
      <div id="footer-info" class="inner">
             <a href="http://www.618shoe.com/">莆田高仿鞋批发</a>&nbsp;&nbsp;
             公司网站:&nbsp;&nbsp;<a href="http://www.618shoe.com//" target="_blank">http://www.618shoe.com/</a>&nbsp;&nbsp;
             <a href="http://www.618shoe.com/">高仿鞋批发市场</a>
             微信 <img src="/pics/qrcode.jpg" style="width:100px;height:100px;">
      </div>
    </footer>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/11/21/hello-world/" data-id="cja9q2adx0033nh5iuclcqtsf" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-process-task-by-queue" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/01/16/process-task-by-queue/" class="article-date">
  <time datetime="2015-01-16T08:57:00.000Z" itemprop="datePublished">2015-01-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java-MultiThreading/">Java MultiThreading</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/16/process-task-by-queue/">process task by queue</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskQueue</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	ExecutorService executor = <span class="keyword">null</span>;</span><br><span class="line">	</span><br><span class="line">	ArrayBlockingQueue&lt;T&gt; queue;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> running = <span class="keyword">false</span>;	</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">(T item)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span>  <span class="title">TaskQueue</span><span class="params">(ExecutorService executor, ArrayBlockingQueue&lt;T&gt; queue)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.executor = executor;</span><br><span class="line">		<span class="keyword">this</span>.queue = queue;</span><br><span class="line">		start();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="comment">// start on Server startup</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		running = <span class="keyword">true</span>;		</span><br><span class="line">		executor.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				processTask();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">		Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				stop();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			T item = <span class="keyword">null</span>;</span><br><span class="line">			<span class="keyword">while</span>(running)&#123;</span><br><span class="line">				item = queue.poll(<span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">				<span class="keyword">if</span>(item != <span class="keyword">null</span>)&#123;</span><br><span class="line">					doWork(item);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// process left items on queue</span></span><br><span class="line">			<span class="keyword">while</span>((item = queue.poll() ) != <span class="keyword">null</span>)&#123;</span><br><span class="line">				doWork(item);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			Thread.currentThread().interrupt();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			running = <span class="keyword">false</span>;</span><br><span class="line"><span class="comment">//			long start = System.currentTimeMillis();</span></span><br><span class="line">			executor.shutdown();</span><br><span class="line">			executor.awaitTermination(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line"><span class="comment">//			long cost = System.currentTimeMillis() - start;</span></span><br><span class="line"><span class="comment">//			System.out.println("cost time " + cost + "ms");</span></span><br><span class="line">			executor = <span class="keyword">null</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			Thread.currentThread().interrupt();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(T item)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//			System.out.println("put answer " + survey.getTitle());</span></span><br><span class="line">			queue.put(item);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnswerStatQueue</span> <span class="keyword">extends</span> <span class="title">TaskQueue</span>&lt;<span class="title">Answer</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">	AnswerService answerService = <span class="keyword">new</span> AnswerService();</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">AnswerStatQueue</span><span class="params">(ExecutorService executor, ArrayBlockingQueue&lt;Answer&gt; queue)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(executor, queue);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">(Answer answer)</span> </span>&#123;</span><br><span class="line"><span class="comment">//		System.out.println("procss answer " + answer.getTitle());</span></span><br><span class="line">		answerService.incrSurveyStat(answer);</span><br><span class="line"><span class="comment">//		System.out.println("finish answer ......!!!");</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//***************************single instance *****************************</span></span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> AnswerStatQueue instance;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AnswerStatQueue <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(instance == <span class="keyword">null</span>)&#123;</span><br><span class="line">			<span class="keyword">synchronized</span> (AnswerStatQueue.class) &#123;</span><br><span class="line">				<span class="keyword">if</span>(instance == <span class="keyword">null</span>)&#123;</span><br><span class="line">					instance = createAnswerStateQueue();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> instance;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> AnswerStatQueue <span class="title">createAnswerStateQueue</span><span class="params">()</span></span>&#123;</span><br><span class="line">		ExecutorService executor = Executors.newSingleThreadExecutor();</span><br><span class="line">		ArrayBlockingQueue&lt;Answer&gt; queue = <span class="keyword">new</span> ArrayBlockingQueue&lt;Answer&gt;(<span class="number">10000</span>);</span><br><span class="line">		instance = <span class="keyword">new</span> AnswerStatQueue(executor, queue);</span><br><span class="line">		<span class="keyword">return</span> instance;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer2">
      <div id="footer-info" class="inner">
        <a href="http://www.618shoe.com/">莆田1:1精仿鞋微信号</a>
        <a href="http://www.618shoe.com/">莆田高仿鞋子的价格表</a>
        <a href="http://www.618shoe.com/">关于莆田仿鞋</a>
        <a href="http://www.618shoe.com/">莆田高仿鞋淘宝店店名</a>
        <a href="http://www.618shoe.com/">莆田精仿鞋官网</a>
         咨询QQ：<a title="点击这里给我发消息" href="http://wpa.qq.com/msgrd?v=3&amp;uin=2727291807&amp;site=www.cactussoft.cn&amp;menu=yes" target="_blank"><img src="http://wpa.qq.com/pa?p=2:2727291807:41"></a>
      </div>
        <div id="footer-info" class="inner">
          <a href="http://www.618shoe.com/">莆田高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">1：1高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">高仿鞋批发市场</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">高仿鞋网</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">广州高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">外贸尾单鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">精仿鞋专线</a>&nbsp;&nbsp;
      </div>
      <div id="footer-info" class="inner">
             <a href="http://www.618shoe.com/">莆田高仿鞋批发</a>&nbsp;&nbsp;
             公司网站:&nbsp;&nbsp;<a href="http://www.618shoe.com//" target="_blank">http://www.618shoe.com/</a>&nbsp;&nbsp;
             <a href="http://www.618shoe.com/">高仿鞋批发市场</a>
             微信 <img src="/pics/qrcode.jpg" style="width:100px;height:100px;">
      </div>
    </footer>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/01/16/process-task-by-queue/" data-id="cja9q2ady0034nh5i3iwosjvg" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-threadpoolexecutor" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/01/15/threadpoolexecutor/" class="article-date">
  <time datetime="2015-01-15T08:38:00.000Z" itemprop="datePublished">2015-01-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java-MultiThreading/">Java MultiThreading</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/15/threadpoolexecutor/">ThreadPoolExecutor 学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="一、接口-ExecutorService-线程池服务接口"><a href="#一、接口-ExecutorService-线程池服务接口" class="headerlink" title="一、接口 ExecutorService 线程池服务接口"></a>一、接口 ExecutorService 线程池服务接口</h4><p>#####1. 提交任务</p>
<figure class="highlight java"><figcaption><span>提交任务</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">	&lt;T&gt; <span class="function">Future&lt;T&gt; <span class="title">submit</span><span class="params">(Callable&lt;T&gt; task)</span> </span></span><br><span class="line"><span class="function">			  提交一个返回值的任务用于执行，返回一个表示任务的未决结果的 Future。</span></span><br><span class="line"><span class="function">	 Future&lt;?&gt;	<span class="title">submit</span><span class="params">(Runnable task)</span> </span></span><br><span class="line"><span class="function">			  提交一个 Runnable 任务用于执行，并返回一个表示该任务的 Future。</span></span><br><span class="line"><span class="function">	&lt;T&gt; Future&lt;T&gt; <span class="title">submit</span><span class="params">(Runnable task, T result)</span> </span></span><br><span class="line"><span class="function">			  提交一个 Runnable 任务用于执行，并返回一个表示该任务的 Future。</span></span><br><span class="line"><span class="function">			  </span></span><br><span class="line"><span class="function">```			</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#####2.执行所有任务或执行任一任务</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">``` java 执行所有任务或执行任一任务</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">	&lt;T&gt; List&lt;Future&lt;T&gt;&gt; <span class="title">invokeAll</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span> </span></span><br><span class="line"><span class="function">			  执行给定的任务，当所有任务完成时，返回保持任务状态和结果的 Future 列表。</span></span><br><span class="line"><span class="function">	&lt;T&gt; List&lt;Future&lt;T&gt;&gt; <span class="title">invokeAll</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, <span class="keyword">long</span> timeout, TimeUnit unit)</span> </span></span><br><span class="line"><span class="function">			  执行给定的任务，当所有任务完成或超时期满时（无论哪个首先发生），返回保持任务状态和结果的 Future 列表。</span></span><br><span class="line"><span class="function">	&lt;T&gt; T <span class="title">invokeAny</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span> </span></span><br><span class="line"><span class="function">			  执行给定的任务，如果某个任务已成功完成（也就是未抛出异常），则返回其结果。</span></span><br><span class="line"><span class="function">	&lt;T&gt; T <span class="title">invokeAny</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, <span class="keyword">long</span> timeout, TimeUnit unit)</span> </span></span><br><span class="line"><span class="function">			  执行给定的任务，如果在给定的超时期满前某个任务已成功完成（也就是未抛出异常），则返回其结果。</span></span><br></pre></td></tr></table></figure>
<p>#####3. 关闭线程池服务</p>
<figure class="highlight java"><figcaption><span>关闭线程池服务</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>	<span class="title">shutdown</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">	  启动一次顺序关闭，执行以前提交的任务，但不接受新任务。</span></span><br><span class="line"><span class="function">List&lt;Runnable&gt;	<span class="title">shutdownNow</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">	  试图停止所有正在执行的活动任务，暂停处理正在等待的任务，并返回等待执行的任务列表。</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span>	<span class="title">isShutdown</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">	  如果此执行程序已关闭，则返回 <span class="keyword">true</span>。</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span>	<span class="title">isTerminated</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">	  如果关闭后所有任务都已完成，则返回 <span class="keyword">true</span>。</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span>	<span class="title">awaitTermination</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span> </span></span><br><span class="line"><span class="function">	  请求关闭、发生超时或者当前线程中断，无论哪一个首先发生之后，都将导致阻塞，直到所有任务完成执行。</span></span><br></pre></td></tr></table></figure>
<p>#####关闭ExecutorService<br>下列方法分两个阶段关闭 ExecutorService。第一阶段调用 shutdown 拒绝传入任务，然后调用 shutdownNow（如有必要）取消所有遗留的任务：</p>
<figure class="highlight java"><figcaption><span>shutdownAndAwaitTermination</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shutdownAndAwaitTermination</span><span class="params">(ExecutorService pool)</span> </span>&#123;</span><br><span class="line">  pool.shutdown(); <span class="comment">// Disable new tasks from being submitted</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line"> <span class="comment">// Wait a while for existing tasks to terminate</span></span><br><span class="line"> <span class="keyword">if</span> (!pool.awaitTermination(<span class="number">60</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">   pool.shutdownNow(); <span class="comment">// Cancel currently executing tasks</span></span><br><span class="line">   <span class="comment">// Wait a while for tasks to respond to being cancelled</span></span><br><span class="line">   <span class="keyword">if</span> (!pool.awaitTermination(<span class="number">60</span>, TimeUnit.SECONDS))</span><br><span class="line">	   System.err.println(<span class="string">"Pool did not terminate"</span>);</span><br><span class="line"> &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line"> <span class="comment">// (Re-)Cancel if current thread also interrupted</span></span><br><span class="line"> pool.shutdownNow();</span><br><span class="line"> <span class="comment">// Preserve interrupt status</span></span><br><span class="line"> Thread.currentThread().interrupt();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="二、ThreadPoolExecutor-的整体介绍"><a href="#二、ThreadPoolExecutor-的整体介绍" class="headerlink" title="二、ThreadPoolExecutor 的整体介绍"></a>二、ThreadPoolExecutor 的整体介绍</h4><p><strong>核心和最大池大小</strong><br>ThreadPoolExecutor 将根据 corePoolSize（参见 getCorePoolSize()）和 maximumPoolSize（参见 getMaximumPoolSize()）设置的边界自动调整池大小。  </p>
<ul>
<li>当新任务在方法 execute(java.lang.Runnable) 中提交时，如果运行的线程少于 corePoolSize，则创建新线程来处理请求，即使其他辅助线程是空闲的。  </li>
<li>如果运行的线程多于 corePoolSize 而少于 maximumPoolSize，则仅当队列满时才创建新线程。如果设置的 corePoolSize 和 maximumPoolSize 相同，则创建了固定大小的线程池。  </li>
<li>如果将 maximumPoolSize 设置为基本的无界值（如 Integer.MAX_VALUE），则允许池适应任意数量的并发任务。</li>
</ul>
<p><strong>按需构造</strong><br>默认情况下，即使核心线程最初只是在新任务到达时才创建和启动的，也可以使用方法 prestartCoreThread() 或 prestartAllCoreThreads() 对其进行动态重写。如果构造带有非空队列的池，则可能希望预先启动线程。</p>
<p><strong>保持活动时间</strong><br>如果池中当前有多于 corePoolSize 的线程，则这些多出的线程在空闲时间超过 keepAliveTime 时将会终止（参见 getKeepAliveTime(java.util.concurrent.TimeUnit)）。这提供了当池处于非活动状态时减少资源消耗的方法。<br>如果池后来变得更为活动，则可以创建新的线程。也可以使用方法 setKeepAliveTime(long, java.util.concurrent.TimeUnit) 动态地更改此参数。<br>使用 Long.MAX_VALUE TimeUnit.NANOSECONDS 的值在关闭前有效地从以前的终止状态禁用空闲线程。默认情况下，保持活动策略只在有多于 corePoolSizeThreads 的线程时应用。<br>但是只要 keepAliveTime 值非 0，<code>allowCoreThreadTimeOut(boolean)</code> <u>方法也可将此超时策略应用于核心线程。</u></p>
<p><strong>排队</strong><br>所有 BlockingQueue 都可用于传输和保持提交的任务。可以使用此队列与池大小进行交互：</p>
<ol>
<li>如果运行的线程少于 corePoolSize，则 Executor 始终首选添加新的线程，而不进行排队。</li>
<li>如果运行的线程等于或多于 corePoolSize，则 Executor 始终首选将请求加入队列，而不添加新的线程。</li>
<li>如果无法将请求加入队列，则创建新的线程，除非创建此线程超出 maximumPoolSize，在这种情况下，任务将被拒绝。</li>
</ol>
<p>排队有三种通用策略：</p>
<ol>
<li><em>直接提交。</em><b>工作队列的默认选项是 SynchronousQueue，它将任务直接提交给线程而不保持它们。</b>在此，如果不存在可用于立即运行任务的线程，则试图把任务加入队列将失败，因此会构造一个新的线程。此策略可以避免在处理可能具有内部依赖性的请求集时出现锁。直接提交通常要求无界 maximumPoolSizes 以避免拒绝新提交的任务。当命令以超过队列所能处理的平均数连续到达时，此策略允许无界线程具有增长的可能性。</li>
<li><em>无界队列。</em><b>使用无界队列（例如，不具有预定义容量的 LinkedBlockingQueue）将导致在所有 corePoolSize 线程都忙时新任务在队列中等待。</b>这样，创建的线程就不会超过 corePoolSize。（因此，maximumPoolSize 的值也就无效了。）当每个任务完全独立于其他任务，即任务执行互不影响时，适合于使用无界队列；例如，在 Web 页服务器中。这种排队可用于处理瞬态突发请求，当命令以超过队列所能处理的平均数连续到达时，此策略允许无界线程具有增长的可能性。</li>
<li><em>有界队列。</em><b>当使用有限的 maximumPoolSizes 时，有界队列（如 ArrayBlockingQueue）有助于防止资源耗尽，但是可能较难调整和控制。</b>队列大小和最大池大小可能需要相互折衷：使用大型队列和小型池可以最大限度地降低 CPU 使用率、操作系统资源和上下文切换开销，但是可能导致人工降低吞吐量。如果任务频繁阻塞（例如，如果它们是 I/O 边界），则系统可能为超过您许可的更多线程安排时间。使用小型队列通常要求较大的池大小，CPU 使用率较高，但是可能遇到不可接受的调度开销，这样也会降低吞吐量。</li>
</ol>
<p><strong>被拒绝的任务</strong><br>当 Executor 已经关闭，并且 Executor 将有限边界用于最大线程和工作队列容量，且已经饱和时，在方法 execute(java.lang.Runnable) 中提交的新任务将被拒绝。<br>在以上两种情况下，execute 方法都将调用其 RejectedExecutionHandler 的 RejectedExecutionHandler.rejectedExecution(java.lang.Runnable, java.util.concurrent.ThreadPoolExecutor) 方法。  </p>
<p>下面提供了四种预定义的处理程序策略：   </p>
<ol>
<li>在默认的 ThreadPoolExecutor.AbortPolicy 中，处理程序遭到拒绝将抛出运行时 RejectedExecutionException。</li>
<li>在 ThreadPoolExecutor.CallerRunsPolicy 中，线程调用运行该任务的 execute 本身。此策略提供简单的反馈控制机制，能够减缓新任务的提交速度。</li>
<li>在 ThreadPoolExecutor.DiscardPolicy 中，不能执行的任务将被删除。<br>4。 在 ThreadPoolExecutor.DiscardOldestPolicy 中，如果执行程序尚未关闭，则位于工作队列头部的任务将被删除，然后重试执行程序（如果再次失败，则重复此过程）。<br>定义和使用其他种类的 RejectedExecutionHandler 类也是可能的，但这样做需要非常小心，尤其是当策略仅用于特定容量或排队策略时。</li>
</ol>
<p><strong>钩子 (hook) 方法</strong><br>此类提供 protected 可重写的 beforeExecute(java.lang.Thread, java.lang.Runnable) 和 afterExecute(java.lang.Runnable, java.lang.Throwable) 方法，这两种方法分别在执行每个任务之前和之后调用。<br>它们可用于操纵执行环境；例如，重新初始化 ThreadLocal、搜集统计信息或添加日志条目。此外，还可以重写方法 terminated() 来执行 Executor 完全终止后需要完成的所有特殊处理。<br>如果钩子 (hook) 或回调方法抛出异常，则内部辅助线程将依次失败并突然终止。</p>
<p><strong>队列维护</strong><br>方法 getQueue() 允许出于监控和调试目的而访问工作队列。强烈反对出于其他任何目的而使用此方法。remove(java.lang.Runnable) 和 purge() 这两种方法可用于在取消大量已排队任务时帮助进行存储回收。  </p>
<p><b>线程池没有被程序里的其它对象引用，且没有剩余的线程会时，会自动 shutdown。</b>如果希望确保回收取消引用的池（即使用户忘记调用 shutdown()），则必须安排未使用的线程最终终止：设置适当保持活动时间，使用 0 核心线程的下边界和/或设置 allowCoreThreadTimeOut(boolean)。</p>
<h4 id="三、ThreadPoolExecutor内部实现"><a href="#三、ThreadPoolExecutor内部实现" class="headerlink" title="三、ThreadPoolExecutor内部实现"></a>三、ThreadPoolExecutor内部实现</h4><figure class="highlight java"><figcaption><span>ThreadPoolExecutor</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractExecutorService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**	</span></span><br><span class="line"><span class="comment">    * 线程池的主控制状态 ctl ，用 atomic integer 来表示两个概念的字段</span></span><br><span class="line"><span class="comment">    *   workerCount, 指示当前有效的线程数</span></span><br><span class="line"><span class="comment">    *   runState,    指示当前的运行状态 running, shutting down etc</span></span><br><span class="line"><span class="comment">    * 为了把两个字段打包成一个int, 限制workerCount  to</span></span><br><span class="line"><span class="comment">    * (2^29)-1 (about 500 million) threads rather than (2^31)-1 (2</span></span><br><span class="line"><span class="comment">    * billion) otherwise representable. </span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * The runState provides the main lifecyle control, taking on values:</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    *   RUNNING:  Accept new tasks and process queued tasks</span></span><br><span class="line"><span class="comment">    *   SHUTDOWN: Don't accept new tasks, but process queued tasks</span></span><br><span class="line"><span class="comment">    *   STOP:     Don't accept new tasks, don't process queued tasks,</span></span><br><span class="line"><span class="comment">    *             and interrupt in-progress tasks</span></span><br><span class="line"><span class="comment">    *   TIDYING:  All tasks have terminated, workerCount is zero,</span></span><br><span class="line"><span class="comment">    *             the thread transitioning to state TIDYING</span></span><br><span class="line"><span class="comment">    *             will run the terminated() hook method</span></span><br><span class="line"><span class="comment">    *   TERMINATED: terminated() has completed</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * 运行状态的次序很重要，可以用来进行比较。runState 随着时间单调递增的, but need not hit each state. The transitions are:</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * RUNNING -&gt; SHUTDOWN</span></span><br><span class="line"><span class="comment">    *    On invocation of shutdown(), perhaps implicitly in finalize()</span></span><br><span class="line"><span class="comment">    * (RUNNING or SHUTDOWN) -&gt; STOP</span></span><br><span class="line"><span class="comment">    *    On invocation of shutdownNow()</span></span><br><span class="line"><span class="comment">    * SHUTDOWN -&gt; TIDYING</span></span><br><span class="line"><span class="comment">    *    When both queue and pool are empty</span></span><br><span class="line"><span class="comment">    * STOP -&gt; TIDYING</span></span><br><span class="line"><span class="comment">    *    When pool is empty</span></span><br><span class="line"><span class="comment">    * TIDYING -&gt; TERMINATED</span></span><br><span class="line"><span class="comment">    *    When the terminated() hook method has completed</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * Threads waiting in awaitTermination() will return when the</span></span><br><span class="line"><span class="comment">    * state reaches TERMINATED.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * 为什么从SHUTDOWN 转到 TIDYING 需要检测，因为 queue有可能从non-emtpy 转变 empty ,</span></span><br><span class="line"><span class="comment">    * but we can only terminate if, after seeing that it is empty, we see</span></span><br><span class="line"><span class="comment">    * that workerCount is 0 (which sometimes entails a recheck -- see</span></span><br><span class="line"><span class="comment">    * below).</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger ctl = <span class="keyword">new</span> AtomicInteger(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COUNT_BITS = Integer.SIZE - <span class="number">3</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CAPACITY   = (<span class="number">1</span> &lt;&lt; COUNT_BITS) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// runState is stored in the high-order bits</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RUNNING    = -<span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHUTDOWN   =  <span class="number">0</span> &lt;&lt; COUNT_BITS;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STOP       =  <span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TIDYING    =  <span class="number">2</span> &lt;&lt; COUNT_BITS;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TERMINATED =  <span class="number">3</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Packing and unpacking ctl</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">runStateOf</span><span class="params">(<span class="keyword">int</span> c)</span>     </span>&#123; <span class="keyword">return</span> c &amp; ~CAPACITY; &#125;</span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">workerCountOf</span><span class="params">(<span class="keyword">int</span> c)</span>  </span>&#123; <span class="keyword">return</span> c &amp; CAPACITY; &#125;</span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ctlOf</span><span class="params">(<span class="keyword">int</span> rs, <span class="keyword">int</span> wc)</span> </span>&#123; <span class="keyword">return</span> rs | wc; &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isRunning</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> c &lt; SHUTDOWN;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Attempt to CAS-increment the workerCount field of ctl.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">compareAndIncrementWorkerCount</span><span class="params">(<span class="keyword">int</span> expect)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> ctl.compareAndSet(expect, expect + <span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Attempt to CAS-decrement the workerCount field of ctl.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">compareAndDecrementWorkerCount</span><span class="params">(<span class="keyword">int</span> expect)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> ctl.compareAndSet(expect, expect - <span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Decrements the workerCount field of ctl. This is called only on</span></span><br><span class="line"><span class="comment">    * abrupt termination of a thread (see processWorkerExit). Other</span></span><br><span class="line"><span class="comment">    * decrements are performed within getTask.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">decrementWorkerCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">do</span> &#123;&#125; <span class="keyword">while</span> (! compareAndDecrementWorkerCount(ctl.get()));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存任务的工作队列</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; workQueue;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存当前正在执行线程的workers集合</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> HashSet&lt;Worker&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 主要的lock</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition termination = mainLock.newCondition();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> keepAliveTime;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> allowCoreThreadTimeOut;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//*************************Worker***********************************</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Class Worker mainly maintains interrupt control state for</span></span><br><span class="line"><span class="comment">    * threads running tasks, along with other minor bookkeeping.</span></span><br><span class="line"><span class="comment">    * This class opportunistically extends AbstractQueuedSynchronizer</span></span><br><span class="line"><span class="comment">    * to simplify acquiring and releasing a lock surrounding each</span></span><br><span class="line"><span class="comment">    * task execution.  This protects against interrupts that are</span></span><br><span class="line"><span class="comment">    * intended to wake up a worker thread waiting for a task from</span></span><br><span class="line"><span class="comment">    * instead interrupting a task being run.  We implement a simple</span></span><br><span class="line"><span class="comment">    * non-reentrant mutual exclusion lock rather than use</span></span><br><span class="line"><span class="comment">    * ReentrantLock because we do not want worker tasks to be able to</span></span><br><span class="line"><span class="comment">    * reacquire the lock when they invoke pool control methods like</span></span><br><span class="line"><span class="comment">    * setCorePoolSize.  Additionally, to suppress interrupts until</span></span><br><span class="line"><span class="comment">    * the thread actually starts running tasks, we initialize lock</span></span><br><span class="line"><span class="comment">    * state to a negative value, and clear it upon start (in</span></span><br><span class="line"><span class="comment">    * runWorker).</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Worker</span></span></span><br><span class="line"><span class="class">       <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span></span></span><br><span class="line"><span class="class">       <span class="keyword">implements</span> <span class="title">Runnable</span></span></span><br><span class="line"><span class="class">   </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">/** Thread this worker is running in.  Null if factory fails. */</span></span><br><span class="line">       <span class="keyword">final</span> Thread thread;</span><br><span class="line">       <span class="comment">/** Initial task to run.  Possibly null. */</span></span><br><span class="line">       Runnable firstTask;</span><br><span class="line">       <span class="comment">/** Per-thread task counter */</span></span><br><span class="line">       <span class="keyword">volatile</span> <span class="keyword">long</span> completedTasks;</span><br><span class="line"></span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * Creates with given first task and thread from ThreadFactory.</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> firstTask the first task (null if none)</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       Worker(Runnable firstTask) &#123;</span><br><span class="line">       	<span class="comment">// 初始Worker状态为-1</span></span><br><span class="line">           setState(-<span class="number">1</span>); <span class="comment">// inhibit interrupts until runWorker</span></span><br><span class="line">           <span class="keyword">this</span>.firstTask = firstTask;</span><br><span class="line">           <span class="comment">// 创建一个新的Thread线程对象</span></span><br><span class="line">           <span class="keyword">this</span>.thread = getThreadFactory().newThread(<span class="keyword">this</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">/** Delegates main run loop to outer runWorker  */</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       	<span class="comment">// 这里调用外部的runWorker!!!</span></span><br><span class="line">           runWorker(<span class="keyword">this</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Lock methods</span></span><br><span class="line">       <span class="comment">//</span></span><br><span class="line">       <span class="comment">// The value 0 represents the unlocked state.</span></span><br><span class="line">       <span class="comment">// The value 1 represents the locked state.</span></span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isHeldExclusively</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> getState() != <span class="number">0</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">               setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</span><br><span class="line">           setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">           setState(<span class="number">0</span>);</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span>        </span>&#123; acquire(<span class="number">1</span>); &#125;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span>  </span>&#123; <span class="keyword">return</span> tryAcquire(<span class="number">1</span>); &#125;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span>      </span>&#123; release(<span class="number">1</span>); &#125;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLocked</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> isHeldExclusively(); &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 用于外部的中断控制(强制中断)</span></span><br><span class="line">       <span class="function"><span class="keyword">void</span> <span class="title">interruptIfStarted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           Thread t;</span><br><span class="line">           <span class="comment">// 当前Worker状态已启动，并且线程不为空</span></span><br><span class="line">           <span class="keyword">if</span> (getState() &gt;= <span class="number">0</span> &amp;&amp; (t = thread) != <span class="keyword">null</span> &amp;&amp; !t.isInterrupted()) &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   t.interrupt();</span><br><span class="line">               &#125; <span class="keyword">catch</span> (SecurityException ignore) &#123;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> ONLY_ONE = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">terminated</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Transitions to TERMINATED state if either (SHUTDOWN and pool</span></span><br><span class="line"><span class="comment">    * and queue empty) or (STOP and pool empty).  If otherwise</span></span><br><span class="line"><span class="comment">    * eligible to terminate but workerCount is nonzero, interrupts an</span></span><br><span class="line"><span class="comment">    * idle worker to ensure that shutdown signals propagate. This</span></span><br><span class="line"><span class="comment">    * method must be called following any action that might make</span></span><br><span class="line"><span class="comment">    * termination possible -- reducing worker count or removing tasks</span></span><br><span class="line"><span class="comment">    * from the queue during shutdown. The method is non-private to</span></span><br><span class="line"><span class="comment">    * allow access from ScheduledThreadPoolExecutor.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="comment">// 在每个 Worker 退时，会调用 tryTerminate 方法，所以这个方法会被调用多次</span></span><br><span class="line">   <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">tryTerminate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">           <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">           <span class="keyword">if</span> (isRunning(c) ||</span><br><span class="line">               runStateAtLeast(c, TIDYING) ||</span><br><span class="line">               (runStateOf(c) == SHUTDOWN &amp;&amp; ! workQueue.isEmpty()))</span><br><span class="line">               <span class="comment">// 处理以下状态直接返回</span></span><br><span class="line">               <span class="comment">// 正在运行，</span></span><br><span class="line">               <span class="comment">// 已经&gt;TIDYING 清理中</span></span><br><span class="line">               <span class="comment">// SHUTDOWN ,但 workQueue不为空</span></span><br><span class="line">               <span class="keyword">return</span>;  </span><br><span class="line">               </span><br><span class="line">            <span class="comment">// 活动线程数不为0里，中断一个空闲Worker并return    </span></span><br><span class="line">           <span class="keyword">if</span> (workerCountOf(c) != <span class="number">0</span>) &#123; <span class="comment">// Eligible to terminate</span></span><br><span class="line">               interruptIdleWorkers(ONLY_ONE);</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 当活动工作线程数为0时</span></span><br><span class="line">           <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">           mainLock.lock();</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">           	<span class="comment">// 设置为 TIDYING 状态</span></span><br><span class="line">               <span class="keyword">if</span> (ctl.compareAndSet(c, ctlOf(TIDYING, <span class="number">0</span>))) &#123;</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       terminated();</span><br><span class="line">                   &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                   	 <span class="comment">// 设置为 TERMINATED 终止状态</span></span><br><span class="line">                       ctl.set(ctlOf(TERMINATED, <span class="number">0</span>));</span><br><span class="line">                       <span class="comment">// 发送 termination.signalAll 信号， 在 awaitTermination 方法中等待该信号</span></span><br><span class="line">                       termination.signalAll();</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">return</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">               mainLock.unlock();</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// else retry on failed CAS</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//******************************** interruptWorkers ***************************</span></span><br><span class="line">       </span><br><span class="line">   </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Interrupts all threads, even if active. Ignores SecurityExceptions</span></span><br><span class="line"><span class="comment">    * (in which case some threads may remain uninterrupted).</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="comment">// 强制中断所有Worker,即使Worker 正在运行中</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">interruptWorkers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">       mainLock.lock();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">for</span> (Worker w : workers)</span><br><span class="line">               w.interruptIfStarted();</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           mainLock.unlock();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Interrupts threads that might be waiting for tasks (as</span></span><br><span class="line"><span class="comment">    * indicated by not being locked) so they can check for</span></span><br><span class="line"><span class="comment">    * termination or configuration changes. Ignores</span></span><br><span class="line"><span class="comment">    * SecurityExceptions (in which case some threads may remain</span></span><br><span class="line"><span class="comment">    * uninterrupted).</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> onlyOne If true, interrupt at most one worker. This is</span></span><br><span class="line"><span class="comment">    * called only from tryTerminate when termination is otherwise</span></span><br><span class="line"><span class="comment">    * enabled but there are still other workers.  In this case, at</span></span><br><span class="line"><span class="comment">    * most one waiting worker is interrupted to propagate shutdown</span></span><br><span class="line"><span class="comment">    * signals in case all threads are currently waiting.</span></span><br><span class="line"><span class="comment">    * Interrupting any arbitrary thread ensures that newly arriving</span></span><br><span class="line"><span class="comment">    * workers since shutdown began will also eventually exit.</span></span><br><span class="line"><span class="comment">    * To guarantee eventual termination, it suffices to always</span></span><br><span class="line"><span class="comment">    * interrupt only one idle worker, but shutdown() interrupts all</span></span><br><span class="line"><span class="comment">    * idle workers so that redundant workers exit promptly, not</span></span><br><span class="line"><span class="comment">    * waiting for a straggler task to finish.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="comment">// 中断空闲Worker</span></span><br><span class="line">   <span class="comment">// @param onlyOne 为true，只来自 tryTerminate的调用。</span></span><br><span class="line">       </span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">interruptIdleWorkers</span><span class="params">(<span class="keyword">boolean</span> onlyOne)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">       mainLock.lock();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">for</span> (Worker w : workers) &#123;</span><br><span class="line">               Thread t = w.thread;</span><br><span class="line">               <span class="comment">// 这里获取Worker的锁，说明当前线程处getTask 的wait状态</span></span><br><span class="line">               <span class="comment">// Worker 在运行时获取独占锁，在getTask释放锁，这里只中断空闲线程</span></span><br><span class="line">               <span class="keyword">if</span> (!t.isInterrupted() &amp;&amp; w.tryLock()) &#123;</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       t.interrupt();</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (SecurityException ignore) &#123;</span><br><span class="line">                   &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                       w.unlock();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               </span><br><span class="line">               <span class="comment">// 只中断一个，返回</span></span><br><span class="line">               <span class="keyword">if</span> (onlyOne)</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           mainLock.unlock();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">interruptIdleWorkers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       interruptIdleWorkers(<span class="keyword">false</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Drains the task queue into a new list, normally using</span></span><br><span class="line"><span class="comment">    * drainTo. But if the queue is a DelayQueue or any other kind of</span></span><br><span class="line"><span class="comment">    * queue for which poll or drainTo may fail to remove some</span></span><br><span class="line"><span class="comment">    * elements, it deletes them one by one.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> List&lt;Runnable&gt; <span class="title">drainQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       BlockingQueue&lt;Runnable&gt; q = workQueue;</span><br><span class="line">       List&lt;Runnable&gt; taskList = <span class="keyword">new</span> ArrayList&lt;Runnable&gt;();</span><br><span class="line">       q.drainTo(taskList);</span><br><span class="line">       <span class="keyword">if</span> (!q.isEmpty()) &#123;</span><br><span class="line">           <span class="keyword">for</span> (Runnable r : q.toArray(<span class="keyword">new</span> Runnable[<span class="number">0</span>])) &#123;</span><br><span class="line">               <span class="keyword">if</span> (q.remove(r))</span><br><span class="line">                   taskList.add(r);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> taskList;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Executes the given task sometime in the future.  The task</span></span><br><span class="line"><span class="comment">    * may execute in a new thread or in an existing pooled thread.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * If the task cannot be submitted for execution, either because this</span></span><br><span class="line"><span class="comment">    * executor has been shutdown or because its capacity has been reached,</span></span><br><span class="line"><span class="comment">    * the task is handled by the current &#123;<span class="doctag">@code</span> RejectedExecutionHandler&#125;.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> command the task to execute</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> RejectedExecutionException at discretion of</span></span><br><span class="line"><span class="comment">    *         &#123;<span class="doctag">@code</span> RejectedExecutionHandler&#125;, if the task</span></span><br><span class="line"><span class="comment">    *         cannot be accepted for execution</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> NullPointerException if &#123;<span class="doctag">@code</span> command&#125; is null</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>&#123;</span><br><span class="line">   	<span class="comment">// 参数校验</span></span><br><span class="line">       <span class="keyword">if</span> (command == <span class="keyword">null</span>)</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * Proceed in 3 steps:</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        *          </span></span><br><span class="line"><span class="comment">        * 1. 如果当前运行的线程数比corePoolSize少, 会尝试启动一个新的线程来执行当前任务。</span></span><br><span class="line"><span class="comment">        * 调用addWorker会检查runState 和 workerCount，通过返回 flase 来避免 添加不必要的核心线程</span></span><br><span class="line"><span class="comment">        </span></span><br><span class="line"><span class="comment">        2. 如果一个任务可以成功放入队列，我们仍然需要double-check 来决定是否需要添加一个线程。（因为自从上次checking存在的线程，可能已经死亡）或者进行这个方法时，线程池关闭了。所以，我们需要recheck state 来判断是否需要在stopped时 roll back,或者启动一个新的线程。  </span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * 3. 如果任务不能放入队列，我们会尝试启动一个新的线程。如果启动失败，我们会知道我们正在关闭或saturated，来拒绝这个任务</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">       <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class="line">       	<span class="comment">// worker数小于corePoolSize启动新的Worker</span></span><br><span class="line">           <span class="keyword">if</span> (addWorker(command, <span class="keyword">true</span>))</span><br><span class="line">               <span class="keyword">return</span>;<span class="comment">// 启动新的core线程处理任务成功，直接返回</span></span><br><span class="line">           c = ctl.get();</span><br><span class="line">       &#125;<span class="comment">//启动core线程失败，继续后续处理</span></span><br><span class="line">       </span><br><span class="line">       <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">       	<span class="comment">// 线程池正在运行，且成功添加到workQueue中</span></span><br><span class="line">           <span class="keyword">int</span> recheck = ctl.get();</span><br><span class="line">           <span class="keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))</span><br><span class="line">           	 <span class="comment">// recheck 当前状态不是运行，则移除并拒绝这个任务</span></span><br><span class="line">               reject(command);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</span><br><span class="line">           	<span class="comment">// 当前没有正在执行的Worker，则启动一个新Worker</span></span><br><span class="line">               addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="keyword">false</span>))</span><br><span class="line">       	<span class="comment">// 在队列放不下的情况下，启动新的Worker失败(线程数超过maxPoolSize)</span></span><br><span class="line">           reject(command);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * Methods for creating, running and cleaning up after workers</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Checks if a new worker can be added with respect to current</span></span><br><span class="line"><span class="comment">    * pool state and the given bound (either core or maximum). If so,</span></span><br><span class="line"><span class="comment">    * the worker count is adjusted accordingly, and, if possible, a</span></span><br><span class="line"><span class="comment">    * new worker is created and started, running firstTask as its</span></span><br><span class="line"><span class="comment">    * first task. This method returns false if the pool is stopped or</span></span><br><span class="line"><span class="comment">    * eligible to shut down. It also returns false if the thread</span></span><br><span class="line"><span class="comment">    * factory fails to create a thread when asked.  If the thread</span></span><br><span class="line"><span class="comment">    * creation fails, either due to the thread factory returning</span></span><br><span class="line"><span class="comment">    * null, or due to an exception (typically OutOfMemoryError in</span></span><br><span class="line"><span class="comment">    * Thread#start), we roll back cleanly.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> firstTask the task the new thread should run first (or</span></span><br><span class="line"><span class="comment">    * null if none). Workers are created with an initial first task</span></span><br><span class="line"><span class="comment">    * (in method execute()) to bypass queuing when there are fewer</span></span><br><span class="line"><span class="comment">    * than corePoolSize threads (in which case we always start one),</span></span><br><span class="line"><span class="comment">    * or when the queue is full (in which case we must bypass queue).</span></span><br><span class="line"><span class="comment">    * Initially idle threads are usually created via</span></span><br><span class="line"><span class="comment">    * prestartCoreThread or to replace other dying workers.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> core if true use corePoolSize as bound, else</span></span><br><span class="line"><span class="comment">    * maximumPoolSize. (A boolean indicator is used here rather than a</span></span><br><span class="line"><span class="comment">    * value to ensure reads of fresh values after checking other pool</span></span><br><span class="line"><span class="comment">    * state).</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> true if successful</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addWorker</span><span class="params">(Runnable firstTask, <span class="keyword">boolean</span> core)</span> </span>&#123;</span><br><span class="line">       retry:</span><br><span class="line">       <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">           <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">           <span class="keyword">int</span> rs = runStateOf(c);</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Check if queue empty only if necessary.</span></span><br><span class="line">           <span class="comment">// runState &gt;= SHUTDOWN </span></span><br><span class="line">           <span class="comment">// </span></span><br><span class="line">           <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp;</span><br><span class="line">               ! (rs == SHUTDOWN &amp;&amp;</span><br><span class="line">                  firstTask == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                  ! workQueue.isEmpty()))</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">               <span class="keyword">int</span> wc = workerCountOf(c);</span><br><span class="line">               <span class="keyword">if</span> (wc &gt;= CAPACITY ||</span><br><span class="line">                   wc &gt;= (core ? corePoolSize : maximumPoolSize))</span><br><span class="line">                   <span class="comment">// 在于线程池的容量返回</span></span><br><span class="line">                   <span class="comment">// 大于corePoolSize 或 maximumPoolSize 返回 </span></span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">               <span class="keyword">if</span> (compareAndIncrementWorkerCount(c))</span><br><span class="line">                   <span class="keyword">break</span> retry;</span><br><span class="line">                   </span><br><span class="line">               <span class="comment">// 再次检查运行状态</span></span><br><span class="line">               c = ctl.get();  <span class="comment">// Re-read ctl</span></span><br><span class="line">               <span class="keyword">if</span> (runStateOf(c) != rs)</span><br><span class="line">                   <span class="keyword">continue</span> retry;</span><br><span class="line">               <span class="comment">// else CAS failed due to workerCount change; retry inner loop</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">boolean</span> workerStarted = <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">boolean</span> workerAdded = <span class="keyword">false</span>;</span><br><span class="line">       Worker w = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">           w = <span class="keyword">new</span> Worker(firstTask);<span class="comment">//new一个新的Worker</span></span><br><span class="line">           <span class="keyword">final</span> Thread t = w.thread;</span><br><span class="line">           <span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</span><br><span class="line">               mainLock.lock();</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   <span class="comment">// Recheck while holding lock.</span></span><br><span class="line">                   <span class="comment">// Back out on ThreadFactory failure or if</span></span><br><span class="line">                   <span class="comment">// shut down before lock acquired.</span></span><br><span class="line">                   <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">                   <span class="keyword">int</span> rs = runStateOf(c);</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">if</span> (rs &lt; SHUTDOWN ||</span><br><span class="line">                       (rs == SHUTDOWN &amp;&amp; firstTask == <span class="keyword">null</span>)) &#123;</span><br><span class="line">                       <span class="keyword">if</span> (t.isAlive()) <span class="comment">// precheck that t is startable</span></span><br><span class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadStateException();</span><br><span class="line">                       workers.add(w);<span class="comment">// 添加到workers集合</span></span><br><span class="line">                       <span class="keyword">int</span> s = workers.size();</span><br><span class="line">                       <span class="keyword">if</span> (s &gt; largestPoolSize)<span class="comment">//记录线程最大时的线程数</span></span><br><span class="line">                           largestPoolSize = s;</span><br><span class="line">                       workerAdded = <span class="keyword">true</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                   mainLock.unlock();</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (workerAdded) &#123;</span><br><span class="line">                   t.start();<span class="comment">//启动Worker线程</span></span><br><span class="line">                   workerStarted = <span class="keyword">true</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">       	<span class="comment">// 添加失败，进行worker 清理工作</span></span><br><span class="line">           <span class="keyword">if</span> (! workerStarted)</span><br><span class="line">               addWorkerFailed(w);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> workerStarted;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Rolls back the worker thread creation.</span></span><br><span class="line"><span class="comment">    * - removes worker from workers, if present</span></span><br><span class="line"><span class="comment">    * - decrements worker count</span></span><br><span class="line"><span class="comment">    * - rechecks for termination, in case the existence of this</span></span><br><span class="line"><span class="comment">    *   worker was holding up termination</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addWorkerFailed</span><span class="params">(Worker w)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">       mainLock.lock();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (w != <span class="keyword">null</span>)</span><br><span class="line">               workers.remove(w);</span><br><span class="line">           decrementWorkerCount();</span><br><span class="line">           tryTerminate();</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           mainLock.unlock();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Performs cleanup and bookkeeping for a dying worker. Called</span></span><br><span class="line"><span class="comment">    * only from worker threads. Unless completedAbruptly is set,</span></span><br><span class="line"><span class="comment">    * assumes that workerCount has already been adjusted to account</span></span><br><span class="line"><span class="comment">    * for exit.  This method removes thread from worker set, and</span></span><br><span class="line"><span class="comment">    * possibly terminates the pool or replaces the worker if either</span></span><br><span class="line"><span class="comment">    * it exited due to user task exception or if fewer than</span></span><br><span class="line"><span class="comment">    * corePoolSize workers are running or queue is non-empty but</span></span><br><span class="line"><span class="comment">    * there are no workers.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> w the worker</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> completedAbruptly if the worker died due to user exception</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processWorkerExit</span><span class="params">(Worker w, <span class="keyword">boolean</span> completedAbruptly)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (completedAbruptly) <span class="comment">// If abrupt, then workerCount wasn't adjusted</span></span><br><span class="line">           decrementWorkerCount();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">       mainLock.lock();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           completedTaskCount += w.completedTasks;</span><br><span class="line">           workers.remove(w);</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           mainLock.unlock();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Worker退出时，尝试终止整个线程池</span></span><br><span class="line">       tryTerminate();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">       <span class="keyword">if</span> (runStateLessThan(c, STOP)) &#123;</span><br><span class="line">           <span class="keyword">if</span> (!completedAbruptly) &#123;</span><br><span class="line">               <span class="keyword">int</span> min = allowCoreThreadTimeOut ? <span class="number">0</span> : corePoolSize;</span><br><span class="line">               <span class="keyword">if</span> (min == <span class="number">0</span> &amp;&amp; ! workQueue.isEmpty())</span><br><span class="line">                   min = <span class="number">1</span>;</span><br><span class="line">               <span class="keyword">if</span> (workerCountOf(c) &gt;= min)</span><br><span class="line">                   <span class="keyword">return</span>; <span class="comment">// replacement not needed</span></span><br><span class="line">           &#125;</span><br><span class="line">           addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Performs blocking or timed wait for a task, depending on</span></span><br><span class="line"><span class="comment">    * current configuration settings, or returns null if this worker</span></span><br><span class="line"><span class="comment">    * must exit because of any of:</span></span><br><span class="line"><span class="comment">    * 1. There are more than maximumPoolSize workers (due to</span></span><br><span class="line"><span class="comment">    *    a call to setMaximumPoolSize).</span></span><br><span class="line"><span class="comment">    * 2. The pool is stopped.</span></span><br><span class="line"><span class="comment">    * 3. The pool is shutdown and the queue is empty.</span></span><br><span class="line"><span class="comment">    * 4. This worker timed out waiting for a task, and timed-out</span></span><br><span class="line"><span class="comment">    *    workers are subject to termination (that is,</span></span><br><span class="line"><span class="comment">    *    &#123;<span class="doctag">@code</span> allowCoreThreadTimeOut || workerCount &gt; corePoolSize&#125;)</span></span><br><span class="line"><span class="comment">    *    both before and after the timed wait.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> task, or null if the worker must exit, in which case</span></span><br><span class="line"><span class="comment">    *         workerCount is decremented</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> Runnable <span class="title">getTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">boolean</span> timedOut = <span class="keyword">false</span>; <span class="comment">// Did the last poll() time out?</span></span><br><span class="line"></span><br><span class="line">       retry:</span><br><span class="line">       <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">           <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">           <span class="keyword">int</span> rs = runStateOf(c);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 如果正在 SHUTDOWN 并且</span></span><br><span class="line">           <span class="comment">// Check if queue empty only if necessary.</span></span><br><span class="line">           <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123;</span><br><span class="line">               decrementWorkerCount();</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// workers 是否需要判断超时退出</span></span><br><span class="line">           <span class="keyword">boolean</span> timed;      <span class="comment">// Are workers subject to culling?</span></span><br><span class="line"></span><br><span class="line">           <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">           	 <span class="comment">// 判断当前线程数是否需要超时退出</span></span><br><span class="line">               <span class="keyword">int</span> wc = workerCountOf(c);</span><br><span class="line">               timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;</span><br><span class="line">				</span><br><span class="line">			 <span class="comment">// 当前线程不需要超时break</span></span><br><span class="line">               <span class="keyword">if</span> (wc &lt;= maximumPoolSize &amp;&amp; ! (timedOut &amp;&amp; timed))</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               </span><br><span class="line">               <span class="comment">// 递减WorkerCount计数，直接返回null    </span></span><br><span class="line">               <span class="keyword">if</span> (compareAndDecrementWorkerCount(c))</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">               c = ctl.get();  <span class="comment">// Re-read ctl</span></span><br><span class="line">               <span class="keyword">if</span> (runStateOf(c) != rs)</span><br><span class="line">                   <span class="keyword">continue</span> retry;</span><br><span class="line">               <span class="comment">// else CAS failed due to workerCount change; retry inner loop</span></span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               Runnable r = timed ?</span><br><span class="line">                   workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</span><br><span class="line">                   workQueue.take();</span><br><span class="line">               <span class="keyword">if</span> (r != <span class="keyword">null</span>)</span><br><span class="line">                   <span class="keyword">return</span> r;</span><br><span class="line">               timedOut = <span class="keyword">true</span>;</span><br><span class="line">           &#125; <span class="keyword">catch</span> (InterruptedException retry) &#123;</span><br><span class="line">               timedOut = <span class="keyword">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Main worker run loop.  Repeatedly gets tasks from queue and</span></span><br><span class="line"><span class="comment">    * executes them, while coping with a number of issues:</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * 1. We may start out with an initial task, in which case we</span></span><br><span class="line"><span class="comment">    * don't need to get the first one. Otherwise, as long as pool is</span></span><br><span class="line"><span class="comment">    * running, we get tasks from getTask. If it returns null then the</span></span><br><span class="line"><span class="comment">    * worker exits due to changed pool state or configuration</span></span><br><span class="line"><span class="comment">    * parameters.  Other exits result from exception throws in</span></span><br><span class="line"><span class="comment">    * external code, in which case completedAbruptly holds, which</span></span><br><span class="line"><span class="comment">    * usually leads processWorkerExit to replace this thread.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * 2. Before running any task, the lock is acquired to prevent</span></span><br><span class="line"><span class="comment">    * other pool interrupts while the task is executing, and</span></span><br><span class="line"><span class="comment">    * clearInterruptsForTaskRun called to ensure that unless pool is</span></span><br><span class="line"><span class="comment">    * stopping, this thread does not have its interrupt set.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * 3. Each task run is preceded by a call to beforeExecute, which</span></span><br><span class="line"><span class="comment">    * might throw an exception, in which case we cause thread to die</span></span><br><span class="line"><span class="comment">    * (breaking loop with completedAbruptly true) without processing</span></span><br><span class="line"><span class="comment">    * the task.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * 4. Assuming beforeExecute completes normally, we run the task,</span></span><br><span class="line"><span class="comment">    * gathering any of its thrown exceptions to send to</span></span><br><span class="line"><span class="comment">    * afterExecute. We separately handle RuntimeException, Error</span></span><br><span class="line"><span class="comment">    * (both of which the specs guarantee that we trap) and arbitrary</span></span><br><span class="line"><span class="comment">    * Throwables.  Because we cannot rethrow Throwables within</span></span><br><span class="line"><span class="comment">    * Runnable.run, we wrap them within Errors on the way out (to the</span></span><br><span class="line"><span class="comment">    * thread's UncaughtExceptionHandler).  Any thrown exception also</span></span><br><span class="line"><span class="comment">    * conservatively causes thread to die.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * 5. After task.run completes, we call afterExecute, which may</span></span><br><span class="line"><span class="comment">    * also throw an exception, which will also cause thread to</span></span><br><span class="line"><span class="comment">    * die. According to JLS Sec 14.20, this exception is the one that</span></span><br><span class="line"><span class="comment">    * will be in effect even if task.run throws.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * The net effect of the exception mechanics is that afterExecute</span></span><br><span class="line"><span class="comment">    * and the thread's UncaughtExceptionHandler have as accurate</span></span><br><span class="line"><span class="comment">    * information as we can provide about any problems encountered by</span></span><br><span class="line"><span class="comment">    * user code.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> w the worker</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">runWorker</span><span class="params">(Worker w)</span> </span>&#123;</span><br><span class="line">       Thread wt = Thread.currentThread();<span class="comment">// 获取当前Worker的执行线程</span></span><br><span class="line">       Runnable task = w.firstTask;</span><br><span class="line">       w.firstTask = <span class="keyword">null</span>;</span><br><span class="line">       w.unlock(); <span class="comment">// allow interrupts 允许被中断</span></span><br><span class="line">       <span class="keyword">boolean</span> completedAbruptly = <span class="keyword">true</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">       	<span class="comment">// 循环获取任务, getTask 为空时，结束循环，完成当前线程</span></span><br><span class="line">           <span class="keyword">while</span> (task != <span class="keyword">null</span> || (task = getTask()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">           	<span class="comment">// 执行任务时，获取独占锁</span></span><br><span class="line">               w.lock();</span><br><span class="line">               <span class="comment">// If pool is stopping, ensure thread is interrupted;</span></span><br><span class="line">               <span class="comment">// if not, ensure thread is not interrupted.  This</span></span><br><span class="line">               <span class="comment">// requires a recheck in second case to deal with</span></span><br><span class="line">               <span class="comment">// shutdownNow race while clearing interrupt</span></span><br><span class="line">               </span><br><span class="line">               <span class="comment">// 如果线程池正在停止，强制线程被中断</span></span><br><span class="line">               <span class="keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class="line">                    (Thread.interrupted() &amp;&amp;</span><br><span class="line">                     runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span><br><span class="line">                   !wt.isInterrupted())</span><br><span class="line">                   wt.interrupt();<span class="comment">//中断worker线程</span></span><br><span class="line">                   </span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   beforeExecute(wt, task);</span><br><span class="line">                   Throwable thrown = <span class="keyword">null</span>;</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       task.run();</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (RuntimeException x) &#123;</span><br><span class="line">                       thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (Error x) &#123;</span><br><span class="line">                       thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">                       thrown = x; <span class="keyword">throw</span> <span class="keyword">new</span> Error(x);</span><br><span class="line">                   &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                       afterExecute(task, thrown);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                   task = <span class="keyword">null</span>;</span><br><span class="line">                   w.completedTasks++;</span><br><span class="line">                   w.unlock();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           completedAbruptly = <span class="keyword">false</span>;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           processWorkerExit(w, completedAbruptly);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line"></span><br><span class="line"><span class="comment">//**************************** shutdown ***************************************</span></span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Initiates an orderly shutdown in which previously submitted</span></span><br><span class="line"><span class="comment">    * tasks are executed, but no new tasks will be accepted.</span></span><br><span class="line"><span class="comment">    * Invocation has no additional effect if already shut down.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;This method does not wait for previously submitted tasks to</span></span><br><span class="line"><span class="comment">    * complete execution.  Use &#123;<span class="doctag">@link</span> #awaitTermination awaitTermination&#125;</span></span><br><span class="line"><span class="comment">    * to do that.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> SecurityException &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">       mainLock.lock();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           checkShutdownAccess();</span><br><span class="line">           <span class="comment">// 设置运行状态为SHUTDOWN</span></span><br><span class="line">           advanceRunState(SHUTDOWN);</span><br><span class="line">           interruptIdleWorkers();<span class="comment">//中断所有线程</span></span><br><span class="line">           onShutdown(); <span class="comment">// hook for ScheduledThreadPoolExecutor</span></span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           mainLock.unlock();</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// shutdown后，尝试终止线程池</span></span><br><span class="line">       tryTerminate();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Attempts to stop all actively executing tasks, halts the</span></span><br><span class="line"><span class="comment">    * processing of waiting tasks, and returns a list of the tasks</span></span><br><span class="line"><span class="comment">    * that were awaiting execution. These tasks are drained (removed)</span></span><br><span class="line"><span class="comment">    * from the task queue upon return from this method.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;This method does not wait for actively executing tasks to</span></span><br><span class="line"><span class="comment">    * terminate.  Use &#123;<span class="doctag">@link</span> #awaitTermination awaitTermination&#125; to</span></span><br><span class="line"><span class="comment">    * do that.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;There are no guarantees beyond best-effort attempts to stop</span></span><br><span class="line"><span class="comment">    * processing actively executing tasks.  This implementation</span></span><br><span class="line"><span class="comment">    * cancels tasks via &#123;<span class="doctag">@link</span> Thread#interrupt&#125;, so any task that</span></span><br><span class="line"><span class="comment">    * fails to respond to interrupts may never terminate.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> SecurityException &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> List&lt;Runnable&gt; <span class="title">shutdownNow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       List&lt;Runnable&gt; tasks;</span><br><span class="line">       <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">       mainLock.lock();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           checkShutdownAccess();</span><br><span class="line">           advanceRunState(STOP);</span><br><span class="line">           interruptWorkers();</span><br><span class="line">           tasks = drainQueue();</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           mainLock.unlock();</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// shutdown后，尝试终止线程池</span></span><br><span class="line">       tryTerminate();</span><br><span class="line">       <span class="keyword">return</span> tasks;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isShutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> ! isRunning(ctl.get());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Returns true if this executor is in the process of terminating</span></span><br><span class="line"><span class="comment">    * after &#123;<span class="doctag">@link</span> #shutdown&#125; or &#123;<span class="doctag">@link</span> #shutdownNow&#125; but has not</span></span><br><span class="line"><span class="comment">    * completely terminated.  This method may be useful for</span></span><br><span class="line"><span class="comment">    * debugging. A return of &#123;<span class="doctag">@code</span> true&#125; reported a sufficient</span></span><br><span class="line"><span class="comment">    * period after shutdown may indicate that submitted tasks have</span></span><br><span class="line"><span class="comment">    * ignored or suppressed interruption, causing this executor not</span></span><br><span class="line"><span class="comment">    * to properly terminate.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> true if terminating but not yet terminated</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTerminating</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">       <span class="keyword">return</span> ! isRunning(c) &amp;&amp; runStateLessThan(c, TERMINATED);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTerminated</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> runStateAtLeast(ctl.get(), TERMINATED);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">awaitTermination</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="function">       <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">       <span class="keyword">long</span> nanos = unit.toNanos(timeout);</span><br><span class="line">       <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">       mainLock.lock();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">               <span class="keyword">if</span> (runStateAtLeast(ctl.get(), TERMINATED))</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">               <span class="keyword">if</span> (nanos &lt;= <span class="number">0</span>)</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">               <span class="comment">// 等待 termination</span></span><br><span class="line">               nanos = termination.awaitNanos(nanos);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           mainLock.unlock();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Invokes &#123;<span class="doctag">@code</span> shutdown&#125; when this executor is no longer</span></span><br><span class="line"><span class="comment">    * referenced and it has no threads.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       shutdown();</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line"><span class="comment">//******************************预启动线程 *************************</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Starts a core thread, causing it to idly wait for work. This</span></span><br><span class="line"><span class="comment">    * overrides the default policy of starting core threads only when</span></span><br><span class="line"><span class="comment">    * new tasks are executed. This method will return &#123;<span class="doctag">@code</span> false&#125;</span></span><br><span class="line"><span class="comment">    * if all core threads have already been started.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if a thread was started</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">prestartCoreThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> workerCountOf(ctl.get()) &lt; corePoolSize &amp;&amp;</span><br><span class="line">           addWorker(<span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Same as prestartCoreThread except arranges that at least one</span></span><br><span class="line"><span class="comment">    * thread is started even if corePoolSize is 0.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">ensurePrestart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> wc = workerCountOf(ctl.get());</span><br><span class="line">       <span class="keyword">if</span> (wc &lt; corePoolSize)</span><br><span class="line">           addWorker(<span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">       <span class="keyword">else</span> <span class="keyword">if</span> (wc == <span class="number">0</span>)</span><br><span class="line">           addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Starts all core threads, causing them to idly wait for work. This</span></span><br><span class="line"><span class="comment">    * overrides the default policy of starting core threads only when</span></span><br><span class="line"><span class="comment">    * new tasks are executed.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the number of threads started</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">prestartAllCoreThreads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> n = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">while</span> (addWorker(<span class="keyword">null</span>, <span class="keyword">true</span>))</span><br><span class="line">           ++n;</span><br><span class="line">       <span class="keyword">return</span> n;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Removes this task from the executor's internal queue if it is</span></span><br><span class="line"><span class="comment">    * present, thus causing it not to be run if it has not already</span></span><br><span class="line"><span class="comment">    * started.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;p&gt; This method may be useful as one part of a cancellation</span></span><br><span class="line"><span class="comment">    * scheme.  It may fail to remove tasks that have been converted</span></span><br><span class="line"><span class="comment">    * into other forms before being placed on the internal queue. For</span></span><br><span class="line"><span class="comment">    * example, a task entered using &#123;<span class="doctag">@code</span> submit&#125; might be</span></span><br><span class="line"><span class="comment">    * converted into a form that maintains &#123;<span class="doctag">@code</span> Future&#125; status.</span></span><br><span class="line"><span class="comment">    * However, in such cases, method &#123;<span class="doctag">@link</span> #purge&#125; may be used to</span></span><br><span class="line"><span class="comment">    * remove those Futures that have been cancelled.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> task the task to remove</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> true if the task was removed</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Runnable task)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">boolean</span> removed = workQueue.remove(task);</span><br><span class="line">       <span class="comment">// 在 SHUTDOWN 并且队列为空时，尝试终止 tryTerminate</span></span><br><span class="line">       tryTerminate(); <span class="comment">// In case SHUTDOWN and now empty</span></span><br><span class="line">       <span class="keyword">return</span> removed;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Tries to remove from the work queue all &#123;<span class="doctag">@link</span> Future&#125;</span></span><br><span class="line"><span class="comment">    * tasks that have been cancelled. This method can be useful as a</span></span><br><span class="line"><span class="comment">    * storage reclamation operation, that has no other impact on</span></span><br><span class="line"><span class="comment">    * functionality. Cancelled tasks are never executed, but may</span></span><br><span class="line"><span class="comment">    * accumulate in work queues until worker threads can actively</span></span><br><span class="line"><span class="comment">    * remove them. Invoking this method instead tries to remove them now.</span></span><br><span class="line"><span class="comment">    * However, this method may fail to remove tasks in</span></span><br><span class="line"><span class="comment">    * the presence of interference by other threads.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">purge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; q = workQueue;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           Iterator&lt;Runnable&gt; it = q.iterator();</span><br><span class="line">           <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">               Runnable r = it.next();</span><br><span class="line">               <span class="keyword">if</span> (r <span class="keyword">instanceof</span> Future&lt;?&gt; &amp;&amp; ((Future&lt;?&gt;)r).isCancelled())</span><br><span class="line">                   it.remove();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (ConcurrentModificationException fallThrough) &#123;</span><br><span class="line">           <span class="comment">// Take slow path if we encounter interference during traversal.</span></span><br><span class="line">           <span class="comment">// Make copy for traversal and call remove for cancelled entries.</span></span><br><span class="line">           <span class="comment">// The slow path is more likely to be O(N*N).</span></span><br><span class="line">           <span class="keyword">for</span> (Object r : q.toArray())</span><br><span class="line">               <span class="keyword">if</span> (r <span class="keyword">instanceof</span> Future&lt;?&gt; &amp;&amp; ((Future&lt;?&gt;)r).isCancelled())</span><br><span class="line">                   q.remove(r);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 在 SHUTDOWN 并且队列为空时，尝试终止 tryTerminate</span></span><br><span class="line">       tryTerminate(); <span class="comment">// In case SHUTDOWN and now empty</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h4 id="五、-ExecutorCompletionService"><a href="#五、-ExecutorCompletionService" class="headerlink" title="五、 ExecutorCompletionService"></a>五、 ExecutorCompletionService</h4><p>使用提供的 Executor 来执行任务的 CompletionService。此类将把 <b>提交任务完成时的结果</b> 放置 在可使用 take 访问的队列上。该类非常轻便，适合于在执行几组任务时临时使用。</p>
<p>(把执行任务完成的结果提交到一个队列中。)</p>

      
    </div>
    <footer class="article-footer2">
      <div id="footer-info" class="inner">
        <a href="http://www.618shoe.com/">莆田1:1精仿鞋微信号</a>
        <a href="http://www.618shoe.com/">莆田高仿鞋子的价格表</a>
        <a href="http://www.618shoe.com/">关于莆田仿鞋</a>
        <a href="http://www.618shoe.com/">莆田高仿鞋淘宝店店名</a>
        <a href="http://www.618shoe.com/">莆田精仿鞋官网</a>
         咨询QQ：<a title="点击这里给我发消息" href="http://wpa.qq.com/msgrd?v=3&amp;uin=2727291807&amp;site=www.cactussoft.cn&amp;menu=yes" target="_blank"><img src="http://wpa.qq.com/pa?p=2:2727291807:41"></a>
      </div>
        <div id="footer-info" class="inner">
          <a href="http://www.618shoe.com/">莆田高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">1：1高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">高仿鞋批发市场</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">高仿鞋网</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">广州高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">外贸尾单鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">精仿鞋专线</a>&nbsp;&nbsp;
      </div>
      <div id="footer-info" class="inner">
             <a href="http://www.618shoe.com/">莆田高仿鞋批发</a>&nbsp;&nbsp;
             公司网站:&nbsp;&nbsp;<a href="http://www.618shoe.com//" target="_blank">http://www.618shoe.com/</a>&nbsp;&nbsp;
             <a href="http://www.618shoe.com/">高仿鞋批发市场</a>
             微信 <img src="/pics/qrcode.jpg" style="width:100px;height:100px;">
      </div>
    </footer>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/01/15/threadpoolexecutor/" data-id="cja9q2ae00037nh5ishpk6vkp" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-nsq-internals" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/02/19/nsq-internals/" class="article-date">
  <time datetime="2014-02-19T07:46:00.000Z" itemprop="datePublished">2014-02-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/NSQ-golang/">NSQ golang</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/02/19/nsq-internals/">nsq internals</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>###NSQ Internals<br>NSQ内幕</p>
<p>NSQ is composed of 3 daemons:<br>NSQ 由3个守护进程组成：</p>
<ul>
<li><p>nsqd is the daemon that receives, queues, and delivers messages to clients.<br>nsqd是接收、队列和传送 消息到客户端的守护进程</p>
</li>
<li><p>nsqlookupd is the daemon that manages topology information and provides an eventually consistent discovery service.<br>nsqlookupd是管理的拓扑信息，并提供了最终一致发现服务的守护进程。</p>
</li>
<li><p>nsqadmin is a web UI to introspect the cluster in realtime (and perform various administrative tasks).<br>nsqadmin是一个Web UI来实时监控集群（和执行各种管理任务）。</p>
</li>
</ul>
<p>Data flow in NSQ is modeled as a tree of streams and consumers. A topic is a distinct stream of data. A channel is a logical grouping of consumers subscribed to a given topic.<br>在NSQ数据流建模为一个消息流和消费者的树。一个topic是一个独特的数据流。一个channel是消费者订阅了某个topic的逻辑分组。</p>
<p><img src="https://f.cloud.github.com/assets/187441/1700696/f1434dc8-6029-11e3-8a66-18ca4ea10aca.gif" alt="数据流图"></p>
<p>A single nsqd can have many topics and each topic can have many channels. A channel receives a copy of all the messages for the topic, enabling multicast style delivery while each message on a channel is distributed amongst its subscribers, enabling load-balancing.<br>单个nsqd可以有很多的topic，每个topic可以有多channel。一个channel接收到一个topic中所有消息的副本，启用组播方式的传输，使消息同时在每个channel的所有订阅用户间分发，从而实现负载平衡。</p>
<p>These primitives form a powerful framework for expressing a variety of . <a href="http://bitly.github.io/nsq/deployment/topology_patterns.html" target="_blank" rel="noopener">simple and complex topologies</a><br>这些原语组成一个强大的框架，用于表示各种<a href="http://bitly.github.io/nsq/deployment/topology_patterns.html" target="_blank" rel="noopener">简单和复杂的拓扑结构</a>。</p>
<p>For more information about the design of NSQ see the <a href="http://bitly.github.io/nsq/overview/design.html" target="_blank" rel="noopener">design doc</a>.<br>有关NSQ的设计的更多信息请参见<a href="http://bitly.github.io/nsq/overview/design.html" target="_blank" rel="noopener">设计文档</a>。</p>
<h4 id="topics-channels"><a href="#topics-channels" class="headerlink" title="topics/channels"></a>topics/channels</h4><p>Topics and channels, the core primitives of NSQ, best exemplify how the design of the system translates seamlessly to the features of Go.<br>topics和channels，NSQ的核心基础，最能说明如何把go语言的特点无缝地转化为系统设计。</p>
<p>Go’s channels (henceforth referred to as “go-chan” for disambiguation) are a natural way to express queues, thus an NSQ topic/channel, at its core, is just a buffered go-chan of Message pointers. The size of the buffer is equal to the –mem-queue-size configuration parameter.<br>Go语言中的channel（为消除歧义以下简称为“go-chan”）是实现队列一种自然的方式，因此一个NSQ topic/channel，其核心，只是一个缓冲的go-chan Message指针。缓冲区的大小等于 –mem-queue-size 的配置参数。</p>
<p>After reading data off the wire, the act of publishing a message to a topic involves:<br>在懂了读数据后，发布消息到一个topic的行为涉及到：  </p>
<ol>
<li>instantiation of a Message struct (and allocation of the message body []byte)  </li>
<li>read-lock to get the Topic  </li>
<li>read-lock to check for the ability to publish  </li>
<li>send on a buffered go-chan  </li>
</ol>
<p>To get messages from a topic to its channels the topic cannot rely on typical go-chan receive semantics, because multiple goroutines receiving on a go-chan would distribute the messages while the desired end result is to copy each message to every channel (goroutine).<br>从一个topic中的channel获取消息不能依赖于经典的 go-chan 语义，因为多个goroutines 在一个go-chan上接收消息将会分发消息，而最终要的结果是复制每个消息到每一个channel（goroutine）.</p>
<p>Instead, each topic maintains 3 primary goroutines. The first one, called router, is responsible for reading newly published messages off the incoming go-chan and storing them in a queue (memory or disk).<br>替代的是，每个topic维护着3个主要的goroutines。第一个被称为router,它负责用来从 incoming go-chan 读取最近发布的消息，并把消息保存到队列中（内存或硬盘）。  </p>
<p>The second one, called messagePump, is responsible for copying and pushing messages to channels as described above.<br>第二个，称为<strong>messagePump</strong>，是负责复制和推送消息到如上所述的channels。  </p>
<p>The third is responsible for DiskQueue IO and will be discussed later.<br>第三个是负责DiskQueue IO和将在后面讨论。  </p>
<p>Channels are a little more complicated but share the underlying goal of exposing a single input and single output go-chan (to abstract away the fact that, internally, messages might be in memory or on disk):<br>Channels是一个有点复杂，但共享着 go-chan 单一输入和输出（抽象出来的事实是，在内部，消息可能会在内存或磁盘上）：</p>
<p><img src="https://f.cloud.github.com/assets/187441/1698990/682fc358-5f76-11e3-9b05-3d5baba67f13.png" alt="queue goroutine"></p>
<p>Additionally, each channel maintains 2 time-ordered priority queues responsible for deferred and in-flight message timeouts (and 2 accompanying goroutines for monitoring them).<br>此外，每个channel的维护负责2个时间排序优先级队列，用来实现传输中（in-flight）消息超时（第2个随行goroutines用于监视它们）。</p>
<p>Parallelization is improved by managing a per-channel data structure, rather than relying on the Go runtime’s global timer scheduler.<br>并行化的提高是通过每个数据结构管理一个channel，而不是依靠Go 运行时的全局定时器调度。</p>
<p>Note: Internally, the Go runtime uses a single priority queue and goroutine to manage timers. This supports (but is not limited to) the entirety of the time package. It normally obviates the need for a user-land time-ordered priority queue but it’s important to keep in mind that it’s a single data structure with a single lock, potentially impacting GOMAXPROCS &gt; 1 performance. See runtime/time.goc.<br>注意：在内部，Go 运行时使用一个单一优先级队列和的goroutine来管理定时器。这支持（但不局限于）的整个time package。它通常避免了需要一个用户空间的时间顺序的优先级队列，但要意识到这是一个很重要的一个有着单一锁的数据结构，有可能影响GOMAXPROCS&gt; 1的表现。请参阅 <a href="http://golang.org/src/pkg/runtime/time.goc?s=1684:1787#L83" target="_blank" rel="noopener">runtime/time.goc</a>。</p>
<p>####Backend / DiskQueue</p>
<p>One of NSQ’s design goals is to bound the number of messages kept in memory. It does this by transparently writing message overflow to disk via DiskQueue (which owns the third primary goroutine for a topic or channel).<br>NSQ的设计目标之一就是要限定保持在内存中的消息数。它通过 DiskQueue 透明地将溢出的消息写入到磁盘上（对于一个topic或 channel 而言，DiskQueue 拥有的第三个主要的goroutine）。</p>
<p>Since the memory queue is just a go-chan, it’s trivial to route messages to memory first, if possible, then fallback to disk:<br>由于内存队列只是一个 go-chan，把消息放到内存中显得不重要，如果可能的话，则退回到磁盘：</p>
<pre><code>for msg := range c.incomingMsgChan {
    select {
    case c.memoryMsgChan &lt;- msg:
    default:
        err := WriteMessageToBackend(&amp;msgBuf, msg, c.backend)
        if err != nil {
            // ... handle errors ...
        }
    }
}
</code></pre><p>Taking advantage of Go’s select statement allows this functionality to be expressed in just a few lines of code: the default case above only executes if memoryMsgChan is full.<br>说到Go select 语句的优势在于用在短短的几行代码实现这个功能：default 语句只在memoryMsgChan已满的情况下执行。</p>
<p>NSQ also has the concept of ephemeral channels. Ephemeral channels discard message overflow (rather than write to disk) and disappear when they no longer have clients subscribed. This is a perfect use case for Go’s interfaces. Topics and channels have a struct member declared as a Backend interface rather than a concrete type. Normal topics and channels use a DiskQueue while ephemeral channels stub in a DummyBackendQueue, which implements a no-op Backend.<br>NSQ还具有的临时channel的概念。临时的channel将丢弃溢出的消息（而不是写入到磁盘），在没有客户端订阅时消失。这是一个完美的Go’s Interface 案例。topics 和 channel 有一个结构成员声明为一个 Backend interface，而不是一个具体的类型。正常的topic和channel使用DiskQueue，而临时channel stub in a DummyBackendQueue，它实现了一个no-op 的Backend。</p>
<h4 id="Reducing-GC-Pressure-降低GC的压力"><a href="#Reducing-GC-Pressure-降低GC的压力" class="headerlink" title="Reducing GC Pressure 降低GC的压力"></a>Reducing GC Pressure 降低GC的压力</h4><p>In any garbage collected environment you’re subject to the tension between throughput (doing useful work), latency (responsiveness), and resident set size (footprint).<br>在任何垃圾回收环境中，你可能会关注到吞吐量量（做无用功），延迟（响应），并驻留集大小（footprint）。</p>
<p>As of Go 1.2, the GC is mark-and-sweep (parallel), non-generational, non-compacting, stop-the-world and mostly precise . It’s mostly precise because the remainder of the work wasn’t completed in time (it’s slated for Go 1.3).<br>Go的1.2版本，GC采用，mark-and-sweep (parallel), non-generational, non-compacting, stop-the-world and mostly precise。这主要是因为剩余的工作未完成（它预定于Go 1.3 实现）。</p>
<p>The Go GC will certainly continue to improve, but the universal truth is: the less garbage you create the less time you’ll collect.<br>Go 的 GC一定会不断改进，但普遍的真理是：你创建的垃圾越少，收集的时间越少。</p>
<p>First, it’s important to understand how the GC is behaving under real workloads. To this end, nsqd publishes GC stats in statsd format (alongside other internal metrics). nsqadmin displays graphs of these metrics, giving you insight into the GC’s impact in both frequency and duration:<br>首先，重要的是要了解GC在真实的工作负载下是如何表现。为此，nsqd以statsd格式发布的GC统计（伴随着其他的内部指标）。nsqadmin显示这些度量的图表，让您洞察GC的影响，频率和持续时间：</p>
<p><img src="https://f.cloud.github.com/assets/187441/1699828/8df666c6-5fc8-11e3-95e6-360b07d3609d.png" alt="single node view"></p>
<p>In order to actually reduce garbage you need to know where it’s being generated. Once again the Go toolchain provides the answers:<br>为了切实减少垃圾，你需要知道它是如何生成的。再次Go toolchain 提供了答案：  </p>
<ol>
<li>Use the testing package and go test -benchmem to benchmark hot code paths. It profiles the number of allocations per iteration (and benchmark runs can be compared with benchcmp).<br>使用testing package 和 go test benchmem来 benchmark 热点代码路径。它分析每个迭代分配的内存数量（和benchmark 运行可以用 benchcmp 进行比较）。</li>
<li>Build using go build -gcflags -m, which outputs the result of escape analysis.<br>编译时使用 go build -gcflags -m , 会输出逃逸分析的结果。  </li>
</ol>
<p>With that in mind, the following optimizations proved useful for nsqd:<br>考虑到这一点，下面的优化证明对nsqd是有用的：  </p>
<ol>
<li>Avoid []byte to string conversions.<br>避免[]byte 到 string 的转换  </li>
<li>Re-use buffers or objects (and someday possibly sync.Pool aka <a href="https://code.google.com/p/go/issues/detail?id=4720" target="_blank" rel="noopener">issue 4720</a>).<br>buffers 或 object 的重新利用（并且某一天可能面临 ync.Pool 又名 <a href="https://code.google.com/p/go/issues/detail?id=4720" target="_blank" rel="noopener">issue 4720</a>）  </li>
<li>Pre-allocate slices (specify capacity in make) and always know the number and size of items over the wire.<br>预先分配 slices(在make时指定容量)并且总是知道其中承载元素的数量和大小  </li>
<li>Apply sane limits to various configurable dials (such as message size).<br>对各种配置项目使用一些明智的限制（例如消息大小）  </li>
<li>Avoid boxing (use of interface{}) or unnecessary wrapper types (like a struct for a “multiple value” go-chan).<br>避免装箱（使用 interface{}）或一些不必要的包装类型（例如一个 多值的”go-chan” 结构体）</li>
<li>Avoid the use of defer in hot code paths (it allocates).<br>避免在热点代码路径使用defer(它也消耗内存)  </li>
</ol>
<h4 id="TCP-Protocol"><a href="#TCP-Protocol" class="headerlink" title="TCP Protocol"></a>TCP Protocol</h4><p>The NSQ TCP protocol is a shining example of a section where these GC optimization concepts are utilized to great effect.<br>NSQ的TCP协议是一个这些GC优化概念发挥了很大作用的的辉榜样。</p>
<p>The protocol is structured with length prefixed frames, making it straightforward and performant to encode and decode:<br>该协议用含有长度前缀的帧构造，使其可以直接高效的编码和解码：</p>
<pre><code>[x][x][x][x][x][x][x][x][x][x][x][x]...
|  (int32) ||  (int32) || (binary)
|  4-byte  ||  4-byte  || N-byte
------------------------------------...
    size      frame ID     data
</code></pre><p>Since the exact type and size of a frame’s components are known ahead of time, we can avoid the encoding/binary package’s convenience Read() and Write() wrappers (and their extraneous interface lookups and conversions) and instead call the appropriate binary.BigEndian methods directly.<br>由于提前知道了帧部件的确切类型与大小，我们避免了 encodgin/binary 便利 Read() 和 Write() 包装（以及它们外部interface 的查询与转换），而是直接调用相应的 binary.BigEndian 方法。</p>
<p>To reduce socket IO syscalls, client net.Conn are wrapped with bufio.Reader and bufio.Writer. The Reader exposes ReadSlice(), which reuses its internal buffer. This nearly eliminates allocations while reading off the socket, greatly reducing GC pressure. This is possible because the data associated with most commands does not escape (in the edge cases where this is not true, the data is explicitly copied).<br>为了减少 socket 的IO系统调用，客户端 net.Conn 都用 bufio.Reader和bufio.Writer 包装。Reader 暴露了 ReadSlice（） ，它会重复使用其内部缓冲区。这几乎消除了从socket 读出数据的内存分配，大大降低GC的压力。这可能是因为与大多数命令关联的数据does not escape（在边缘情况下，这是不正确的，数据是显示复制的）。</p>
<p>At an even lower level, a MessageID is declared as <strong>[16]byte</strong> to be able to use it as a map key (slices cannot be used as map keys). However, since data read from the socket is stored as <strong>[]byte</strong>, rather than produce garbage by allocating string keys, and to avoid a copy from the slice to the backing array of the MessageID, the unsafe package is used to cast the slice directly to a MessageID:<br>在一个更低的水平，提供一个 <strong>MessageID</strong> 被声明为<strong>[16]byte</strong>，以便能够把它作为一个map key（slice不能被用作map key）。然而，由于从socket读取数据存储为<strong>[]byte</strong>，而不是通过分配字符串键产生垃圾，并避免从slice的副本拷贝的数组形式的MessageID，  unsafe package是用来直接把 slice 转换成一个MessageID：  </p>
<pre><code>id := *(*nsq.MessageID)(unsafe.Pointer(&amp;msgID))
</code></pre><p>Note: This is a hack. It wouldn’t be necessary if this was optimized by the compiler and Issue 3512 is open to potentially resolve this. It’s also worth reading through issue 5376, which talks about the possibility of a “const like” byte type that could be used interchangeably where string is accepted, without allocating and copying.<br>注： 这是一个hack。它将不是必要的，如果编译器优化 和 Issue 3512 解决这个问题。另外值得一读通过issue 5376，其中谈到的“const like” byte 类型 与 string 类型可以互换使用，而不需要分配和复制。</p>
<p>Similarly, the Go standard library only provides numeric conversion methods on a string. In order to avoid string allocations, nsqd uses a custom base 10 conversion method that operates directly on a <strong>[]byte</strong>.</p>
<p>同样，Go 标准库只提供了一个数字转换成string的方法。为了避免string分配，nsqd使用一个自定义的10进制转换方法在<strong>[]byte</strong>直接操作。</p>
<p>These may seem like micro-optimizations but the TCP protocol contains some of the hottest code paths. In aggregate, at the rate of tens of thousands of messages per second, they have a significant impact on the number of allocations and overhead:</p>
<p>这些看似微观优化，但却包含了TCP协议中一些最热门的代码路径。总体而言，每秒上万消息的速度，对分配和开销的数目显著影响：</p>
<pre><code>benchmark                    old ns/op    new ns/op    delta
BenchmarkProtocolV2Data           3575         1963  -45.09%

benchmark                    old ns/op    new ns/op    delta
BenchmarkProtocolV2Sub256        57964        14568  -74.87%
BenchmarkProtocolV2Sub512        58212        16193  -72.18%
BenchmarkProtocolV2Sub1k         58549        19490  -66.71%
BenchmarkProtocolV2Sub2k         63430        27840  -56.11%

benchmark                   old allocs   new allocs    delta
BenchmarkProtocolV2Sub256           56           39  -30.36%
BenchmarkProtocolV2Sub512           56           39  -30.36%
BenchmarkProtocolV2Sub1k            56           39  -30.36%
BenchmarkProtocolV2Sub2k            58           42  -27.59%
</code></pre><h4 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h4><p>NSQ’s HTTP API is built on top of Go’s net/http package. Because it’s just HTTP, it can be leveraged in almost any modern programming environment without special client libraries.<br>NSQ的HTTP API是建立在Go的 net/http 包之上。因为它只是 HTTP，它可以利用没有特殊的客户端库的几乎所有现代编程环境。</p>
<p>Its simplicity belies its power, as one of the most interesting aspects of Go’s HTTP tool-chest is the wide range of debugging capabilities it supports. The net/http/pprof package integrates directly with the native HTTP server, exposing endpoints to retrieve CPU, heap, goroutine, and OS thread profiles. These can be targeted directly from the go tool:<br>它的简单性掩盖了它的能力，作为Go的HTTP tool-chest最有趣的方面之一是广泛的调试功能支持。该 net/http/pprof 包直接集成了原生的HTTP服务器，暴露获取CPU，堆，goroutine和操作系统线程性能的endpoints。这些可以直接从 go tool 找到：</p>
<pre><code>$ go tool pprof http://127.0.0.1:4151/debug/pprof/profile
</code></pre><p>This is a tremendously valuable for debugging and profiling a running process!<br>这对调试和分析一个运行的进程非常有价值！</p>
<p>In addition, a /stats endpoint returns a slew of metrics in either JSON or pretty-printed text, making it easy for an administrator to introspect from the command line in realtime:<br>此外，/stats endpoint 返回的指标摆在任何JSON或良好格式的文本，很容易使管理员能够实时从命令行监控：</p>
<pre><code>$ watch -n 0.5 &apos;curl -s http://127.0.0.1:4151/stats | grep -v connected&apos;
</code></pre><p>This produces continuous output like:<br>这产生的连续输出如下：</p>
<p><code><br>    [page_views     ] depth: 0     be-depth: 0     msgs: 105525994 e2e%: 6.6s, 6.2s, 6.2s<br>        [page_view_counter        ] depth: 0     be-depth: 0     inflt: 432  def: 0    re-q: 34684 timeout: 34038 msgs: 105525994 e2e%: 5.1s, 5.1s, 4.6s<br>        [realtime_score           ] depth: 1828  be-depth: 0     inflt: 1368 def: 0    re-q: 25188 timeout: 11336 msgs: 105525994 e2e%: 9.0s, 9.0s, 7.8s<br>        [variants_writer          ] depth: 0     be-depth: 0     inflt: 592  def: 0    re-q: 37068 timeout: 37068 msgs: 105525994 e2e%: 8.2s, 8.2s, 8.2s</code></p>
<pre><code>[poll_requests  ] depth: 0     be-depth: 0     msgs: 11485060 e2e%: 167.5ms, 167.5ms, 138.1ms
    [social_data_collector    ] depth: 0     be-depth: 0     inflt: 2    def: 3    re-q: 7568  timeout: 402   msgs: 11485060 e2e%: 186.6ms, 186.6ms, 138.1ms

[social_data    ] depth: 0     be-depth: 0     msgs: 60145188 e2e%: 199.0s, 199.0s, 199.0s
    [events_writer            ] depth: 0     be-depth: 0     inflt: 226  def: 0    re-q: 32584 timeout: 30542 msgs: 60145188 e2e%: 6.7s, 6.7s, 6.7s
    [social_delta_counter     ] depth: 17328 be-depth: 7327  inflt: 179  def: 1    re-q: 155843 timeout: 11514 msgs: 60145188 e2e%: 234.1s, 234.1s, 231.8s

[time_on_site_ticks] depth: 0     be-depth: 0     msgs: 35717814 e2e%: 0.0ns, 0.0ns, 0.0ns
    [tail821042#ephemeral     ] depth: 0     be-depth: 0     inflt: 0    def: 0    re-q: 0     timeout: 0     msgs: 33909699 e2e%: 0.0ns, 0.0ns, 0.0ns
</code></pre><p></p>
<p>Finally, Go 1.2 brought measurable HTTP performance gains. It’s always nice when recompiling against the latest version of Go provides a free performance boost!<br>最后，Go 1.2带来可观的HTTP性能提升。与Go的最新版本重新编译时，它总是很高兴为您提供免费的性能提升！</p>
<p>####　Dependencies 依赖</p>
<p>Coming from other ecosystems, Go’s philosophy (or lack thereof) on managing dependencies takes a little time to get used to.<br>对于其它生态系统，Go 依赖关系管理（或缺乏）的哲学需要一点时间去适应。</p>
<p>NSQ evolved from being a single giant repo, with relative imports and little to no separation between internal packages, to fully embracing the recommended best practices with respect to structure and dependency management.<br>NSQ从一个单一的巨大仓库衍化而来的，包含相关的imports 和 小到未分离的内部 packages，完全遵守构建和依赖管理的最佳实践。</p>
<p>There are two main schools of thought:<br>有两大流派的思想：</p>
<ol>
<li>Vendoring: copy dependencies at the correct revision into your application’s repo and modify your import paths to reference the local copy.<br>Vendoring：拷贝正确版本的依赖到你的应用程序的仓库，并修改您的import 路径来引用本地副本。  </li>
<li>Virtual Env: list the revisions of dependencies you require and at build time, produce a pristine GOPATH environment containing those pinned dependencies.<br>Virtual Env：列出你在构建时所需要的依赖版本，产生一种原生的GOPATH环境变量包含这些固定依赖。<br>Note: This really only applies to binary packages as it doesn’t make sense for an importable package to make intermediate decisions as to which version of a dependency to use.<br>注：这确实只适用于二进制包，因为它没有任何意义的一个导入的包，使中间的决定，如一种依赖使用的版本。</li>
</ol>
<p>NSQ uses godep to provide support for (2) above.<br>NSQ 使用 godep 提供如上述2中的支持。</p>
<p>It works by recording your dependencies in a Godeps file, which it later uses to construct a GOPATH environment. To build, it wraps and executes the standard Go toolchain inside that environment. The Godeps file is just JSON and can be edited by hand.<br>它的工作原理是在Godeps文件记录你的依赖，方便日后构建GOPATH环境。为了编译，它在环境里包装并执行的标准Go toolchain。该Godeps文件仅仅是JSON格式，可以进行手工编辑。</p>
<p>It even supports go get like semantics. For example, to produce a reliable build of NSQ:<br>它甚至还支持像 go get 的语义。例如，用来产生可靠的NSQ构建：</p>
<pre><code>$ godep get github.com/bitly/nsq/...
</code></pre><h4 id="Testing"><a href="#Testing" class="headerlink" title="Testing"></a>Testing</h4><p>Go provides solid built-in support for writing tests and benchmarks and, because Go makes it so easy to model concurrent operations, it’s trivial to stand up a full-fledged instance of nsqd inside your test environment.<br>Go 提供了编写测试和基准测试的内建支持，这使用 Go 很容易并发操作进行建模，这是微不足道的站起来的一个完整的实例nsqd您的测试环境中。</p>
<p>However, there was one aspect of the initial implementation that became problematic for testing: global state. The most obvious offender was the use of a global variable that held the reference to the instance of nsqd at runtime, i.e. <code>var nsqd *NSQd</code>.<br>然而，最初实现有可能变成测试问题的一个方面：全局状态。最明显的offender 是运行时使用该持有nsqd 的引用实例的全局变量，例如 包含配置元数据 和 到parent nsqd的引用。</p>
<p>Certain tests would inadvertently mask this global variable in their local scope by using short-form variable assignment, i.e. nsqd := NewNSQd(…). This meant that the global reference did not point to the instance that was currently running, breaking tests.<br>某些测试会使用短形式的变量赋值，无意中在局部范围掩盖这个全局变量，即nsqd：= NewNSQd（…） 。这意味着，全局引用没有指向了当前正在运行的实例，破坏了测试实例。</p>
<p>To resolve this, a Context struct is passed around that contains configuration metadata and a reference to the parent nsqd. All references to global state were replaced with this local Context, allowing children (topics, channels, protocol handlers, etc.) to safely access this data and making it more reliable to test.<br>要解决这个问题，一个包含配置元数据 和 到parent nsqd的引用 上下文结构被传来传去。到全局状态的所有引用都替换为本地的语境，允许 children（topics，channels，协议处理程序等）来安全地访问这些数据，使之更可靠的测试。</p>
<h4 id="Robustness"><a href="#Robustness" class="headerlink" title="Robustness"></a>Robustness</h4><p>A system that isn’t robust in the face of changing network conditions or unexpected events is a system that will not perform well in a distributed production environment.<br>一个面对不断变化的网络条件或突发事件不健壮的系统，不会是一个在分布式生产环境中表现良好的系统。</p>
<p>NSQ is designed and implemented in a way that allows the system to tolerate failure and behave in a consistent, predictable, and unsurprising way.<br>NSQ设计和的方式是 使系统能够容忍故障而表现出一致的，可预测的和令人吃惊的方式来实现。</p>
<p>The overarching philosophy is to fail fast, treat errors as fatal, and provide a means to debug any issues that do occur.<br>总体理念是快速失败， treat errors as fatal，并提供了一种方式来调试发生的任何问题。</p>
<p>But, in order to react you need to be able to detect exceptional conditions<br>但是，为了应对，你需要能够检测异常情况</p>
<h4 id="Heartbeats-and-Timeouts"><a href="#Heartbeats-and-Timeouts" class="headerlink" title="Heartbeats and Timeouts"></a>Heartbeats and Timeouts</h4><p>The NSQ TCP protocol is push oriented. After connection, handshake, and subscription the consumer is placed in a RDY state of 0. When the consumer is ready to receive messages it updates that RDY state to the number of messages it is willing to accept. NSQ client libraries continually manage this behind the scenes, resulting in a flow-controlled stream of messages.<br>NSQ 的TCP协议是面向push的。在建立连接，握手，和订阅后，消费者被放置在一个为0的RDY状态。当消费者准备好接收消息，它更新的RDY状态到准备接收消息的数量。NSQ客户端库不断在幕后管理，消息控制流的结果。</p>
<p>Periodically, nsqd will send a heartbeat over the connection. The client can configure the interval between heartbeats but nsqd expects a response before it sends the next one.<br>每隔一段时间，nsqd将发送一个心跳线连接。客户端可以配置心跳之间的间隔，但nsqd会期待一个回应在它发送下一个心掉之前。</p>
<p>The combination of application level heartbeats and RDY state avoids head-of-line blocking, which can otherwise render heartbeats useless (i.e. if a consumer is behind in processing message flow the OS’s receive buffer will fill up, blocking heartbeats).<br>组合应用级别的心跳和RDY状态，避免头阻塞现象，也可能使心跳无用（即，如果消费者是在后面的处理消息流的接收缓冲区中的操作系统将被填满，堵心跳）。</p>
<p>To guarantee progress, all network IO is bound with deadlines relative to the configured heartbeat interval. This means that you can literally unplug the network connection between nsqd and a consumer and it will detect and properly handle the error.<br>为了保证进度，所有的网络IO时间上限势必与配置的心跳间隔相关联。这意味着，你可以从字面上拔掉之间的网络连接nsqd和消费者，它会检测并正确处理错误。</p>
<p>When a fatal error is detected the client connection is forcibly closed. In-flight messages are timed out and re-queued for delivery to another consumer. Finally, the error is logged and various internal metrics are incremented.<br>当检测到一个致命错误，客户端连接被强制关闭。在传输中的消息会超时而重新排队等待传递到另一个消费者。最后，错误会被记录并累计到各种内部指标。</p>
<h4 id="Managing-Goroutines-管理-Goroutines"><a href="#Managing-Goroutines-管理-Goroutines" class="headerlink" title="Managing Goroutines 管理 Goroutines"></a>Managing Goroutines 管理 Goroutines</h4><p>It’s surprisingly easy to start goroutines. Unfortunately, it isn’t quite as easy to orchestrate their cleanup. Avoiding deadlocks is also challenging. Most often this boils down to an ordering problem, where a goroutine receiving on a go-chan exits before the upstream goroutines sending on it.<br>非常容易启动 goroutine。不幸的是，不是很容易以协调他们的清理工作。避免死锁也极具挑战性。大多数情况下这可以归结为一个顺序的问题，在上游goroutine 发送消息到 go-chan 之前，另一个goroutine 从 go-chan 上接收消息。</p>
<p>Why care at all though? It’s simple, an orphaned goroutine is a memory leak. Memory leaks in long running daemons are bad, especially when the expectation is that your process will be stable when all else fails.<br>为什么要关心这些？这很显然，孤立的goroutine是内存泄漏。内存泄露在长期运行的守护进程中是相当糟糕的，尤其当期望的是你的进程能够稳定运行，但其它都失败了。</p>
<p>To further complicate things, a typical nsqd process has many goroutines involved in message delivery. Internally, message “ownership” changes often. To be able to shutdown cleanly, it’s incredibly important to account for all intraprocess messages.<br>更复杂的是，一个典型的nsqd进程中有许多参与消息传递 goroutines。在内部，消息的“所有权”频繁变化。为了能够完全关闭，统计全部进程内的消息是非常重要的。</p>
<p>Although there aren’t any magic bullets, the following techniques make it a little easier to manage<br>虽然目前还没有任何灵丹妙药，下列技术使它变得更轻松管理</p>
<h4 id="WaitGroups"><a href="#WaitGroups" class="headerlink" title="WaitGroups"></a>WaitGroups</h4><p>The sync package provides sync.WaitGroup, which can be used to perform accounting of how many goroutines are live (and provide a means to wait on their exit).<br>sync 包提供了 sync.WaitGroup, 可以被用来累计多少个 goroutine 是活跃的（并且意味着一直等待直到它们退出）。</p>
<p>To reduce the typical boilerplate, nsqd uses this wrapper:<br>为了减少经典样板，nsqd 使用以下装饰器：</p>
<pre><code>type WaitGroupWrapper struct {
    sync.WaitGroup
}

func (w *WaitGroupWrapper) Wrap(cb func()) {
    w.Add(1)
    go func() {
        cb()
        w.Done()
    }()
}

// can be used as follows:
wg := WaitGroupWrapper{}
wg.Wrap(func() { n.idPump() })
...
wg.Wait()
</code></pre><h4 id="Exit-Signaling-退出信号"><a href="#Exit-Signaling-退出信号" class="headerlink" title="Exit Signaling 退出信号"></a>Exit Signaling 退出信号</h4><p>The easiest way to trigger an event in multiple child goroutines is to provide a single go-chan that you close when ready. All pending receives on that go-chan will activate, rather than having to send a separate signal to each goroutine.<br>有一个简单的方式在多个child goroutine 中触发一个事件是 提供一个go-chane, 当你准备好时关闭它。所有在那个 go-chan 上挂起的go-chan 都将会被激活，而不是向每个goroutine中发送一个单独的信号。</p>
<pre><code>func work() {
    exitChan := make(chan int)
    go task1(exitChan)
    go task2(exitChan)
    time.Sleep(5 * time.Second)
    close(exitChan)
}
func task1(exitChan chan int) {
    &lt;-exitChan
    log.Printf(&quot;task1 exiting&quot;)
}

func task2(exitChan chan int) {
    &lt;-exitChan
    log.Printf(&quot;task2 exiting&quot;)
}
</code></pre><h4 id="Synchronizing-Exit-退出时的同步"><a href="#Synchronizing-Exit-退出时的同步" class="headerlink" title="Synchronizing Exit 退出时的同步"></a>Synchronizing Exit 退出时的同步</h4><p>It was quite difficult to implement a reliable, deadlock free, exit path that accounted for all in-flight messages. A few tips:<br>实现一个可靠的，无死锁的，所有传递中的消息的退出路径 是相当困难的。一些提示：</p>
<ol>
<li><p>Ideally the goroutine responsible for sending on a go-chan should also be responsible for closing it.<br>理想的情况是负责发送到go-chan的goroutine中也应负责关闭它。</p>
</li>
<li><p>If messages cannot be lost, ensure that pertinent go-chans are emptied (especially unbuffered ones!) to guarantee senders can make progress.<br>如果message不能丢失，确保相关的 go-chan 被清空（尤其是无缓冲的！），以保证发送者可以取得进展。</p>
</li>
<li><p>Alternatively, if a message is no longer relevant, sends on a single go-chan should be converted to a select with the addition of an exit signal (as discussed above) to guarantee progress.<br>另外，如果消息是不重要的，发送给一个单一的 go-chan 应转换为一个 select 附加一个退出信号（如上所述），以保证取得进展。</p>
</li>
<li><p>The general order should be:<br>一般的顺序应该是：</p>
<ol>
<li>Stop accepting new connections (close listeners)<br>停止接受新的连接（close listeners）  </li>
<li>Signal exit to child goroutines (see above)<br>发送退出信号给child goroutines(如上文)  </li>
<li>Wait on WaitGroup for goroutine exit (see above)<br>在 WaitGroup 等待 goroutine 退出（如上文）  </li>
<li>Recover buffered data<br>恢复缓冲数据  </li>
<li>Flush anything left to disk<br>刷新所有东西到硬盘</li>
</ol>
</li>
</ol>
<h5 id="Logging-日志"><a href="#Logging-日志" class="headerlink" title="Logging 日志"></a>Logging 日志</h5><p>Finally, the most important tool at your disposal is to log the entrance and exit of your goroutines!. It makes it infinitely easier to identify the culprit in the case of deadlocks or leaks.<br>最后，日志是您所获得的记录goroutine进入和退出的重要工具！。这使得它相当容易识别死锁或泄漏的情况的罪魁祸首。</p>
<p>nsqd log lines include information to correlate goroutines with their siblings (and parent), such as the client’s remote address or the topic/channel name.<br>nsqd日志行包括goroutine 与他们的siblings(and parent）的信息，如客户端的远程地址或 topic/channel name。</p>
<p>The logs are verbose, but not verbose to the point where the log is overwhelming. There’s a fine line, but nsqd leans towards the side of having more information in the logs when a fault occurs rather than trying to reduce chattiness at the expense of usefulness.<br>该日志是冗长的，但不是冗长的地步日志是压倒性的。有一条细线，但nsqd 倾向于发生故障时在日志中提供更多的信息，而不是试图减少繁琐的有效性为代价。</p>

      
    </div>
    <footer class="article-footer2">
      <div id="footer-info" class="inner">
        <a href="http://www.618shoe.com/">莆田1:1精仿鞋微信号</a>
        <a href="http://www.618shoe.com/">莆田高仿鞋子的价格表</a>
        <a href="http://www.618shoe.com/">关于莆田仿鞋</a>
        <a href="http://www.618shoe.com/">莆田高仿鞋淘宝店店名</a>
        <a href="http://www.618shoe.com/">莆田精仿鞋官网</a>
         咨询QQ：<a title="点击这里给我发消息" href="http://wpa.qq.com/msgrd?v=3&amp;uin=2727291807&amp;site=www.cactussoft.cn&amp;menu=yes" target="_blank"><img src="http://wpa.qq.com/pa?p=2:2727291807:41"></a>
      </div>
        <div id="footer-info" class="inner">
          <a href="http://www.618shoe.com/">莆田高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">1：1高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">高仿鞋批发市场</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">高仿鞋网</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">广州高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">外贸尾单鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">精仿鞋专线</a>&nbsp;&nbsp;
      </div>
      <div id="footer-info" class="inner">
             <a href="http://www.618shoe.com/">莆田高仿鞋批发</a>&nbsp;&nbsp;
             公司网站:&nbsp;&nbsp;<a href="http://www.618shoe.com//" target="_blank">http://www.618shoe.com/</a>&nbsp;&nbsp;
             <a href="http://www.618shoe.com/">高仿鞋批发市场</a>
             微信 <img src="/pics/qrcode.jpg" style="width:100px;height:100px;">
      </div>
    </footer>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2014/02/19/nsq-internals/" data-id="cja9q2adu0031nh5icpn7o7g9" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-nsq-design" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/02/18/nsq-design/" class="article-date">
  <time datetime="2014-02-18T15:44:00.000Z" itemprop="datePublished">2014-02-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/NSQ-golang/">NSQ golang</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/02/18/nsq-design/">nsq design</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>NSQ Design设计  </p>
<p>NSQ is a successor to <a href="https://github.com/bitly/simplehttp/tree/master/simplequeue" target="_blank" rel="noopener">simplequeue</a> (part of simplehttp[<a href="https://github.com/bitly/simplehttp" target="_blank" rel="noopener">https://github.com/bitly/simplehttp</a>]) and as such is designed to (in no particular order):<br>NSQ是继承于 simplequeue(部分的 simplehttp)，因此被设计为（排名不分先后）：</p>
<ul>
<li>provide easy topology solutions that enable high-availability and eliminate SPOFs<br>提供更简单的拓扑方案，达到高可性和消除单点故障  </li>
<li>address the need for stronger message delivery guarantees<br>满足更强的消息可靠传递的保证  </li>
<li>bound the memory footprint of a single process (by persisting some messages to disk)<br>限制单个进程的内存占用（通过持久化一些消息到硬盘上）  </li>
<li>greatly simplify configuration requirements for producers and consumers<br>极大简化了生产者和消费者的配置要求  </li>
<li>provide a straightforward upgrade path<br>提供了一个简单的升级路径  </li>
<li>improve efficiency<br>提升效率</li>
</ul>
<h4 id="Simplifying-Configuration-and-Administration-简化配置和管理"><a href="#Simplifying-Configuration-and-Administration-简化配置和管理" class="headerlink" title="Simplifying Configuration and Administration  简化配置和管理"></a>Simplifying Configuration and Administration  简化配置和管理</h4><p>A single nsqd instance is designed to handle multiple streams of data at once. Streams are called “topics” and a topic has 1 or more “channels”. Each channel receives a copy of all the messages for a topic. In practice, a channel maps to a downstream service consuming a topic.<br>单个 nsqd 实例被设计成可以同时处理多个数据流。流被称为“topics”和 topics有1个或多个“channel”。每个channel 都接收到一个topic 中所有消息的拷贝。在实践中，一个channel映射到下行服务消费一个topic。</p>
<p>Topics and channels are not configured a priori. Topics are created on first use by publishing to the named topic or by subscribing to a channel on the named topic. Channels are created on first use by subscribing to the named channel.<br>topic 和 channel 都没有预先配置。topic 由第一次发布消息到命名的topic 或第一次通过订阅一个命名topic来创建。channel 被第一次订阅到指定的channel创建。</p>
<p>Topics and channels all buffer data independently of each other, preventing a slow consumer from causing a backlog for other channels (the same applies at the topic level).<br>topic和channel的所有缓冲的数据相互独立，防止缓慢消费者造成对其他channel的积压（同样适用于topic级别）。</p>
<p>A channel can, and generally does, have multiple clients connected. Assuming all connected clients are in a state where they are ready to receive messages, each message will be delivered to a random client. For example:<br>一个channel就可以了，一般会有多个客户端连接。假设所有已连接的客户端处于准备接收消息的状态，每个消息将被传递到一个随机的客户端。例如：</p>
<p><img src="https://f.cloud.github.com/assets/187441/1700696/f1434dc8-6029-11e3-8a66-18ca4ea10aca.gif" alt="nsqd clients"></p>
<p>To summarize, messages are multicast from topic -&gt; channel (every channel receives a copy of all messages for that topic) but evenly distributed from channel -&gt; consumers (each consumer receives a portion of the messages for that channel).<br>总之，消息从topic-&gt;channel 是多播的（每个channel接收的所有该topic消息的副本），即使均匀分布在 topic-&gt;sonsumers 之间（每个消费者收到该channel的消息的一部分）。</p>
<p>NSQ also includes a helper application, nsqlookupd, which provides a directory service where consumers can lookup the addresses of nsqd instances that provide the topics they are interested in subscribing to. In terms of configuration, this decouples the consumers from the producers (they both individually only need to know where to contact common instances of nsqlookupd, never each other), reducing complexity and maintenance.<br>NSQ还包括一个辅助应用程序，nsqlookupd，它提供了一个目录服务，消费者可以查找到提供他们感兴趣订阅topic的 nsqd 地址 。在配置方面，把消费者与生产者解耦开（它们都分别只需要知道哪里去连接nsqlookupd的共同实例，而不是对方），降低复杂性和维护。</p>
<p>At a lower level each nsqd has a long-lived TCP connection to nsqlookupd over which it periodically pushes its state. This data is used to inform which nsqd addresses nsqlookupd will give to consumers. For consumers, an HTTP /lookup endpoint is exposed for polling.<br>在更底的层面，每个nsqd有一个与 nsqlookupd 的长期TCP连接，定期推动其状态。这个数据被nsqlookupd用于给消费者通知nsqd地址。对于消费者来说，一个暴露的 HTTP /lookup 接口用于轮询。</p>
<p>To introduce a new distinct consumer of a topic, simply start up an NSQ client configured with the addresses of your nsqlookupd instances. There are no configuration changes needed to add either new consumers or new publishers, greatly reducing overhead and complexity.<br>为topic 引入一个新的消费者，只需启动一个配置了 nsqlookup实例地址的NSQ 客户端。无需为添加任何新的消费者或生产者更改配置，大大降低了开销和复杂性。</p>
<p>NOTE: in future versions, the heuristic nsqlookupd uses to return addresses could be based on depth, number of connected clients, or other “intelligent” strategies. The current implementation is simply all. Ultimately, the goal is to ensure that all producers are being read from such that depth stays near zero.<br>注：在将来的版本中，启发式nsqlookupd可以基于深度，已连接的客户端数量，或其他“智能”策略来返回地址。当前的实现是简单的返回所有地址。最终的目标是要确保所有深度接近零的生产者被读取。</p>
<p>It is important to note that the nsqd and nsqlookupd daemons are designed to operate independently, without communication or coordination between siblings.<br>值得注意的是，重要的是nsqd和nsqlookupd守护进程被设计成独立运行，没有相互之间的沟通或协调。</p>
<p>We also think that it’s really important to have a way to view, introspect, and manage the cluster in aggregate. We built nsqadmin to do this. It provides a web UI to browse the hierarchy of topics/channels/consumers and inspect depth and other key statistics for each layer. Additionally it supports a few administrative commands such as removing and emptying a channel (which is a useful tool when messages in a channel can be safely thrown away in order to bring depth back to 0).<br>我们还认为重要的是有一个方式来聚合 查看，监测，并管理集群。我们建立nsqadmin做到这一点。它提供了一个Web UI来浏览topic/channels/consumers 和深度检查等每一层的关键统计数据。此外，它还支持几个管理命令例如 移除channel 和 清空channel（这是一个有用的工具，当在一个channel中的信息可以被安全地扔掉，以使深度返回到0）。</p>
<p><img src="http://media.tumblr.com/tumblr_mbmsd6YMfS1qj3yp2.png" alt="nsqadmin"></p>
<h4 id="Straightforward-Upgrade-Path-简单的升级路径"><a href="#Straightforward-Upgrade-Path-简单的升级路径" class="headerlink" title="Straightforward Upgrade Path 简单的升级路径"></a>Straightforward Upgrade Path 简单的升级路径</h4><p>This was one of our highest priorities. Our production systems handle a large volume of traffic, all built upon our existing messaging tools, so we needed a way to slowly and methodically upgrade specific parts of our infrastructure with little to no impact.<br>这是我们的高优先级之一。我们的生产系统处理大量的流量，都建立在我们现有的消息工具上，所以我们需要一种方法来慢慢地，有条不紊地升级我们特定部分的基础设施，而不产生任何影响。</p>
<p>First, on the message producer side we built nsqd to match simplequeue. Specifically, nsqd exposes an HTTP /put endpoint, just like simplequeue, to POST binary data (with the one caveat that the endpoint takes an additional query parameter specifying the “topic”). Services that wanted to switch to start publishing to nsqd only have to make minor code changes.<br>首先，在消息生产者方面，我们建立nsqd匹配simplequeue。具体来说，nsqd暴露了一个 HTTP /PUT 端点，就像simplequeue，上传二进制数据（需要注意的一点是 endpoint 需要一个额外的查询参数来指定”topic”）。想切换到发布消息到nsqd的服务只需要很少的代码变更。</p>
<p>Second, we built libraries in both Python and Go that matched the functionality and idioms we had been accustomed to in our existing libraries. This eased the transition on the message consumer side by limiting the code changes to bootstrapping. All business logic remained the same.<br>第二，我们建立了兼容已有库功能和语义的Python和Go库。这使得消息的消费者通过很少的代码改变来使用。所有的业务逻辑保持不变。</p>
<p>Finally, we built utilities to glue old and new components together. These are all available in the examples directory in the repository:<br>最后，我们建立工具连接起新旧组件。这些都在仓库的示例目录中：</p>
<pre><code>1. nsq_pubsub - expose a pubsub like HTTP interface to topics in an NSQ cluster  
nsq_pubsub -在NSQ集群中以HTTP接口的形式暴露的一个pubsub  
2. nsq_to_file - durably write all messages for a given topic to a file  
nsq_to_file -将一个给定topic的所有消息持久化到文件  
3. nsq_to_http - perform HTTP requests for all messages in a topic to (multiple) endpoints  
nsq_to_http -对一个topic的所有消息的执行HTTP请求到（多个）endpoints
</code></pre><h4 id="Eliminating-SPOFs"><a href="#Eliminating-SPOFs" class="headerlink" title="Eliminating SPOFs"></a>Eliminating SPOFs</h4><p>NSQ is designed to be used in a distributed fashion. nsqd clients are connected (over TCP) to all instances providing the specified topic. There are no middle-men, no message brokers, and no SPOFs:<br>NSQ被设计以分布的方式被使用。nsqd客户端（通过TCP）连接到指定topic的所有生产者实例。没有中间人，没有消息代理，也没有单点故障：</p>
<p><img src="http://media.tumblr.com/tumblr_mat85kr5td1qj3yp2.png" alt="nsq clients"></p>
<p>This topology eliminates the need to chain single, aggregated, feeds. Instead you consume directly from all producers. Technically, it doesn’t matter which client connects to which NSQ, as long as there are enough clients connected to all producers to satisfy the volume of messages, you’re guaranteed that all will eventually be processed.<br>这种拓扑结构消除单链，聚合，反馈。相反，你的消费者直接访问所有所有生产者。从技术上讲，哪个客户端连接到哪个NSQ产东重要，只要有足够的消费者连接到所有生产者，以满足大量的消息，你能被保证：所有最终将被处理。</p>
<p>For nsqlookupd, high availability is achieved by running multiple instances. They don’t communicate directly to each other and data is considered eventually consistent. Consumers poll all of their configured nsqlookupd instances and union the responses. Stale, inaccessible, or otherwise faulty nodes don’t grind the system to a halt.<br>对于nsqlookupd，高可用性是通过运行多个实例来实现。他们不直接相互通信和数据被认为是最终一致。消费者轮询所有的配置的nsqlookupd实例和合并response。失败的，无法访问的，或以其他方式故障的节点不会让系统陷于停顿。</p>
<h4 id="Message-Delivery-Guarantees-消息传递担保"><a href="#Message-Delivery-Guarantees-消息传递担保" class="headerlink" title="Message Delivery Guarantees 消息传递担保"></a>Message Delivery Guarantees 消息传递担保</h4><p>NSQ guarantees that a message will be delivered at least once, though duplicate messages are possible. Consumers should expect this and de-dupe or perform idempotent operations.<br>NSQ保证消息将交付至少一次，虽然重复的消息是可能的。消费者应该关注到这一点，删除重复数据或执行幂等操作。</p>
<p>This guarantee is enforced as part of the protocol and works as follows (assume the client has successfully connected and subscribed to a topic):<br>这个担保是作为协议和工作流的一部分，工作原理如下（假设客户端成功连接并订阅一个topic）：  </p>
<ol>
<li>client indicates they are ready to receive messages<br>客户表示他们已经准备好接收消息</li>
<li>NSQ sends a message and temporarily stores the data locally (in the event of re-queue or timeout)<br>NSQ发送一条消息，并暂时将数据存储在本地（在re-queue或timeout）</li>
<li>client replies FIN (finish) or REQ (re-queue) indicating success or failure respectively. If client does not reply NSQ will timeout after a configurable duration and automatically re-queue the message<br>客户端回复FIN（结束）或REQ（重新排队）分别指示成功或失败。如果客户端没有回复,NSQ会在设定的时间超时，自动重新排队消息</li>
</ol>
<p>This ensures that the only edge case that would result in message loss is an unclean shutdown of an nsqd process. In that case, any messages that were in memory (or any buffered writes not flushed to disk) would be lost.<br>这确保了消息丢失唯一可能的情况是不正常结nsqd进程。在这种情况下，这是在内存中的任何信息（或任何缓冲未刷新到磁盘）都将丢失。</p>
<p>If preventing message loss is of the utmost importance, even this edge case can be mitigated. One solution is to stand up redundant nsqd pairs (on separate hosts) that receive copies of the same portion of messages. Because you’ve written your consumers to be idempotent, doing double-time on these messages has no downstream impact and allows the system to endure any single node failure without losing messages.<br>如何防止消息丢失是最重要的，即使是这个意外情况可以得到缓解。一种解决方案是构成冗余nsqd对（在不同的主机上）接收消息的相同部分的副本。因为你实现的消费者是幂等的，以两倍时间处理这些消息不会对下游造成影响，并使得系统能够承受任何单一节点故障而不会丢失信息。</p>
<p>The takeaway is that NSQ provides the building blocks to support a variety of production use cases and configurable degrees of durability.<br>附加的是 NSQ 提供构建基础以支持多种生产用例和持久化的可配置性。</p>
<h4 id="Bounded-Memory-Footprint-限定内存占用"><a href="#Bounded-Memory-Footprint-限定内存占用" class="headerlink" title="Bounded Memory Footprint 限定内存占用"></a>Bounded Memory Footprint 限定内存占用</h4><p>nsqd provides a configuration option –mem-queue-size that will determine the number of messages that are kept in memory for a given queue. If the depth of a queue exceeds this threshold messages are transparently written to disk. This bounds the memory footprint of a given nsqd process to mem-queue-size <em> #_of_channels_and_topics:<br>nsqd提供一个 –mem-queue-size 配置选项，这将决定一个队列保存在内存中的消息数量。如果队列深度超过此阈值，消息将透明地写入磁盘。nsqd 进程的内存占用被限定于 mem-queue-size </em> #_of_channels_and_topics：  </p>
<p><img src="http://media.tumblr.com/tumblr_mavte17V3t1qj3yp2.png" alt="message overflow"></p>
<p>Also, an astute observer might have identified that this is a convenient way to gain an even higher guarantee of delivery by setting this value to something low (like 1 or even 0). The disk-backed queue is designed to survive unclean restarts (although messages might be delivered twice).<br>此外，一个精明的观察者可能会发现，这是一个方便的方式来获得更高的传递保证：把这个值设置的比较低（如1或甚至是0）。磁盘支持的队列被设计为在不重启的情况下存在（虽然消息可能被传递两次）。</p>
<p>Also, related to message delivery guarantees, clean shutdowns (by sending a nsqd process the TERM signal) safely persist the messages currently in memory, in-flight, deferred, and in various internal buffers.<br>此外，涉及到信息传递保证，干净关机（通过给nsqd进程发送TERM信号）坚持安全地把消息保存在内存中，传输中，延迟，以及内部的各种缓冲区。</p>
<p>Note, a channel whose name ends in the string #ephemeral will not be buffered to disk and will instead drop messages after passing the mem-queue-size. This enables consumers which do not need message guarantees to subscribe to a channel. These ephemeral channels will also not persist after its last client disconnects.<br>请注意，一个以 #ephemeral 结束的 channel 名称不会在超过 mem-queue-size之后刷新到硬盘。这使得消费者并不需要订阅频道的消息担保。这些临时channel 将在最后一个客户端断开连接后消失。</p>
<h4 id="Efficiency-效率"><a href="#Efficiency-效率" class="headerlink" title="Efficiency 效率"></a>Efficiency 效率</h4><p>NSQ was designed to communicate over a “memcached-like” command protocol with simple size-prefixed responses. All message data is kept in the core including metadata like number of attempts, timestamps, etc. This eliminates the copying of data back and forth from server to client, an inherent property of the previous toolchain when re-queueing a message. This also simplifies clients as they no longer need to be responsible for maintaining message state.<br>NSQ被设计成一个使用简单 size-prefixed 为前缀的，与“memcached-like”类似的命令协议。所有的消息数据被保持在核心中，包括像尝试次数、时间截等元数据类。这消除了数据从服务器到客户端来回拷贝，当重新排队消息时先前工具链的固有属性。这也简化了客户端，因为他们不再需要负责维护消息的状态。</p>
<p>Also, by reducing configuration complexity, setup and development time is greatly reduced (especially in cases where there are &gt;1 consumers of a topic).<br>此外，通过降低配置的复杂性，安装和开发的时间大大缩短（尤其是在有超过 &gt; 1 消费者的topic）。</p>
<p>For the data protocol, we made a key design decision that maximizes performance and throughput by pushing data to the client instead of waiting for it to pull. This concept, which we call RDY state, is essentially a form of client-side flow control.<br>对于数据的协议，我们做了一个重要的设计决策，通过推送数据到客户端最大限度地提高性能和吞吐量的，而不是等待客户端拉数据。这个概念，我们称之为RDY状态，基本上是客户端流量控制的一种形式。</p>
<p>When a client connects to nsqd and subscribes to a channel it is placed in a RDY state of 0. This means that no messages will be sent to the client. When a client is ready to receive messages it sends a command that updates its RDY state to some # it is prepared to handle, say 100. Without any additional commands, 100 messages will be pushed to the client as they are available (each time decrementing the server-side RDY count for that client).<br>当客户端连接到nsqd和并订阅到一个channel时，它被放置在一个RDY为0状态。这意味着，还没有信息被发送到客户端。当客户端已准备好接收消息发送，更新它的命令RDY状态到它准备处理的数量，比如100。无需任何额外的指令，当100条消息可用时，将被传递到客户端（服务器端为那个客户端每次递减RDY计数）。</p>
<p>Client libraries are designed to send a command to update RDY count when it reaches ~25% of the configurable max-in-flight setting (and properly account for connections to multiple nsqd instances, dividing appropriately).<br>客户端库的被设计成在RDY count 达到配置 max-in-flight 的25% 发送一个命令来更新RDY 计数（并适当考虑连接到多个nsqd情况下，适当地分配）。</p>
<p><img src="http://media.tumblr.com/tumblr_mataigNDn61qj3yp2.png" alt="nsq protocol"></p>
<p>This is a significant performance knob as some downstream systems are able to more-easily batch process messages and benefit greatly from a higher max-in-flight.<br>这是一个重要的性能控制，使一些下游系统能够更轻松地批量处理信息，并从更高的 max-in-flight 中受益。</p>
<p>Notably, because it is both buffered and push based with the ability to satisfy the need for independent copies of streams (channels), we’ve produced a daemon that behaves like simplequeue and pubsub combined . This is powerful in terms of simplifying the topology of our systems where we would have traditionally maintained the older toolchain discussed above.<br>值得注意的是，因为它既是基于缓冲和推来满足需要(channel)流的独立副本的能力，我们已经提供了 行为像simplequeue和 pubsub 相结合的守护进程。这是简化我们的系统拓扑结构的强大工具，如上述讨论那样我们会维护传统的toolchain。</p>
<h4 id="Go"><a href="#Go" class="headerlink" title="Go"></a>Go</h4><p>We made a strategic decision early on to build the NSQ core in Go. We recently blogged about our use of Go at bitly and alluded to this very project - it might be helpful to browse through that post to get an understanding of our thinking with respect to the language.<br>我们早早做了一个战略决策，利用Go来建立NSQ的核心。我们最近的博客上讲述我们在bitly如何使用Go，并提到这个适合的项目-通过浏览那篇文章可能对理解我们如何重视这么语言有所帮助。</p>
<p>Regarding NSQ, Go channels (not to be confused with NSQ channels) and the language’s built in concurrency features are a perfect fit for the internal workings of nsqd. We leverage buffered channels to manage our in memory message queues and seamlessly write overflow to disk.<br>关于NSQ，Go channels（不要与NSQ channel混淆），并且内置并发性功能的语言的非常适合于的nsqd的内部工作。我们充分利用缓冲的channel 来管理我们在内存中的消息队列和无缝r把溢出消息放到硬盘。</p>
<p>The standard library makes it easy to write the networking layer and client code. The built in memory and cpu profiling hooks highlight opportunities for optimization and require very little effort to integrate. We also found it really easy to test components in isolation, mock types using interfaces, and iteratively build functionality.<br>标准库使得很容易地编写网络层和客户端代码。只需要付出很少的努力，来整合内置的内存和CPU剖析进行优化。我们还发现它易于单独测试组件，模拟类型接口，以迭代方式构建功能。</p>

      
    </div>
    <footer class="article-footer2">
      <div id="footer-info" class="inner">
        <a href="http://www.618shoe.com/">莆田1:1精仿鞋微信号</a>
        <a href="http://www.618shoe.com/">莆田高仿鞋子的价格表</a>
        <a href="http://www.618shoe.com/">关于莆田仿鞋</a>
        <a href="http://www.618shoe.com/">莆田高仿鞋淘宝店店名</a>
        <a href="http://www.618shoe.com/">莆田精仿鞋官网</a>
         咨询QQ：<a title="点击这里给我发消息" href="http://wpa.qq.com/msgrd?v=3&amp;uin=2727291807&amp;site=www.cactussoft.cn&amp;menu=yes" target="_blank"><img src="http://wpa.qq.com/pa?p=2:2727291807:41"></a>
      </div>
        <div id="footer-info" class="inner">
          <a href="http://www.618shoe.com/">莆田高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">1：1高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">高仿鞋批发市场</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">高仿鞋网</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">广州高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">外贸尾单鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">精仿鞋专线</a>&nbsp;&nbsp;
      </div>
      <div id="footer-info" class="inner">
             <a href="http://www.618shoe.com/">莆田高仿鞋批发</a>&nbsp;&nbsp;
             公司网站:&nbsp;&nbsp;<a href="http://www.618shoe.com//" target="_blank">http://www.618shoe.com/</a>&nbsp;&nbsp;
             <a href="http://www.618shoe.com/">高仿鞋批发市场</a>
             微信 <img src="/pics/qrcode.jpg" style="width:100px;height:100px;">
      </div>
    </footer>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2014/02/18/nsq-design/" data-id="cja9q2adq002znh5ig66frdco" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-nsq-introduction" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/02/17/nsq-introduction/" class="article-date">
  <time datetime="2014-02-17T14:24:00.000Z" itemprop="datePublished">2014-02-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/NSQ-golang/">NSQ golang</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/02/17/nsq-introduction/">nsq introduction</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>NSQ</p>
<p>a realtime distributed messaging platform<br>一个实时的分布式消息平台</p>
<p>####Introduction 介绍<br>NSQ is a realtime distributed messaging platform designed to operate at bitly’s scale, handling billions of messages per day (current peak of 90k+ messages per second).<br>NSQ是一个实时的分布式消息平台，被设计用来承载 bitly 处理每天数十亿的消息（每秒90k+的峰值）。</p>
<p>It promotes distributed and decentralized topologies without single points of failure, enabling fault tolerance and high availability coupled with a reliable message delivery guarantee. See features &amp; guarantees.<br>它提升了分布式和分散式拓扑结构，避免了单点故障。通过容错性和高可用性来保障消息的传达。请参阅特性和保证。</p>
<p>Operationally, NSQ is easy to configure and deploy (all parameters are specified on the command line and compiled binaries have no runtime dependencies). For maximum flexibility, it is agnostic to data format (messages can be JSON, MsgPack, Protocol Buffers, or anything else). Official Go and Python libraries are available out of the box and, if you’re interested in building your own client, there’s a protocol spec (see client libraries).<br>使用上，NSQ易于配置和部署（所有参数都指定在命令行和编译的二进制文件没有运行时依赖）。为了获得最大的灵活性，它是不可知的数据格式（消息可以是JSON，MsgPack，Protocol Buffers，或其他任何东西）。官方的go和Python库可开箱即用，如果你有兴趣建立自己的客户端，这里有一个协议规范（参见客户端库）。</p>
<p>####Features &amp; Guarantees  特性与保证</p>
<p>Features特性    </p>
<ul>
<li>support distributed topologies with no SPOF<br>支持分布式拓扑，没有单点故障  </li>
<li>horizontally scalable (no brokers, seamlessly add more nodes to the cluster)<br>横向拓展（没有brokers, 无缝地往集群里添加更多节点）  </li>
<li>low-latency push based message delivery (performance)<br>基于推送的低延迟消息传递（性能）  </li>
<li>combination load-balanced and multicast style message routing<br>结合负载平衡和组播方式的消息路由  </li>
<li>excel at both streaming (high-throughput) and job oriented (low-throughput) workloads<br>同时擅长于流（高流量）与工作导向（低流量）工作负载  </li>
<li>primarily in-memory (beyond a high-water mark messages are transparently kept on disk)<br>主要是在内存中（超过上限的消息将被透明地保存在磁盘上）  </li>
<li>runtime discovery service for consumers to find producers (nsqlookupd)<br>运行发现服务，为消费者找到生产者（nsqlookupd）  </li>
<li>transport layer security (TLS)<br>传输层安全协议（TLS）  </li>
<li>data format agnostic<br>数据格式无关  </li>
<li>few dependencies (easy to deploy) and a sane, bounded, default configuration<br>没有依赖（易于部署），附有一个健全的，限定的默认配置  </li>
<li>simple TCP protocol supporting client libraries in any language<br>支持任何语言客户端库的简单TCP协议  </li>
<li>HTTP interface for stats, admin actions, and producers (no client library needed to publish)<br>HTTP接口进行统计，管理操作和生产（无需客户端库发布）  </li>
<li>integrates with statsd for realtime instrumentation<br>集成了statsd用于实时监控  </li>
<li>robust cluster administration interface (nsqadmin)<br>强大的集群管理界面（nsqadmin）  </li>
</ul>
<p>####Guarantees保证</p>
<p>As with any distributed system, achieving your goal is a matter of making intelligent tradeoffs. By being transparent about the reality of these tradeoffs we hope to set expectations about how NSQ will behave when deployed in production.<br>正如任何分布式系统，你的目标是实现智能权衡。透过高透明度有关这些权衡，我们希望设置NSQ在生产环境部署的的预期行为。</p>
<p>messages are not durable (by default)<br>默认情况下消息不进行持久化。</p>
<p>Although the system supports a “release valve” (–mem-queue-size) after which messages will be transparently kept on disk, it is primarily an in-memory messaging platform.<br>虽然该系统支持超过“阈值”（–mem-queue-size）的值之后，信息将被透明地保存在磁盘上，但它主要是一个内存中的消息传递平台。</p>
<p>–mem-queue-size can be set to 0 to to ensure that all incoming messages are persisted to disk. In this case, if a node failed, you are susceptible to a reduced failure surface (i.e. did the OS or underlying IO subsystem fail).<br>–mem-queue-size值可以设置为0，以确保所有传入的消息被保存到磁盘上。在这种情况下，如果一个节点失败，则很容易减小遭受的损失（即没操作系统或底层IO子系统失败）。</p>
<p>There is no built in replication. However, there are a variety of ways this tradeoff is managed such as deployment topology and techniques which actively slave and persist topics to disk in a fault-tolerant fashion.<br>没有内置的复制。但是，也有各种折衷的管理方式，诸如配置从节点，并把topics持久化到硬盘上的部署与拓扑方式。</p>
<p>messages are delivered at least once<br>消息至少传递一次  </p>
<p>Closely related to above, this assumes that the given nsqd node does not fail.<br>与上述密切相关的是，这里假设给定nsqd节点不会失败。</p>
<p>This means, for a variety of reasons, messages can be delivered multiple times (client timeouts, disconnections, requeues, etc.). It is the client’s responsibility to perform idempotent operations or de-dupe.<br>这意味着，由于各种原因，消息可能会被传送多次（客户端超时，断线，对其重新排队，等等）。客户端承担起履行幂等操作或重复数据删除的责任。</p>
<p>messages received are un-ordered<br>消息的接收是无序的  </p>
<p>You cannot rely on the order of messages being delivered to consumers.<br>你不能依赖于消息传递到消费者的顺序。  </p>
<p>Similar to message delivery semantics, this is the result of requeues, the combination of in-memory and on disk storage, and the fact that each nsqd node shares nothing.<br>类似的消息传递语义，这是对其重新排队的结果，结合了内存和磁盘上的存储，每个nsqd节点间不共享任何内容。</p>
<p>It is relatively straightforward to achieve loose ordering (i.e. for a given consumer its messages are ordered but not across the cluster as a whole) by introducing a window of latency in your consumer to accept messages and order them before processing (although, in order to preserve this invariant one must drop messages falling outside that window).<br>这里有一个比较简单的实现松散的顺序（即对于一个给定的消费者它的消息是有序的，但不是以整个集群作为一个整体）通过引入一个延迟窗口，在您的消费者接受信息，并在处理之前排序（虽然，为了保持顺序不变必须抛弃在窗口之外的消息）。</p>
<p>consumers eventually find all topic producers<br>消费者最终会发现所有topic的生产者。  </p>
<p>The discovery service (nsqlookupd) is designed to be eventually consistent. nsqlookupd nodes do not coordinate to maintain state or answer queries.<br>发现服务（nsqlookupd）被设计为最终一致。nsqlookupd节点并不需要互相协调来保持状态或回复查询。</p>
<p>Network partitions do not affect availability in the sense that both sides of the partition can still answer queries. Deployment topology has the most significant effect of mitigating these types of issues.<br>网络分区不影响可用性，分区双方仍然可以回复查询。部署拓扑结构能在很大程度减轻这类问题。</p>
<p>###FAQ</p>
<p>####Deployment部署</p>
<p>What is the recommended topology for nsqd?<br>推荐的nsqd拓扑结构是什么样的？</p>
<p>We strongly recommend running an nsqd alongside any service(s) that produce messages.<br>我们强烈建议nsqd与任何产生消息的服务一起运行。  </p>
<p>nsqd is a relatively lightweight process with a bounded memory footprint, which makes it well suited to “playing nice with others”.<br>nsqd是一个占用有限内存的相对轻量级进程，这使得它非常适合于“playing nice with others”。</p>
<p>This pattern aids in structuring message flow as a consumption problem rather than a production one.<br>这种模式构建消息流有利于消费问题，而不是一个生产问题。</p>
<p>Another benefit is that it essentially forms an independent, sharded, silo of data for that topic on a given host.<br>另一个好处是，它本质上形成一个独立，分片，筒仓的数据对于一个给定主机上的topic。</p>
<p>NOTE: this isn’t an absolute requirement though, it’s just simpler (see question below).<br>注意：这不是一个绝对的要求，虽然，它只是简单的（见下面的问题）。</p>
<p>Why can’t nsqlookupd be used by producers to find where to publish to?<br>为什么不能nsqlookupd使用由生产者来找到在哪里发布到？</p>
<p>NSQ promotes a consumer-side discovery model that alleviates the upfront configuration burden of having to tell consumers where to find the topic(s) they need.<br>NSQ提供了消费者发现模型，降低了消息者找到所需 topic 之前的前期配置负担。  </p>
<p>However, it does not provide any means to solve the problem of where a service should publish to. This is a chicken and egg problem, the topic does not exist prior to the first publish.<br>然而，它不提供任何手段来解决一个服务应发布到哪的问题。这是一个鸡和蛋的问题，topic 不会在第一个发布之前存在。</p>
<p>By co-locating nsqd (see question above), you sidestep this problem entirely (your service simply publishes to the local nsqd) and allow NSQ’s runtime discovery system to work naturally.<br>通过协同定位nsqd（见上面的问题），你完全回避这个问题（您的服务只是发布到本地nsqd），并允许NSQ运行时发现系统自然工作。</p>
<p>I just want to use nsqd as a work queue on a single node, is that a suitable use case?<br>我只是想用nsqd作为单个节点的工作队列，是一个合适的用例？  </p>
<p>Yep, nsqd can run standalone just fine.<br>是的，独立运行nsqd就好了。</p>
<p>nsqlookupd is beneficial in larger distributed environments.<br>nsqlookupd 有利于在更大的分布式环境。</p>
<p>How many nsqlookupd should I run?<br>我需要启动多少个nsqlookupd？</p>
<p>Typically only a few depending on your cluster size, number of nsqd nodes and consumers, and your desired fault tolerance.<br>通常只要几个，取决于你集群大小，nsqd节点和消费者的数目，以及您需要的容错性。</p>
<p>3 or 5 works really well for deployments involving up to several hundred hosts and thousands of consumers.<br>3或5个就能够为部署上百的主机与数千的消费者工作很好。</p>
<p>nsqlookupd nodes do not require coordination to answer queries. The metadata in the cluster is eventually consistent.<br>nsqlookupd节点并没有需要协调来回答查询。集群中的元数据是最终一致。</p>
<p>####Publishing发布消息</p>
<p>Do I need a client library to publish messages?<br>是否需要一个客户端库发布消息？</p>
<p>NO! Just use the HTTP endpoints for publishing (/pub and /mpub). It’s simple, it’s easy, and it’s ubiquitous in almost any programming environment.</p>
<p>In fact, the overwhelming majority of NSQ deployments use HTTP to publish.<br>事实上，绝大多数NSQ部署使用HTTP进行发布。  </p>
<p>Why force a client to handle responses to the TCP protocol’s PUB and MPUB commands?<br>为什么要强制客户端处理响应TCP协议的PUB和MPUB命令？</p>
<p>We believe NSQ’s default mode of operation should prioritize safety and we wanted the protocol to be simple and consistent.<br>我们认为NSQ的默认模式应优先考虑安全性，我们希望协议是简单和一致。</p>
<p>When can a PUB or MPUB fail?<br>何时PUT 或 MPU 会失败？</p>
<ol>
<li>The topic name is not formatted correctly (to character/length restrictions). See the topic and channel name spec.<br>topic名称格式不正确（以字符/长度的限制）。请参阅topic和channel名称规范。  </li>
<li>The message is too large (this limit is exposed as a parameter to nsqd).<br>该消息是太大（这个限制是作为参数传递给nsqd）  </li>
<li>The topic is in the middle of being deleted.<br>主题是在被删除中。  </li>
<li>nsqd is in the middle of cleanly exiting.<br>nsqd正在退出中。  </li>
<li>Any client connection-related failures during the publish.<br>发布时任何客户端连接相关的故障。  </li>
</ol>
<p>(1) and (2) should be considered programming errors. (3) and (4) are rare and (5) is a natural part of any TCP based protocol.<br>（1）和（2）应当考虑的编程错误。（3）和（4）是罕见的，（5）是任何基于TCP协议的一个自然组成部分。  </p>
<p>How can I mitigate scenario (3) above?<br>我怎样才能减轻上述场景（3）？  </p>
<p>Deleting topics is a relatively infrequent operation. If you need to delete a topic, orchestrate the timing such that publishes eliciting topic creations will never be performed until a sufficient amount of time has elapsed since deletion.<br>删除topic是一个相对较少的操作。如果你需要删除一个主题，编排，使得publish引出话题的作品将永远，直到时间足够量的自删除已经过去执行的时机。</p>
<p>####Design and Theory设计与理念</p>
<p>How do you recommend naming topics and channels?<br>你推荐如何命令topics和channels?  </p>
<p>A topic name should describe the data in the stream.<br>一个 topic name 应该描述流里的数据。  </p>
<p>A channel name should describe the work performed by its consumers.<br>一个channel name 应该描述消费者执行的工作。</p>
<p>For example, good topic names are encodes, decodes, api_requests, page_views and good channel names are archive, analytics_increment, spam_analysis.</p>
<p>Are there any limitations to the number of topics and channels a single nsqd can support?<br>是否有单个nsqd结点上支持topics和channels的数量上限？</p>
<p>There are no built-in limits imposed. It is only limited by the memory and CPU of the host nsqd is running on (per-client CPU usage was greatly reduced in issue #236).<br>有没有内置强加的限制。它仅受限于运行nsqd 的主机内存和CPU（每客户端CPU占用率大大降低在问题＃236）。</p>
<p>How are new topics announced to the cluster?<br>如何新topic发布到集群？</p>
<p>The first PUB or SUB to a topic will create the topic on an nsqd. Topic metadata will then propagate to the configured nsqlookupd. Other readers will discover this topic by periodically querying the nsqlookupd.<br>在topic 上的第一个 PUB或SUB 将在nsqd上创建 topic。然后topic的元数据将传播到配置nsqlookupd。其它readers 将通过定期查询nsqlookupd发现这个topic。</p>
<p>Can NSQ do RPC?<br>NSQ可以用来做RPC？</p>
<p>Yes, it’s possible, but NSQ was not designed with this use case in mind.<br>是的，这是可以的，但NSQ最初并没有设计这个用例。</p>
<p>We intend to publish some docs on how this could be structured but in the meantime reach out if you’re interested.</p>

      
    </div>
    <footer class="article-footer2">
      <div id="footer-info" class="inner">
        <a href="http://www.618shoe.com/">莆田1:1精仿鞋微信号</a>
        <a href="http://www.618shoe.com/">莆田高仿鞋子的价格表</a>
        <a href="http://www.618shoe.com/">关于莆田仿鞋</a>
        <a href="http://www.618shoe.com/">莆田高仿鞋淘宝店店名</a>
        <a href="http://www.618shoe.com/">莆田精仿鞋官网</a>
         咨询QQ：<a title="点击这里给我发消息" href="http://wpa.qq.com/msgrd?v=3&amp;uin=2727291807&amp;site=www.cactussoft.cn&amp;menu=yes" target="_blank"><img src="http://wpa.qq.com/pa?p=2:2727291807:41"></a>
      </div>
        <div id="footer-info" class="inner">
          <a href="http://www.618shoe.com/">莆田高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">1：1高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">高仿鞋批发市场</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">高仿鞋网</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">广州高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">外贸尾单鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">精仿鞋专线</a>&nbsp;&nbsp;
      </div>
      <div id="footer-info" class="inner">
             <a href="http://www.618shoe.com/">莆田高仿鞋批发</a>&nbsp;&nbsp;
             公司网站:&nbsp;&nbsp;<a href="http://www.618shoe.com//" target="_blank">http://www.618shoe.com/</a>&nbsp;&nbsp;
             <a href="http://www.618shoe.com/">高仿鞋批发市场</a>
             微信 <img src="/pics/qrcode.jpg" style="width:100px;height:100px;">
      </div>
    </footer>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2014/02/17/nsq-introduction/" data-id="cja9q2adp002wnh5i1e52xsav" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-hacker-tools" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2013/08/29/hacker-tools/" class="article-date">
  <time datetime="2013-08-29T05:02:00.000Z" itemprop="datePublished">2013-08-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/DevTools/">DevTools</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/08/29/hacker-tools/">程序员的工具箱</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li>在线测试SQL的工具 <a href="http://sqlfiddle.com/" target="_blank" rel="noopener">http://sqlfiddle.com/</a></li>
<li>在线测试js的工具 <a href="http://jsfiddle.net/" target="_blank" rel="noopener">http://jsfiddle.net/</a></li>
</ul>

      
    </div>
    <footer class="article-footer2">
      <div id="footer-info" class="inner">
        <a href="http://www.618shoe.com/">莆田1:1精仿鞋微信号</a>
        <a href="http://www.618shoe.com/">莆田高仿鞋子的价格表</a>
        <a href="http://www.618shoe.com/">关于莆田仿鞋</a>
        <a href="http://www.618shoe.com/">莆田高仿鞋淘宝店店名</a>
        <a href="http://www.618shoe.com/">莆田精仿鞋官网</a>
         咨询QQ：<a title="点击这里给我发消息" href="http://wpa.qq.com/msgrd?v=3&amp;uin=2727291807&amp;site=www.cactussoft.cn&amp;menu=yes" target="_blank"><img src="http://wpa.qq.com/pa?p=2:2727291807:41"></a>
      </div>
        <div id="footer-info" class="inner">
          <a href="http://www.618shoe.com/">莆田高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">1：1高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">高仿鞋批发市场</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">高仿鞋网</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">广州高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">外贸尾单鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">精仿鞋专线</a>&nbsp;&nbsp;
      </div>
      <div id="footer-info" class="inner">
             <a href="http://www.618shoe.com/">莆田高仿鞋批发</a>&nbsp;&nbsp;
             公司网站:&nbsp;&nbsp;<a href="http://www.618shoe.com//" target="_blank">http://www.618shoe.com/</a>&nbsp;&nbsp;
             <a href="http://www.618shoe.com/">高仿鞋批发市场</a>
             微信 <img src="/pics/qrcode.jpg" style="width:100px;height:100px;">
      </div>
    </footer>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2013/08/29/hacker-tools/" data-id="cja9q2adn002tnh5inlo4entv" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-figure-out-how-logger-get-the-source-method-name" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2013/08/27/figure-out-how-logger-get-the-source-method-name/" class="article-date">
  <time datetime="2013-08-27T07:26:00.000Z" itemprop="datePublished">2013-08-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java/">Java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/08/27/figure-out-how-logger-get-the-source-method-name/">figure out how logger get the source method name</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight java"><figcaption><span>info in Logger</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> java.util.logging;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Logger</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">info</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Level.INFO.intValue() &lt; levelValue) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        log(Level.INFO, msg);</span><br><span class="line">  		&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Log a message, with no arguments.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * If the logger is currently enabled for the given message</span></span><br><span class="line"><span class="comment">     * level then the given message is forwarded to all the</span></span><br><span class="line"><span class="comment">     * registered output Handler objects.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>   level   One of the message level identifiers, e.g., SEVERE</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>   msg     The string message (or a key in the message catalog)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(Level level, String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (level.intValue() &lt; levelValue || levelValue == offValue) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        LogRecord lr = <span class="keyword">new</span> LogRecord(level, msg);</span><br><span class="line">        doLog(lr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>LogRecord</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">LogRecord</span><span class="params">(Level level, String msg)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// Make sure level isn't null, by calling random method.</span></span><br><span class="line">       level.getClass();</span><br><span class="line">       <span class="keyword">this</span>.level = level;</span><br><span class="line">       message = msg;</span><br><span class="line">       <span class="comment">// Assign a thread ID and a unique sequence number.</span></span><br><span class="line">       sequenceNumber = globalSequenceNumber.getAndIncrement();</span><br><span class="line">       threadID = defaultThreadID();</span><br><span class="line">       millis = System.currentTimeMillis();</span><br><span class="line">       needToInferCaller = <span class="keyword">true</span>;</span><br><span class="line">  	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getSourceClassName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (needToInferCaller) &#123;</span><br><span class="line">           inferCaller();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> sourceClassName;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里就是找出当前执行的类与方法的地方</span></span><br><span class="line">   <span class="comment">// Private method to infer the caller's class and method names</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">inferCaller</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       needToInferCaller = <span class="keyword">false</span>;</span><br><span class="line">       JavaLangAccess access = SharedSecrets.getJavaLangAccess();</span><br><span class="line">       Throwable throwable = <span class="keyword">new</span> Throwable();</span><br><span class="line">       <span class="keyword">int</span> depth = access.getStackTraceDepth(throwable);</span><br><span class="line"></span><br><span class="line">       String logClassName = <span class="string">"java.util.logging.Logger"</span>;</span><br><span class="line">       String plogClassName = <span class="string">"sun.util.logging.PlatformLogger"</span>;</span><br><span class="line">       <span class="keyword">boolean</span> lookingForLogger = <span class="keyword">true</span>;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> ix = <span class="number">0</span>; ix &lt; depth; ix++) &#123;</span><br><span class="line">           <span class="comment">// Calling getStackTraceElement directly prevents the VM</span></span><br><span class="line">           <span class="comment">// from paying the cost of building the entire stack frame.</span></span><br><span class="line">           StackTraceElement frame =</span><br><span class="line">               access.getStackTraceElement(throwable, ix);</span><br><span class="line">           String cname = frame.getClassName();</span><br><span class="line">           <span class="keyword">if</span> (lookingForLogger) &#123;</span><br><span class="line">			<span class="comment">// 跳过所有looger之前的栈帧</span></span><br><span class="line">               <span class="comment">// Skip all frames until we have found the first logger frame.</span></span><br><span class="line">               <span class="keyword">if</span> (cname.equals(logClassName) || cname.startsWith(plogClassName)) &#123;</span><br><span class="line">                   lookingForLogger = <span class="keyword">false</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (!cname.equals(logClassName) &amp;&amp; !cname.startsWith(plogClassName)) &#123;</span><br><span class="line">				<span class="comment">// 跳过反射调用</span></span><br><span class="line">                   <span class="comment">// skip reflection call</span></span><br><span class="line">                   <span class="keyword">if</span> (!cname.startsWith(<span class="string">"java.lang.reflect."</span>) &amp;&amp; !cname.startsWith(<span class="string">"sun.reflect."</span>)) &#123;</span><br><span class="line">                      <span class="comment">// We've found the relevant frame.</span></span><br><span class="line">                      setSourceClassName(cname);</span><br><span class="line">                      setSourceMethodName(frame.getMethodName());</span><br><span class="line">                      <span class="keyword">return</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// We haven't found a suitable frame, so just punt.  This is</span></span><br><span class="line">       <span class="comment">// OK as we are only committed to making a "best effort" here.</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer2">
      <div id="footer-info" class="inner">
        <a href="http://www.618shoe.com/">莆田1:1精仿鞋微信号</a>
        <a href="http://www.618shoe.com/">莆田高仿鞋子的价格表</a>
        <a href="http://www.618shoe.com/">关于莆田仿鞋</a>
        <a href="http://www.618shoe.com/">莆田高仿鞋淘宝店店名</a>
        <a href="http://www.618shoe.com/">莆田精仿鞋官网</a>
         咨询QQ：<a title="点击这里给我发消息" href="http://wpa.qq.com/msgrd?v=3&amp;uin=2727291807&amp;site=www.cactussoft.cn&amp;menu=yes" target="_blank"><img src="http://wpa.qq.com/pa?p=2:2727291807:41"></a>
      </div>
        <div id="footer-info" class="inner">
          <a href="http://www.618shoe.com/">莆田高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">1：1高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">高仿鞋批发市场</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">高仿鞋网</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">广州高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">外贸尾单鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">精仿鞋专线</a>&nbsp;&nbsp;
      </div>
      <div id="footer-info" class="inner">
             <a href="http://www.618shoe.com/">莆田高仿鞋批发</a>&nbsp;&nbsp;
             公司网站:&nbsp;&nbsp;<a href="http://www.618shoe.com//" target="_blank">http://www.618shoe.com/</a>&nbsp;&nbsp;
             <a href="http://www.618shoe.com/">高仿鞋批发市场</a>
             微信 <img src="/pics/qrcode.jpg" style="width:100px;height:100px;">
      </div>
    </footer>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2013/08/27/figure-out-how-logger-get-the-source-method-name/" data-id="cja9q2adj002nnh5i7iu6bjv7" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-selector-provider-spi" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2013/08/27/selector-provider-spi/" class="article-date">
  <time datetime="2013-08-27T03:51:00.000Z" itemprop="datePublished">2013-08-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java/">Java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/08/27/selector-provider-spi/">Selector Provider SPI</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Selector Provider SPI</p>
<figure class="highlight java"><figcaption><span>Opens a selector.</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Selector</span> <span class="keyword">implements</span> <span class="title">Closeable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initializes a new instance of this class.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">Selector</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Opens a selector.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; The new selector is created by invoking the &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment">     * java.nio.channels.spi.SelectorProvider#openSelector openSelector&#125; method</span></span><br><span class="line"><span class="comment">     * of the system-wide default &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment">     * java.nio.channels.spi.SelectorProvider&#125; object.  &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  A new selector</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span>  IOException</span></span><br><span class="line"><span class="comment">     *          If an I/O error occurs</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Selector <span class="title">open</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SelectorProvider.provider().openSelector();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>SelectorProvider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectorProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SelectorProvider provider = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initializes a new instance of this class.  &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span>  SecurityException</span></span><br><span class="line"><span class="comment">     *          If a security manager has been installed and it denies</span></span><br><span class="line"><span class="comment">     *          &#123;<span class="doctag">@link</span> RuntimePermission&#125;&lt;tt&gt;("selectorProvider")&lt;/tt&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">SelectorProvider</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SecurityManager sm = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (sm != <span class="keyword">null</span>)</span><br><span class="line">            sm.checkPermission(<span class="keyword">new</span> RuntimePermission(<span class="string">"selectorProvider"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">loadProviderFromProperty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String cn = System.getProperty(<span class="string">"java.nio.channels.spi.SelectorProvider"</span>);</span><br><span class="line">        <span class="keyword">if</span> (cn == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// 通过反射加载类，并创建类的实例</span></span><br><span class="line">            Class&lt;?&gt; c = Class.forName(cn, <span class="keyword">true</span>,</span><br><span class="line">                                       ClassLoader.getSystemClassLoader());</span><br><span class="line">            provider = (SelectorProvider)c.newInstance();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException x) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceConfigurationError(<span class="keyword">null</span>, x);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException x) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceConfigurationError(<span class="keyword">null</span>, x);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException x) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceConfigurationError(<span class="keyword">null</span>, x);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SecurityException x) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceConfigurationError(<span class="keyword">null</span>, x);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">loadProviderAsService</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 这里通过 ServiceLoader 加载 SelectorProvider</span></span><br><span class="line">        ServiceLoader&lt;SelectorProvider&gt; sl =</span><br><span class="line">            ServiceLoader.load(SelectorProvider.class,</span><br><span class="line">                               ClassLoader.getSystemClassLoader());</span><br><span class="line">        Iterator&lt;SelectorProvider&gt; i = sl.iterator();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// XXX 这里为什么要使用一个for 循环呢，底下不是只判断一次就可以了？</span></span><br><span class="line">		<span class="comment">// 并且实际上也只执行一次？？？</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!i.hasNext())</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                provider = i.next();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ServiceConfigurationError sce) &#123;</span><br><span class="line">                <span class="keyword">if</span> (sce.getCause() <span class="keyword">instanceof</span> SecurityException) &#123;</span><br><span class="line">                    <span class="comment">// Ignore the security exception, try the next provider</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> sce;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the system-wide default selector provider for this invocation of</span></span><br><span class="line"><span class="comment">     * the Java virtual machine.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; The first invocation of this method locates the default provider</span></span><br><span class="line"><span class="comment">     * object as follows: &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;ol&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *   &lt;li&gt;&lt;p&gt; If the system property</span></span><br><span class="line"><span class="comment">     *   &lt;tt&gt;java.nio.channels.spi.SelectorProvider&lt;/tt&gt; is defined then it is</span></span><br><span class="line"><span class="comment">     *   taken to be the fully-qualified name of a concrete provider class.</span></span><br><span class="line"><span class="comment">     *   The class is loaded and instantiated; if this process fails then an</span></span><br><span class="line"><span class="comment">     *   unspecified error is thrown.  &lt;/p&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *   &lt;li&gt;&lt;p&gt; If a provider class has been installed in a jar file that is</span></span><br><span class="line"><span class="comment">     *   visible to the system class loader, and that jar file contains a</span></span><br><span class="line"><span class="comment">     *   provider-configuration file named</span></span><br><span class="line"><span class="comment">     *   &lt;tt&gt;java.nio.channels.spi.SelectorProvider&lt;/tt&gt; in the resource</span></span><br><span class="line"><span class="comment">     *   directory &lt;tt&gt;META-INF/services&lt;/tt&gt;, then the first class name</span></span><br><span class="line"><span class="comment">     *   specified in that file is taken.  The class is loaded and</span></span><br><span class="line"><span class="comment">     *   instantiated; if this process fails then an unspecified error is</span></span><br><span class="line"><span class="comment">     *   thrown.  &lt;/p&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *   &lt;li&gt;&lt;p&gt; Finally, if no provider has been specified by any of the above</span></span><br><span class="line"><span class="comment">     *   means then the system-default provider class is instantiated and the</span></span><br><span class="line"><span class="comment">     *   result is returned.  &lt;/p&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;/ol&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; Subsequent invocations of this method return the provider that was</span></span><br><span class="line"><span class="comment">     * returned by the first invocation.  &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  The system-wide default selector provider</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SelectorProvider <span class="title">provider</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 同步锁</span></span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (provider != <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">return</span> provider;</span><br><span class="line">            <span class="keyword">return</span> AccessController.doPrivileged(</span><br><span class="line">                <span class="keyword">new</span> PrivilegedAction&lt;SelectorProvider&gt;() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> SelectorProvider <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">							<span class="comment">// 从系统属性配置中加载</span></span><br><span class="line">                            <span class="keyword">if</span> (loadProviderFromProperty())</span><br><span class="line">                                <span class="keyword">return</span> provider;</span><br><span class="line">							<span class="comment">// 以SPI的方式加载</span></span><br><span class="line">                            <span class="keyword">if</span> (loadProviderAsService())</span><br><span class="line">                                <span class="keyword">return</span> provider;</span><br><span class="line">							</span><br><span class="line">							<span class="comment">// 返回默认的SelectorProvider</span></span><br><span class="line">                            provider = sun.nio.ch.DefaultSelectorProvider.create();</span><br><span class="line">                            <span class="keyword">return</span> provider;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>ServiceLoader</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceLoader</span>&lt;<span class="title">S</span>&gt; <span class="keyword">implements</span> <span class="title">Iterable</span>&lt;<span class="title">S</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PREFIX = <span class="string">"META-INF/services/"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 服务接口的class</span></span><br><span class="line">    <span class="comment">// The class or interface representing the service being loaded</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;S&gt; service;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The class loader used to locate, load, and instantiate providers</span></span><br><span class="line">    <span class="keyword">private</span> ClassLoader loader;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 根据实例化的顺序缓存providers</span></span><br><span class="line">    <span class="comment">// Cached providers, in instantiation order</span></span><br><span class="line">    <span class="keyword">private</span> LinkedHashMap&lt;String,S&gt; providers = <span class="keyword">new</span> LinkedHashMap&lt;String,S&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The current lazy-lookup iterator</span></span><br><span class="line">    <span class="keyword">private</span> LazyIterator lookupIterator;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//  清除此加载器的服务者缓存，以重载所有服务者。</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Clear this loader's provider cache so that all providers will be</span></span><br><span class="line"><span class="comment">     * reloaded.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; After invoking this method, subsequent invocations of the &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment">     * #iterator() iterator&#125; method will lazily look up and instantiate</span></span><br><span class="line"><span class="comment">     * providers from scratch, just as is done by a newly-created loader.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; This method is intended for use in situations in which new providers</span></span><br><span class="line"><span class="comment">     * can be installed into a running Java virtual machine.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        providers.clear();<span class="comment">// 清除缓存</span></span><br><span class="line">        lookupIterator = <span class="keyword">new</span> LazyIterator(service, loader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 私有构造函数</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ServiceLoader</span><span class="params">(Class&lt;S&gt; svc, ClassLoader cl)</span> </span>&#123;</span><br><span class="line">        service = svc;</span><br><span class="line">        loader = cl;</span><br><span class="line">        reload();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 针对给定服务类型和类加载器创建新的服务加载器。</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new service loader for the given service type and class</span></span><br><span class="line"><span class="comment">     * loader.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  service</span></span><br><span class="line"><span class="comment">     *         The interface or abstract class representing the service</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  loader</span></span><br><span class="line"><span class="comment">     *         The class loader to be used to load provider-configuration files</span></span><br><span class="line"><span class="comment">     *         and provider classes, or &lt;tt&gt;null&lt;/tt&gt; if the system class</span></span><br><span class="line"><span class="comment">     *         loader (or, failing that, the bootstrap class loader) is to be</span></span><br><span class="line"><span class="comment">     *         used</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> A new service loader</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;S&gt; <span class="function">ServiceLoader&lt;S&gt; <span class="title">load</span><span class="params">(Class&lt;S&gt; service,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            ClassLoader loader)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServiceLoader&lt;S&gt;(service, loader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 针对给定服务类型创建新的服务加载器，使用当前线程的上下文类加载器。</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new service loader for the given service type, using the</span></span><br><span class="line"><span class="comment">     * current thread's &#123;<span class="doctag">@linkplain</span> java.lang.Thread#getContextClassLoader</span></span><br><span class="line"><span class="comment">     * context class loader&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; An invocation of this convenience method of the form</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;blockquote&gt;&lt;pre&gt;</span></span><br><span class="line"><span class="comment">     * ServiceLoader.load(&lt;i&gt;service&lt;/i&gt;)&lt;/pre&gt;&lt;/blockquote&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * is equivalent to</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;blockquote&gt;&lt;pre&gt;</span></span><br><span class="line"><span class="comment">     * ServiceLoader.load(&lt;i&gt;service&lt;/i&gt;,</span></span><br><span class="line"><span class="comment">     *                    Thread.currentThread().getContextClassLoader())&lt;/pre&gt;&lt;/blockquote&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  service</span></span><br><span class="line"><span class="comment">     *         The interface or abstract class representing the service</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> A new service loader</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;S&gt; <span class="function">ServiceLoader&lt;S&gt; <span class="title">load</span><span class="params">(Class&lt;S&gt; service)</span> </span>&#123;</span><br><span class="line">        ClassLoader cl = Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="keyword">return</span> ServiceLoader.load(service, cl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 针对给定服务类型创建新的服务加载器，使用扩展类加载器。</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new service loader for the given service type, using the</span></span><br><span class="line"><span class="comment">     * extension class loader.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; This convenience method simply locates the extension class loader,</span></span><br><span class="line"><span class="comment">     * call it &lt;tt&gt;&lt;i&gt;extClassLoader&lt;/i&gt;&lt;/tt&gt;, and then returns</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;blockquote&gt;&lt;pre&gt;</span></span><br><span class="line"><span class="comment">     * ServiceLoader.load(&lt;i&gt;service&lt;/i&gt;, &lt;i&gt;extClassLoader&lt;/i&gt;)&lt;/pre&gt;&lt;/blockquote&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; If the extension class loader cannot be found then the system class</span></span><br><span class="line"><span class="comment">     * loader is used; if there is no system class loader then the bootstrap</span></span><br><span class="line"><span class="comment">     * class loader is used.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; This method is intended for use when only installed providers are</span></span><br><span class="line"><span class="comment">     * desired.  The resulting service will only find and load providers that</span></span><br><span class="line"><span class="comment">     * have been installed into the current Java virtual machine; providers on</span></span><br><span class="line"><span class="comment">     * the application's class path will be ignored.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  service</span></span><br><span class="line"><span class="comment">     *         The interface or abstract class representing the service</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> A new service loader</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;S&gt; <span class="function">ServiceLoader&lt;S&gt; <span class="title">loadInstalled</span><span class="params">(Class&lt;S&gt; service)</span> </span>&#123;</span><br><span class="line">        ClassLoader cl = ClassLoader.getSystemClassLoader();</span><br><span class="line">        ClassLoader prev = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">while</span> (cl != <span class="keyword">null</span>) &#123;</span><br><span class="line">            prev = cl;</span><br><span class="line">            cl = cl.getParent();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ServiceLoader.load(service, prev);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>ServiceLoader--》LazyIterator</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">S</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">       Class&lt;S&gt; service;</span><br><span class="line">       ClassLoader loader;</span><br><span class="line">       Enumeration&lt;URL&gt; configs = <span class="keyword">null</span>;</span><br><span class="line">       Iterator&lt;String&gt; pending = <span class="keyword">null</span>;</span><br><span class="line">       String nextName = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">private</span> <span class="title">LazyIterator</span><span class="params">(Class&lt;S&gt; service, ClassLoader loader)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">this</span>.service = service;</span><br><span class="line">           <span class="keyword">this</span>.loader = loader;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">if</span> (nextName != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (configs == <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="comment">// 配置文件的完整文件名</span></span><br><span class="line">                   String fullName = PREFIX + service.getName();</span><br><span class="line">                   <span class="keyword">if</span> (loader == <span class="keyword">null</span>)</span><br><span class="line">                       configs = ClassLoader.getSystemResources(fullName);</span><br><span class="line">                   <span class="keyword">else</span></span><br><span class="line">                       configs = loader.getResources(fullName);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (IOException x) &#123;</span><br><span class="line">                   fail(service, <span class="string">"Error locating configuration files"</span>, x);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 解析文件</span></span><br><span class="line">           <span class="keyword">while</span> ((pending == <span class="keyword">null</span>) || !pending.hasNext()) &#123;</span><br><span class="line">               <span class="keyword">if</span> (!configs.hasMoreElements()) &#123;</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               pending = parse(service, configs.nextElement());</span><br><span class="line">           &#125;</span><br><span class="line">		<span class="comment">// 得到nextName</span></span><br><span class="line">           nextName = pending.next();</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> S <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">if</span> (!hasNext()) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">           &#125;</span><br><span class="line">           String cn = nextName;</span><br><span class="line">           nextName = <span class="keyword">null</span>;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// 加载相应的服务实现类</span></span><br><span class="line">               S p = service.cast(Class.forName(cn, <span class="keyword">true</span>, loader)</span><br><span class="line">                                  .newInstance());</span><br><span class="line">			<span class="comment">// 放入缓存中</span></span><br><span class="line">               providers.put(cn, p);</span><br><span class="line">               <span class="keyword">return</span> p;</span><br><span class="line">           &#125; <span class="keyword">catch</span> (ClassNotFoundException x) &#123;</span><br><span class="line">               fail(service,</span><br><span class="line">                    <span class="string">"Provider "</span> + cn + <span class="string">" not found"</span>);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">               fail(service,</span><br><span class="line">                    <span class="string">"Provider "</span> + cn + <span class="string">" could not be instantiated: "</span> + x,</span><br><span class="line">                    x);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> Error();          <span class="comment">// This cannot happen</span></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以延迟方式加载此加载器服务的可用提供者。</span></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Lazily loads the available providers of this loader's service.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;p&gt; The iterator returned by this method first yields all of the</span></span><br><span class="line"><span class="comment">    * elements of the provider cache, in instantiation order.  It then lazily</span></span><br><span class="line"><span class="comment">    * loads and instantiates any remaining providers, adding each one to the</span></span><br><span class="line"><span class="comment">    * cache in turn.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;p&gt; To achieve laziness the actual work of parsing the available</span></span><br><span class="line"><span class="comment">    * provider-configuration files and instantiating providers must be done by</span></span><br><span class="line"><span class="comment">    * the iterator itself.  Its &#123;<span class="doctag">@link</span> java.util.Iterator#hasNext hasNext&#125; and</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> java.util.Iterator#next next&#125; methods can therefore throw a</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> ServiceConfigurationError&#125; if a provider-configuration file</span></span><br><span class="line"><span class="comment">    * violates the specified format, or if it names a provider class that</span></span><br><span class="line"><span class="comment">    * cannot be found and instantiated, or if the result of instantiating the</span></span><br><span class="line"><span class="comment">    * class is not assignable to the service type, or if any other kind of</span></span><br><span class="line"><span class="comment">    * exception or error is thrown as the next provider is located and</span></span><br><span class="line"><span class="comment">    * instantiated.  To write robust code it is only necessary to catch &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment">    * ServiceConfigurationError&#125; when using a service iterator.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;p&gt; If such an error is thrown then subsequent invocations of the</span></span><br><span class="line"><span class="comment">    * iterator will make a best effort to locate and instantiate the next</span></span><br><span class="line"><span class="comment">    * available provider, but in general such recovery cannot be guaranteed.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;blockquote style="font-size: smaller; line-height: 1.2"&gt;&lt;span</span></span><br><span class="line"><span class="comment">    * style="padding-right: 1em; font-weight: bold"&gt;Design Note&lt;/span&gt;</span></span><br><span class="line"><span class="comment">    * Throwing an error in these cases may seem extreme.  The rationale for</span></span><br><span class="line"><span class="comment">    * this behavior is that a malformed provider-configuration file, like a</span></span><br><span class="line"><span class="comment">    * malformed class file, indicates a serious problem with the way the Java</span></span><br><span class="line"><span class="comment">    * virtual machine is configured or is being used.  As such it is</span></span><br><span class="line"><span class="comment">    * preferable to throw an error rather than try to recover or, even worse,</span></span><br><span class="line"><span class="comment">    * fail silently.&lt;/blockquote&gt;</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;p&gt; The iterator returned by this method does not support removal.</span></span><br><span class="line"><span class="comment">    * Invoking its &#123;<span class="doctag">@link</span> java.util.Iterator#remove() remove&#125; method will</span></span><br><span class="line"><span class="comment">    * cause an &#123;<span class="doctag">@link</span> UnsupportedOperationException&#125; to be thrown.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span>  An iterator that lazily loads providers for this loader's</span></span><br><span class="line"><span class="comment">    *          service</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Iterator&lt;S&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Iterator&lt;S&gt;() &#123;</span><br><span class="line"></span><br><span class="line">           Iterator&lt;Map.Entry&lt;String,S&gt;&gt; knownProviders</span><br><span class="line">               = providers.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               <span class="keyword">if</span> (knownProviders.hasNext())</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		    <span class="comment">// 在reload方法中， lookupIterator = new LazyIterator(service, loader);</span></span><br><span class="line"></span><br><span class="line">               <span class="keyword">return</span> lookupIterator.hasNext();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="function"><span class="keyword">public</span> S <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               <span class="keyword">if</span> (knownProviders.hasNext())</span><br><span class="line">                   <span class="keyword">return</span> knownProviders.next().getValue();</span><br><span class="line">               <span class="keyword">return</span> lookupIterator.next();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125;;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>解析SPI配置文件的方法</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Parse a single line from the given configuration file, adding the name</span></span><br><span class="line"><span class="comment">// on the line to the names list.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">parseLine</span><span class="params">(Class service, URL u, BufferedReader r, <span class="keyword">int</span> lc,</span></span></span><br><span class="line"><span class="function"><span class="params">                      List&lt;String&gt; names)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException, ServiceConfigurationError</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    String ln = r.readLine();</span><br><span class="line">    <span class="keyword">if</span> (ln == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> ci = ln.indexOf(<span class="string">'#'</span>);</span><br><span class="line">    <span class="keyword">if</span> (ci &gt;= <span class="number">0</span>) ln = ln.substring(<span class="number">0</span>, ci);</span><br><span class="line">    ln = ln.trim();</span><br><span class="line">    <span class="keyword">int</span> n = ln.length();</span><br><span class="line">    <span class="keyword">if</span> (n != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((ln.indexOf(<span class="string">' '</span>) &gt;= <span class="number">0</span>) || (ln.indexOf(<span class="string">'\t'</span>) &gt;= <span class="number">0</span>))</span><br><span class="line">            fail(service, u, lc, <span class="string">"Illegal configuration-file syntax"</span>);</span><br><span class="line">        <span class="keyword">int</span> cp = ln.codePointAt(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (!Character.isJavaIdentifierStart(cp))</span><br><span class="line">            fail(service, u, lc, <span class="string">"Illegal provider-class name: "</span> + ln);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = Character.charCount(cp); i &lt; n; i += Character.charCount(cp)) &#123;</span><br><span class="line">            cp = ln.codePointAt(i);</span><br><span class="line">            <span class="keyword">if</span> (!Character.isJavaIdentifierPart(cp) &amp;&amp; (cp != <span class="string">'.'</span>))</span><br><span class="line">                fail(service, u, lc, <span class="string">"Illegal provider-class name: "</span> + ln);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!providers.containsKey(ln) &amp;&amp; !names.contains(ln))</span><br><span class="line"><span class="comment">//  添加当前行解析出的类名</span></span><br><span class="line">            names.add(ln);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> lc + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Parse the content of the given URL as a provider-configuration file.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// @param  service</span></span><br><span class="line"><span class="comment">//         The service type for which providers are being sought;</span></span><br><span class="line"><span class="comment">//         used to construct error detail strings</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// @param  u</span></span><br><span class="line"><span class="comment">//         The URL naming the configuration file to be parsed</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// @return A (possibly empty) iterator that will yield the provider-class</span></span><br><span class="line"><span class="comment">//         names in the given configuration file that are not yet members</span></span><br><span class="line"><span class="comment">//         of the returned set</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// @throws ServiceConfigurationError</span></span><br><span class="line"><span class="comment">//         If an I/O error occurs while reading from the given URL, or</span></span><br><span class="line"><span class="comment">//         if a configuration-file format error is detected</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Iterator&lt;String&gt; <span class="title">parse</span><span class="params">(Class service, URL u)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> ServiceConfigurationError</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    InputStream in = <span class="keyword">null</span>;</span><br><span class="line">    BufferedReader r = <span class="keyword">null</span>;</span><br><span class="line">    ArrayList&lt;String&gt; names = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        in = u.openStream();</span><br><span class="line">        r = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(in, <span class="string">"utf-8"</span>));</span><br><span class="line">        <span class="keyword">int</span> lc = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> ((lc = parseLine(service, u, r, lc, names)) &gt;= <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException x) &#123;</span><br><span class="line">        fail(service, <span class="string">"Error reading configuration file"</span>, x);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (r != <span class="keyword">null</span>) r.close();</span><br><span class="line">            <span class="keyword">if</span> (in != <span class="keyword">null</span>) in.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException y) &#123;</span><br><span class="line">            fail(service, <span class="string">"Error closing configuration file"</span>, y);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> names.iterator();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>默认情况下的DefaultSelectorProvider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultSelectorProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Prevent instantiation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">DefaultSelectorProvider</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the default SelectorProvider.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SelectorProvider <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String osname = AccessController.doPrivileged(</span><br><span class="line">            <span class="keyword">new</span> GetPropertyAction(<span class="string">"os.name"</span>));</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"SunOS"</span>.equals(osname)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> sun.nio.ch.DevPollSelectorProvider();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// use EPollSelectorProvider for Linux kernels &gt;= 2.6</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"Linux"</span>.equals(osname)) &#123;</span><br><span class="line">            String osversion = AccessController.doPrivileged(</span><br><span class="line">                <span class="keyword">new</span> GetPropertyAction(<span class="string">"os.version"</span>));</span><br><span class="line">            String[] vers = osversion.split(<span class="string">"\\."</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (vers.length &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">int</span> major = Integer.parseInt(vers[<span class="number">0</span>]);</span><br><span class="line">                    <span class="keyword">int</span> minor = Integer.parseInt(vers[<span class="number">1</span>]);</span><br><span class="line">                    <span class="keyword">if</span> (major &gt; <span class="number">2</span> || (major == <span class="number">2</span> &amp;&amp; minor &gt;= <span class="number">6</span>)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> sun.nio.ch.EPollSelectorProvider();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (NumberFormatException x) &#123;</span><br><span class="line">                    <span class="comment">// format not recognized</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> sun.nio.ch.PollSelectorProvider();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer2">
      <div id="footer-info" class="inner">
        <a href="http://www.618shoe.com/">莆田1:1精仿鞋微信号</a>
        <a href="http://www.618shoe.com/">莆田高仿鞋子的价格表</a>
        <a href="http://www.618shoe.com/">关于莆田仿鞋</a>
        <a href="http://www.618shoe.com/">莆田高仿鞋淘宝店店名</a>
        <a href="http://www.618shoe.com/">莆田精仿鞋官网</a>
         咨询QQ：<a title="点击这里给我发消息" href="http://wpa.qq.com/msgrd?v=3&amp;uin=2727291807&amp;site=www.cactussoft.cn&amp;menu=yes" target="_blank"><img src="http://wpa.qq.com/pa?p=2:2727291807:41"></a>
      </div>
        <div id="footer-info" class="inner">
          <a href="http://www.618shoe.com/">莆田高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">1：1高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">高仿鞋批发市场</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">高仿鞋网</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">广州高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">外贸尾单鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">精仿鞋专线</a>&nbsp;&nbsp;
      </div>
      <div id="footer-info" class="inner">
             <a href="http://www.618shoe.com/">莆田高仿鞋批发</a>&nbsp;&nbsp;
             公司网站:&nbsp;&nbsp;<a href="http://www.618shoe.com//" target="_blank">http://www.618shoe.com/</a>&nbsp;&nbsp;
             <a href="http://www.618shoe.com/">高仿鞋批发市场</a>
             微信 <img src="/pics/qrcode.jpg" style="width:100px;height:100px;">
      </div>
    </footer>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2013/08/27/selector-provider-spi/" data-id="cja9q2adk002pnh5i94vy71os" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-thrift-async-client" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2013/07/30/thrift-async-client/" class="article-date">
  <time datetime="2013-07-30T13:26:00.000Z" itemprop="datePublished">2013-07-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/thrift/">thrift</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/07/30/thrift-async-client/">thrift async client</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>####一、Java的thrift异步Client</p>
<p>#####1.异步的thrift client类 TAsyncClient</p>
<figure class="highlight java"><figcaption><span>TAsyncClient.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TAsyncClient</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> TProtocolFactory ___protocolFactory;</span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> TNonblockingTransport ___transport;</span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> TAsyncClientManager ___manager;</span><br><span class="line">  <span class="keyword">protected</span> TAsyncMethodCall ___currentMethod;</span><br><span class="line">  <span class="keyword">private</span> Exception ___error;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span> ___timeout;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">TAsyncClient</span><span class="params">(TProtocolFactory protocolFactory, TAsyncClientManager manager, TNonblockingTransport transport)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(protocolFactory, manager, transport, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">TAsyncClient</span><span class="params">(TProtocolFactory protocolFactory, TAsyncClientManager manager, TNonblockingTransport transport, <span class="keyword">long</span> timeout)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.___protocolFactory = protocolFactory;</span><br><span class="line">    <span class="keyword">this</span>.___manager = manager;</span><br><span class="line">    <span class="keyword">this</span>.___transport = transport;</span><br><span class="line">    <span class="keyword">this</span>.___timeout = timeout;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> TProtocolFactory <span class="title">getProtocolFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ___protocolFactory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getTimeout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ___timeout;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasTimeout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ___timeout &gt; <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTimeout</span><span class="params">(<span class="keyword">long</span> timeout)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.___timeout = timeout;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Is the client in an error state?</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> If client in an error state?</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasError</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ___error != <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Get the client's error - returns null if no error</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> Get the client's error. &lt;br /&gt; returns null if no error</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Exception <span class="title">getError</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ___error;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">checkReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 同时只能调用一个方法</span></span><br><span class="line">    <span class="comment">// Ensure we are not currently executing a method</span></span><br><span class="line">    <span class="keyword">if</span> (___currentMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Client is currently executing another method: "</span> + ___currentMethod.getClass().getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Ensure we're not in an error state</span></span><br><span class="line">    <span class="keyword">if</span> (___error != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Client has an error!"</span>, ___error);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called by delegate method when finished</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 当前方法完成</span></span><br><span class="line">    ___currentMethod = <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called by delegate method on error</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception exception)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 发生错误，关闭连接，赋值给__error</span></span><br><span class="line">    ___transport.close();</span><br><span class="line">    ___currentMethod = <span class="keyword">null</span>;</span><br><span class="line">    ___error = exception;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="2-异步方法调用"><a href="#2-异步方法调用" class="headerlink" title="2.异步方法调用"></a>2.异步方法调用</h5><figure class="highlight java"><figcaption><span>TAsyncMethodCall.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TAsyncMethodCall</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INITIAL_MEMORY_BUFFER_SIZE = <span class="number">128</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> AtomicLong sequenceIdCounter = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> State &#123;</span><br><span class="line">    CONNECTING,</span><br><span class="line">    WRITING_REQUEST_SIZE,</span><br><span class="line">    WRITING_REQUEST_BODY,</span><br><span class="line">    READING_RESPONSE_SIZE,</span><br><span class="line">    READING_RESPONSE_BODY,</span><br><span class="line">    RESPONSE_READ,</span><br><span class="line">    ERROR;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Next step in the call, initialized by start()</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> State state = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> TNonblockingTransport transport;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> TProtocolFactory protocolFactory;</span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> TAsyncClient client;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> AsyncMethodCallback&lt;T&gt; callback;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isOneway;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span> sequenceId;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> ByteBuffer sizeBuffer;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] sizeBufferArray = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">  <span class="keyword">private</span> ByteBuffer frameBuffer;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="title">TAsyncMethodCall</span><span class="params">(TAsyncClient client, TProtocolFactory protocolFactory, TNonblockingTransport transport, AsyncMethodCallback&lt;T&gt; callback, <span class="keyword">boolean</span> isOneway)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.transport = transport;</span><br><span class="line">    <span class="keyword">this</span>.callback = callback;</span><br><span class="line">    <span class="keyword">this</span>.protocolFactory = protocolFactory;</span><br><span class="line">    <span class="keyword">this</span>.client = client;</span><br><span class="line">    <span class="keyword">this</span>.isOneway = isOneway;</span><br><span class="line">    <span class="keyword">this</span>.sequenceId = TAsyncMethodCall.sequenceIdCounter.getAndIncrement();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> State <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isFinished</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> state == State.RESPONSE_READ;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">long</span> <span class="title">getStartTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> startTime;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">long</span> <span class="title">getSequenceId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sequenceId;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> TAsyncClient <span class="title">getClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> client;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasTimeout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> client.hasTimeout();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getTimeoutTimestamp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> client.getTimeout() + startTime;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 每个具体的方法调用会在这里面写入请求的方法名等信息。。。。</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">write_args</span><span class="params">(TProtocol protocol)</span> <span class="keyword">throws</span> TException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 准备方法调用：初始化缓存，写入参数到缓存中</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Initialize buffers.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> TException if buffer initialization fails</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareMethodCall</span><span class="params">()</span> <span class="keyword">throws</span> TException </span>&#123;</span><br><span class="line">	<span class="comment">// 准备方法调用写入参数</span></span><br><span class="line">    TMemoryBuffer memoryBuffer = <span class="keyword">new</span> TMemoryBuffer(INITIAL_MEMORY_BUFFER_SIZE);</span><br><span class="line">    TProtocol protocol = protocolFactory.getProtocol(memoryBuffer);</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// 写入方法的请求参数</span></span><br><span class="line">	write_args(protocol);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> length = memoryBuffer.length();</span><br><span class="line">    frameBuffer = ByteBuffer.wrap(memoryBuffer.getArray(), <span class="number">0</span>, length);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 写入frame size 和 实现内容</span></span><br><span class="line">    TFramedTransport.encodeFrameSize(length, sizeBufferArray);</span><br><span class="line">    sizeBuffer = ByteBuffer.wrap(sizeBufferArray);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Register with selector and start first state, which could be either connecting or writing.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> IOException if register or starting fails</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">(Selector sel)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    SelectionKey key;</span><br><span class="line">    <span class="keyword">if</span> (transport.isOpen()) &#123;</span><br><span class="line">	  <span class="comment">// 写入请求大小</span></span><br><span class="line">      state = State.WRITING_REQUEST_SIZE;</span><br><span class="line">	  <span class="comment">// 注册到选择器上</span></span><br><span class="line">      key = transport.registerSelector(sel, SelectionKey.OP_WRITE);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	  <span class="comment">// 建立连接</span></span><br><span class="line">      state = State.CONNECTING;</span><br><span class="line">	  <span class="comment">// 注册到选择器上</span></span><br><span class="line">      key = transport.registerSelector(sel, SelectionKey.OP_CONNECT);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// non-blocking connect can complete immediately,</span></span><br><span class="line">      <span class="comment">// in which case we should not expect the OP_CONNECT</span></span><br><span class="line">      <span class="keyword">if</span> (transport.startConnect()) &#123;</span><br><span class="line">        registerForFirstWrite(key);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 附上TAsyncMethodCall自身</span></span><br><span class="line">    key.attach(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">registerForFirstWrite</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    state = State.WRITING_REQUEST_SIZE;</span><br><span class="line">    key.interestOps(SelectionKey.OP_WRITE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> ByteBuffer <span class="title">getFrameBuffer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> frameBuffer;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">// 迁移到下一个状态	</span></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Transition to next state, doing whatever work is required. Since this</span></span><br><span class="line"><span class="comment">   * method is only called by the selector thread, we can make changes to our</span></span><br><span class="line"><span class="comment">   * select interests without worrying about concurrency.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">transition</span><span class="params">(SelectionKey key)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Ensure key is valid</span></span><br><span class="line">    <span class="keyword">if</span> (!key.isValid()) &#123;</span><br><span class="line">      key.cancel();</span><br><span class="line">      Exception e = <span class="keyword">new</span> TTransportException(<span class="string">"Selection key not valid!"</span>);</span><br><span class="line">      onError(e);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Transition function</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">        <span class="keyword">case</span> CONNECTING:</span><br><span class="line">          doConnecting(key);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> WRITING_REQUEST_SIZE:</span><br><span class="line">          doWritingRequestSize();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> WRITING_REQUEST_BODY:</span><br><span class="line">          doWritingRequestBody(key);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> READING_RESPONSE_SIZE:</span><br><span class="line">          doReadingResponseSize();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> READING_RESPONSE_BODY:</span><br><span class="line">          doReadingResponseBody(key);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">// RESPONSE_READ, ERROR, or bug</span></span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Method call in state "</span> + state</span><br><span class="line">              + <span class="string">" but selector called transition method. Seems like a bug..."</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      key.cancel();</span><br><span class="line">      key.attach(<span class="keyword">null</span>);</span><br><span class="line">      onError(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">    client.onError(e);</span><br><span class="line">    callback.onError(e);</span><br><span class="line">    state = State.ERROR;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doReadingResponseBody</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (transport.read(frameBuffer) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Read call frame failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (frameBuffer.remaining() == <span class="number">0</span>) &#123;</span><br><span class="line">      cleanUpAndFireCallback(key);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cleanUpAndFireCallback</span><span class="params">(SelectionKey key)</span> </span>&#123;</span><br><span class="line">    state = State.RESPONSE_READ;</span><br><span class="line">    key.interestOps(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// this ensures that the TAsyncMethod instance doesn't hang around</span></span><br><span class="line">    key.attach(<span class="keyword">null</span>);</span><br><span class="line">    client.onComplete();</span><br><span class="line">    callback.onComplete((T)<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doReadingResponseSize</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (transport.read(sizeBuffer) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Read call frame size failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (sizeBuffer.remaining() == <span class="number">0</span>) &#123;</span><br><span class="line">      state = State.READING_RESPONSE_BODY;</span><br><span class="line">      frameBuffer = ByteBuffer.allocate(TFramedTransport.decodeFrameSize(sizeBufferArray));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doWritingRequestBody</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (transport.write(frameBuffer) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Write call frame failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (frameBuffer.remaining() == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isOneway) &#123;</span><br><span class="line">        cleanUpAndFireCallback(key);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        state = State.READING_RESPONSE_SIZE;</span><br><span class="line">        sizeBuffer.rewind();  <span class="comment">// Prepare to read incoming frame size</span></span><br><span class="line">        key.interestOps(SelectionKey.OP_READ);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doWritingRequestSize</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (transport.write(sizeBuffer) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Write call frame size failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (sizeBuffer.remaining() == <span class="number">0</span>) &#123;</span><br><span class="line">      state = State.WRITING_REQUEST_BODY;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doConnecting</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!key.isConnectable() || !transport.finishConnect()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"not connectable or finishConnect returned false after we got an OP_CONNECT"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    registerForFirstWrite(key);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="3-TAsyncClientManager"><a href="#3-TAsyncClientManager" class="headerlink" title="3. TAsyncClientManager"></a>3. TAsyncClientManager</h5><p>可以同时支持多个client的异步调用，相当于客户端的NIO selector 和线程管理。</p>
<figure class="highlight java"><figcaption><span>TAsyncClientManager.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Contains selector thread which transitions method call objects</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TAsyncClientManager</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(TAsyncClientManager.class.getName());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> SelectThread selectThread;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentLinkedQueue&lt;TAsyncMethodCall&gt; pendingCalls = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;TAsyncMethodCall&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">TAsyncClientManager</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	<span class="comment">// 构造时即新建一个SelectThread线程</span></span><br><span class="line">    <span class="keyword">this</span>.selectThread = <span class="keyword">new</span> SelectThread();</span><br><span class="line">    selectThread.start();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 进行方法调用的入口</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(TAsyncMethodCall method)</span> <span class="keyword">throws</span> TException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isRunning()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> TException(<span class="string">"SelectThread is not running"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 准备方法调用，写入参数等</span></span><br><span class="line">    method.prepareMethodCall();</span><br><span class="line">	<span class="comment">// 加入等待队列</span></span><br><span class="line">    pendingCalls.add(method);</span><br><span class="line">	<span class="comment">// 立即唤醒selector, select 阻塞中会立即返回</span></span><br><span class="line">    selectThread.getSelector().wakeup();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    selectThread.finish();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isRunning</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> selectThread.isAlive();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Selector selector;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> running;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TreeSet&lt;TAsyncMethodCall&gt; timeoutWatchSet = <span class="keyword">new</span> TreeSet&lt;TAsyncMethodCall&gt;(<span class="keyword">new</span> TAsyncMethodCallTimeoutComparator());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SelectThread</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	  <span class="comment">// 创建selector </span></span><br><span class="line">      <span class="keyword">this</span>.selector = SelectorProvider.provider().openSelector();</span><br><span class="line">      <span class="keyword">this</span>.running = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">this</span>.setName(<span class="string">"TAsyncClientManager#SelectorThread "</span> + <span class="keyword">this</span>.getId());</span><br><span class="line"></span><br><span class="line">      <span class="comment">// We don't want to hold up the JVM when shutting down</span></span><br><span class="line">      setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Selector <span class="title">getSelector</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> selector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      running = <span class="keyword">false</span>;</span><br><span class="line">      selector.wakeup();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">while</span> (running) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">		  <span class="comment">// 进行select操作</span></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (timeoutWatchSet.size() == <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="comment">// No timeouts, so select indefinitely</span></span><br><span class="line">              selector.select();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">// We have a timeout pending, so calculate the time until then and select appropriately</span></span><br><span class="line">              <span class="keyword">long</span> nextTimeout = timeoutWatchSet.first().getTimeoutTimestamp();</span><br><span class="line">              <span class="keyword">long</span> selectTime = nextTimeout - System.currentTimeMillis();</span><br><span class="line">              <span class="keyword">if</span> (selectTime &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// Next timeout is in the future, select and wake up then</span></span><br><span class="line">                selector.select(selectTime);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Next timeout is now or in past, select immediately so we can time out</span></span><br><span class="line">                selector.selectNow();</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"Caught IOException in TAsyncClientManager!"</span>, e);</span><br><span class="line">          &#125;</span><br><span class="line">		  <span class="comment">// 迁移方法状态 </span></span><br><span class="line">          transitionMethods();</span><br><span class="line">		  <span class="comment">// 判断方法过期 </span></span><br><span class="line">          timeoutMethods();</span><br><span class="line">		  <span class="comment">// 开始那些等待的方法</span></span><br><span class="line">          startPendingMethods();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">          LOGGER.error(<span class="string">"Ignoring uncaught exception in SelectThread"</span>, exception);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Transition methods for ready keys</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">transitionMethods</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">// 处理各种就绪的keys </span></span><br><span class="line">        Iterator&lt;SelectionKey&gt; keys = selector.selectedKeys().iterator();</span><br><span class="line">        <span class="keyword">while</span> (keys.hasNext()) &#123;</span><br><span class="line">          SelectionKey key = keys.next();</span><br><span class="line">          keys.remove();</span><br><span class="line">          <span class="keyword">if</span> (!key.isValid()) &#123;</span><br><span class="line">            <span class="comment">// this can happen if the method call experienced an error and the</span></span><br><span class="line">            <span class="comment">// key was cancelled. can also happen if we timeout a method, which</span></span><br><span class="line">            <span class="comment">// results in a channel close.</span></span><br><span class="line">            <span class="comment">// just skip</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          TAsyncMethodCall methodCall = (TAsyncMethodCall)key.attachment();</span><br><span class="line">          methodCall.transition(key);</span><br><span class="line"></span><br><span class="line">		  <span class="comment">// 执行完成或发生错误，从timeout 中移出</span></span><br><span class="line">          <span class="comment">// If done or error occurred, remove from timeout watch set</span></span><br><span class="line">          <span class="keyword">if</span> (methodCall.isFinished() || methodCall.getClient().hasError()) &#123;</span><br><span class="line">            timeoutWatchSet.remove(methodCall);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (ClosedSelectorException e) &#123;</span><br><span class="line">        LOGGER.error(<span class="string">"Caught ClosedSelectorException in TAsyncClientManager!"</span>, e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 判断方法是否timeout</span></span><br><span class="line">    <span class="comment">// Timeout any existing method calls</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">timeoutMethods</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      Iterator&lt;TAsyncMethodCall&gt; iterator = timeoutWatchSet.iterator();</span><br><span class="line">      <span class="keyword">long</span> currentTime = System.currentTimeMillis();</span><br><span class="line">      <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">        TAsyncMethodCall methodCall = iterator.next();</span><br><span class="line">        <span class="keyword">if</span> (currentTime &gt;= methodCall.getTimeoutTimestamp()) &#123;</span><br><span class="line">          iterator.remove();</span><br><span class="line">          methodCall.onError(<span class="keyword">new</span> TimeoutException(<span class="string">"Operation "</span> + methodCall.getClass() + <span class="string">" timed out after "</span> + (currentTime - methodCall.getStartTime()) + <span class="string">" ms."</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start any new calls</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startPendingMethods</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      TAsyncMethodCall methodCall;</span><br><span class="line">      <span class="keyword">while</span> ((methodCall = pendingCalls.poll()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Catch registration errors. method will catch transition errors and cleanup.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">		  <span class="comment">// 开始执行方法，注册到selector上。</span></span><br><span class="line">          methodCall.start(selector);</span><br><span class="line"></span><br><span class="line">		  <span class="comment">// 加入timeout 监测</span></span><br><span class="line">          <span class="comment">// If timeout specified and first transition went smoothly, add to timeout watch set</span></span><br><span class="line">          TAsyncClient client = methodCall.getClient();</span><br><span class="line">          <span class="keyword">if</span> (client.hasTimeout() &amp;&amp; !client.hasError()) &#123;</span><br><span class="line">            timeoutWatchSet.add(methodCall);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">          LOGGER.warn(<span class="string">"Caught exception in TAsyncClientManager!"</span>, exception);</span><br><span class="line">          methodCall.onError(exception);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Comparator used in TreeSet */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TAsyncMethodCallTimeoutComparator</span> <span class="keyword">implements</span> <span class="title">Comparator</span>&lt;<span class="title">TAsyncMethodCall</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(TAsyncMethodCall left, TAsyncMethodCall right)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (left.getTimeoutTimestamp() == right.getTimeoutTimestamp()) &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>)(left.getSequenceId() - right.getSequenceId());</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>)(left.getTimeoutTimestamp() - right.getTimeoutTimestamp());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-TAsyncMethodCall-具体实现示例"><a href="#4-TAsyncMethodCall-具体实现示例" class="headerlink" title="4. TAsyncMethodCall 具体实现示例"></a>4. TAsyncMethodCall 具体实现示例</h5><figure class="highlight java"><figcaption><span>TAsyncMethodCall-add_call</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">add_call</span> <span class="keyword">extends</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">thrift</span>.<span class="title">async</span>.<span class="title">TAsyncMethodCall</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> a;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> b;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">add_call</span><span class="params">(<span class="keyword">long</span> a, <span class="keyword">long</span> b, org.apache.thrift.async.AsyncMethodCallback&lt;add_call&gt; resultHandler, org.apache.thrift.async.TAsyncClient client, org.apache.thrift.protocol.TProtocolFactory protocolFactory, org.apache.thrift.transport.TNonblockingTransport transport)</span> <span class="keyword">throws</span> org.apache.thrift.TException </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>(client, protocolFactory, transport, resultHandler, <span class="keyword">false</span>);</span><br><span class="line">      <span class="keyword">this</span>.a = a;</span><br><span class="line">      <span class="keyword">this</span>.b = b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 这个方法实现 写入请求的参数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write_args</span><span class="params">(org.apache.thrift.protocol.TProtocol prot)</span> <span class="keyword">throws</span> org.apache.thrift.TException </span>&#123;</span><br><span class="line"><span class="comment">// 写入请求的方法名</span></span><br><span class="line">      prot.writeMessageBegin(<span class="keyword">new</span> org.apache.thrift.protocol.TMessage(<span class="string">"add"</span>, org.apache.thrift.protocol.TMessageType.CALL, <span class="number">0</span>));</span><br><span class="line">      add_args args = <span class="keyword">new</span> add_args();</span><br><span class="line">      args.setA(a);</span><br><span class="line">      args.setB(b);</span><br><span class="line">      args.write(prot);</span><br><span class="line">      prot.writeMessageEnd();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="二、Python的异步调用Client"><a href="#二、Python的异步调用Client" class="headerlink" title="二、Python的异步调用Client"></a>二、Python的异步调用Client</h4><h5 id="1-生成的Python接口文件"><a href="#1-生成的Python接口文件" class="headerlink" title="1. 生成的Python接口文件"></a>1. 生成的Python接口文件</h5><figure class="highlight python"><figcaption><span>OAuthProviderService.py-Iface</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Iface</span><span class="params">(object)</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">registerApp</span><span class="params">(self, app, callback)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Parameters:</span></span><br><span class="line"><span class="string">     - app</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="2-生成的Client实现类"><a href="#2-生成的Client实现类" class="headerlink" title="2. 生成的Client实现类"></a>2. 生成的Client实现类</h5><figure class="highlight python"><figcaption><span>OAuthProviderService.py-Client</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Client</span><span class="params">(Iface)</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, transport, iprot_factory, oprot_factory=None)</span>:</span></span><br><span class="line">    self._transport = transport</span><br><span class="line">    self._iprot_factory = iprot_factory</span><br><span class="line">    self._oprot_factory = (oprot_factory <span class="keyword">if</span> oprot_factory <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span></span><br><span class="line">                           <span class="keyword">else</span> iprot_factory)</span><br><span class="line">	<span class="comment"># 初始化请求的id</span></span><br><span class="line">    self._seqid = <span class="number">0</span></span><br><span class="line">    self._reqs = &#123;&#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment"># 请求回调时的处理类</span></span><br><span class="line"><span class="meta">  @gen.engine</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">recv_dispatch</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="string">"""read a response from the wire. schedule exactly one per send that</span></span><br><span class="line"><span class="string">    expects a response, but it doesn't matter which callee gets which</span></span><br><span class="line"><span class="string">    response; they're dispatched here properly"""</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#等待数据返回</span></span><br><span class="line">	<span class="comment">#发送请求A</span></span><br><span class="line">	<span class="comment">#发送请求B</span></span><br><span class="line">	<span class="comment">#有可能发生：先返回请求B，再返回请求A的情景，所以根据seqid等信息来获取相应的callback方法</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment"># 等待网络IO有数据返回，并且读取到frame</span></span><br><span class="line">    <span class="comment"># wait for a frame header</span></span><br><span class="line">    frame = <span class="keyword">yield</span> gen.Task(self._transport.readFrame)</span><br><span class="line">	<span class="comment">#放入内存TTransport	</span></span><br><span class="line">    tr = TTransport.TMemoryBuffer(frame)</span><br><span class="line">	<span class="comment">#读取方法名称，消息类型，返回的reqid</span></span><br><span class="line">    iprot = self._iprot_factory.getProtocol(tr)</span><br><span class="line">    (fname, mtype, rseqid) = iprot.readMessageBegin()</span><br><span class="line">	<span class="comment">#通过反射获取方法</span></span><br><span class="line">    method = getattr(self, <span class="string">'recv_'</span> + fname)</span><br><span class="line">	<span class="comment">#调用回调方法</span></span><br><span class="line">    method(iprot, mtype, rseqid)</span><br><span class="line"></span><br><span class="line">  <span class="comment">#实际的业务方法：注册App</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">registerApp</span><span class="params">(self, app, callback)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Parameters:</span></span><br><span class="line"><span class="string">     - app</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    self._seqid += <span class="number">1</span> <span class="comment">#seqid加1</span></span><br><span class="line">	<span class="comment">#将回调方法，放入类的请求队列中，相当于一个map</span></span><br><span class="line">    self._reqs[self._seqid] = callback</span><br><span class="line">	<span class="comment">#发送数据请求</span></span><br><span class="line">    self.send_registerApp(app)</span><br><span class="line">	<span class="comment">#等待请求返回</span></span><br><span class="line">    self.recv_dispatch()</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">send_registerApp</span><span class="params">(self, app)</span>:</span></span><br><span class="line">	<span class="comment">#获取输出协议</span></span><br><span class="line">    oprot = self._oprot_factory.getProtocol(self._transport)</span><br><span class="line">	<span class="comment">#写入消息头：调用方法、消息类型、seqId</span></span><br><span class="line">	<span class="comment">#写入请求参数：方法的调用参数</span></span><br><span class="line">	<span class="comment">#flush transport的数据内容到网络 </span></span><br><span class="line">    oprot.writeMessageBegin(<span class="string">'registerApp'</span>, TMessageType.CALL, self._seqid)</span><br><span class="line">    args = registerApp_args()</span><br><span class="line">    args.app = app</span><br><span class="line">    args.write(oprot)</span><br><span class="line">    oprot.writeMessageEnd()</span><br><span class="line">    oprot.trans.flush()</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">recv_registerApp</span><span class="params">(self, iprot, mtype, rseqid)</span>:</span></span><br><span class="line">	<span class="comment">#根据rseqid从请求队列中获取callback回调方法</span></span><br><span class="line">    callback = self._reqs.pop(rseqid)</span><br><span class="line">	<span class="comment">#根据返回的消息类型进行相应处理</span></span><br><span class="line">    <span class="keyword">if</span> mtype == TMessageType.EXCEPTION:</span><br><span class="line">      x = TApplicationException()</span><br><span class="line">      x.read(iprot)</span><br><span class="line">      iprot.readMessageEnd()</span><br><span class="line">      callback(x)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    result = registerApp_result()</span><br><span class="line">    result.read(iprot)</span><br><span class="line">    iprot.readMessageEnd()</span><br><span class="line">    <span class="keyword">if</span> result.success <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">      callback(result.success)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    callback(TApplicationException(TApplicationException.MISSING_RESULT, <span class="string">"registerApp failed: unknown result"</span>))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="3-与tornado的ioloop-结合在一起的-TTornadoStreamTransport"><a href="#3-与tornado的ioloop-结合在一起的-TTornadoStreamTransport" class="headerlink" title="3. 与tornado的ioloop 结合在一起的 TTornadoStreamTransport"></a>3. 与tornado的ioloop 结合在一起的 TTornadoStreamTransport</h5><figure class="highlight python"><figcaption><span>TTornadoStreamTransport.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TTornadoStreamTransport</span><span class="params">(TTransport.TTransportBase)</span>:</span></span><br><span class="line">    </span><br><span class="line">	<span class="string">"""a framed, buffered transport over a Tornado stream"""</span></span><br><span class="line">	<span class="comment">#构造函数，传入目标的host,port</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, host, port, stream=None)</span>:</span></span><br><span class="line">        self.host = host</span><br><span class="line">        self.port = port</span><br><span class="line">        self.is_queuing_reads = <span class="keyword">False</span></span><br><span class="line">        self.read_queue = []</span><br><span class="line">        self.__wbuf = StringIO()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># servers provide a ready-to-go stream</span></span><br><span class="line">        self.stream = stream</span><br><span class="line">        <span class="keyword">if</span> self.stream <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            self._set_close_callback()</span><br><span class="line"></span><br><span class="line">	<span class="comment">#打开transport,（进行网络连接）</span></span><br><span class="line">    <span class="comment"># not the same number of parameters as TTransportBase.open</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(self, callback)</span>:</span></span><br><span class="line">		<span class="comment">#创建一个sock</span></span><br><span class="line">        logging.debug(<span class="string">'socket connecting'</span>)</span><br><span class="line">        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM, <span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">		<span class="comment">#构造tornado的iostream对象</span></span><br><span class="line">		self.stream = iostream.IOStream(sock)</span><br><span class="line"></span><br><span class="line">		<span class="comment">#连接失败的回调函数</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">on_close_in_connect</span><span class="params">(*_)</span>:</span></span><br><span class="line">            message = <span class="string">'could not connect to %s:%s'</span> % (self.host, self.port)</span><br><span class="line">            <span class="keyword">raise</span> TTransportException(</span><br><span class="line">                type=TTransportException.NOT_OPEN,</span><br><span class="line">                message=message)</span><br><span class="line">        self.stream.set_close_callback(on_close_in_connect)</span><br><span class="line"></span><br><span class="line">		<span class="comment">#连接成功的回调函数</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">finish</span><span class="params">(*_)</span>:</span></span><br><span class="line">            self._set_close_callback()</span><br><span class="line">            callback()</span><br><span class="line"></span><br><span class="line">        self.stream.connect((self.host, self.port), callback=finish)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_set_close_callback</span><span class="params">(self)</span>:</span></span><br><span class="line">		<span class="comment">#这里定义的这个方法有啥用？？？？</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">on_close</span><span class="params">()</span>:</span></span><br><span class="line">            <span class="keyword">raise</span> TTransportException(</span><br><span class="line">                type=TTransportException.END_OF_FILE,</span><br><span class="line">                message=<span class="string">'socket closed'</span>)</span><br><span class="line">        self.stream.set_close_callback(self.close)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># don't raise if we intend to close</span></span><br><span class="line">        self.stream.set_close_callback(<span class="keyword">None</span>)</span><br><span class="line">        self.stream.close()</span><br><span class="line"></span><br><span class="line">	<span class="comment">#从不进行单独的读取操作，每次只能读取一个frame</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(self, _)</span>:</span></span><br><span class="line">        <span class="comment"># The generated code for Tornado shouldn't do individual reads -- only</span></span><br><span class="line">        <span class="comment"># frames at a time</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="string">"you're doing it wrong"</span> <span class="keyword">is</span> <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @gen.engine</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">readFrame</span><span class="params">(self, callback)</span>:</span></span><br><span class="line">        self.read_queue.append(callback)</span><br><span class="line">        logging.debug(<span class="string">'read queue: %s'</span>, self.read_queue)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.is_queuing_reads:</span><br><span class="line">            <span class="comment"># If a read is already in flight, then the while loop below should</span></span><br><span class="line">            <span class="comment"># pull it from self.read_queue</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        self.is_queuing_reads = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">while</span> self.read_queue:</span><br><span class="line">            next_callback = self.read_queue.pop()</span><br><span class="line">            result = <span class="keyword">yield</span> gen.Task(self._readFrameFromStream)</span><br><span class="line">            next_callback(result)</span><br><span class="line">        self.is_queuing_reads = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#从数据流中读取数据帧</span></span><br><span class="line"><span class="meta">    @gen.engine</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_readFrameFromStream</span><span class="params">(self, callback)</span>:</span></span><br><span class="line">        logging.debug(<span class="string">'_readFrameFromStream'</span>)</span><br><span class="line">		<span class="comment">#读取帧头得到帧的长度</span></span><br><span class="line">        frame_header = <span class="keyword">yield</span> gen.Task(self.stream.read_bytes, <span class="number">4</span>)</span><br><span class="line">        frame_length, = struct.unpack(<span class="string">'!i'</span>, frame_header)</span><br><span class="line">        logging.debug(<span class="string">'received frame header, frame length = %i'</span>, frame_length)</span><br><span class="line">		<span class="comment">#读完整个帧</span></span><br><span class="line">        frame = <span class="keyword">yield</span> gen.Task(self.stream.read_bytes, frame_length)</span><br><span class="line">        logging.debug(<span class="string">'received frame payload'</span>)</span><br><span class="line">        callback(frame)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#写入到当前的buffer中</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(self, buf)</span>:</span></span><br><span class="line">        self.__wbuf.write(buf)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">flush</span><span class="params">(self, callback=None)</span>:</span></span><br><span class="line">		<span class="comment">#得到输出的缓冲内容</span></span><br><span class="line">        wout = self.__wbuf.getvalue()</span><br><span class="line">		<span class="comment">#输出内容的长度	        </span></span><br><span class="line">		wsz = len(wout)</span><br><span class="line"></span><br><span class="line">		<span class="comment">#frame的数据格式：4个字节的整数表示帧大小|帧的数据内容|</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># reset wbuf before write/flush to preserve state on underlying failure</span></span><br><span class="line">        self.__wbuf = StringIO()</span><br><span class="line">        <span class="comment"># N.B.: Doing this string concatenation is WAY cheaper than making</span></span><br><span class="line">        <span class="comment"># two separate calls to the underlying socket object. Socket writes in</span></span><br><span class="line">        <span class="comment"># Python turn out to be REALLY expensive, but it seems to do a pretty</span></span><br><span class="line">        <span class="comment"># good job of managing string buffer operations without excessive copies</span></span><br><span class="line">        buf = struct.pack(<span class="string">"!i"</span>, wsz) + wout</span><br><span class="line"></span><br><span class="line">        logging.debug(<span class="string">'writing frame length = %i'</span>, wsz)</span><br><span class="line">        self.stream.write(buf, callback)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="4-tornado与thrift-结合client-的包装器"><a href="#4-tornado与thrift-结合client-的包装器" class="headerlink" title="4. tornado与thrift 结合client 的包装器"></a>4. tornado与thrift 结合client 的包装器</h5><figure class="highlight python"><figcaption><span>ClientWrapper</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Client</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">        Thrift Client proxying thrift methods defined on `iface_cls`.</span></span><br><span class="line"><span class="string">        A simple load balancer added in.</span></span><br><span class="line"><span class="string">        the MISSING_RESULT exception will be changed None to calller.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    """</span>    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, iface_cls, servers)</span>:</span></span><br><span class="line">        self._iface_cls = iface_cls</span><br><span class="line">        self._servers = servers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, attr)</span>:</span></span><br><span class="line"><span class="meta">        @gen.engine</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">client_call</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">            server = self._find_server()</span><br><span class="line">            host, port = server.split(<span class="string">":"</span>)</span><br><span class="line">            transport = cloudatlas.thrift.TTornado.TTornadoStreamTransport(host, int(port))</span><br><span class="line">            pfactory = TBinaryProtocol.TBinaryProtocolFactory()</span><br><span class="line">            _client = self._iface_cls(transport, pfactory) </span><br><span class="line">                     </span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">yield</span> gen.Task(transport.open)</span><br><span class="line">        </span><br><span class="line">                _callback = kwargs[<span class="string">'callback'</span>]</span><br><span class="line">                <span class="keyword">del</span>(kwargs[<span class="string">'callback'</span>])</span><br><span class="line"></span><br><span class="line">                result = <span class="keyword">yield</span> gen.Task(getattr(_client, attr), *args, **kwargs)</span><br><span class="line">                <span class="comment">#print result</span></span><br><span class="line">                <span class="keyword">if</span> type(result) == Thrift.TApplicationException <span class="keyword">and</span> result.type == Thrift.TApplicationException.MISSING_RESULT:</span><br><span class="line">                    result = <span class="keyword">None</span> <span class="comment"># ---------------------- hacking for return None object </span></span><br><span class="line">                _client._transport.close()</span><br><span class="line">                _callback(result)</span><br><span class="line">            <span class="keyword">except</span> TTransport.TTransportException <span class="keyword">as</span> e:</span><br><span class="line">                _client._transport.close()</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                _client._transport.close()</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">        setattr(self, attr, client_call)</span><br><span class="line">        <span class="keyword">return</span> getattr(self, attr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_find_server</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">''' no round robin, just random choose a server '''</span></span><br><span class="line">        <span class="keyword">return</span> choice(self._servers)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer2">
      <div id="footer-info" class="inner">
        <a href="http://www.618shoe.com/">莆田1:1精仿鞋微信号</a>
        <a href="http://www.618shoe.com/">莆田高仿鞋子的价格表</a>
        <a href="http://www.618shoe.com/">关于莆田仿鞋</a>
        <a href="http://www.618shoe.com/">莆田高仿鞋淘宝店店名</a>
        <a href="http://www.618shoe.com/">莆田精仿鞋官网</a>
         咨询QQ：<a title="点击这里给我发消息" href="http://wpa.qq.com/msgrd?v=3&amp;uin=2727291807&amp;site=www.cactussoft.cn&amp;menu=yes" target="_blank"><img src="http://wpa.qq.com/pa?p=2:2727291807:41"></a>
      </div>
        <div id="footer-info" class="inner">
          <a href="http://www.618shoe.com/">莆田高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">1：1高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">高仿鞋批发市场</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">高仿鞋网</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">广州高仿鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">外贸尾单鞋批发</a>&nbsp;&nbsp;
          <a href="http://www.618shoe.com/">精仿鞋专线</a>&nbsp;&nbsp;
      </div>
      <div id="footer-info" class="inner">
             <a href="http://www.618shoe.com/">莆田高仿鞋批发</a>&nbsp;&nbsp;
             公司网站:&nbsp;&nbsp;<a href="http://www.618shoe.com//" target="_blank">http://www.618shoe.com/</a>&nbsp;&nbsp;
             <a href="http://www.618shoe.com/">高仿鞋批发市场</a>
             微信 <img src="/pics/qrcode.jpg" style="width:100px;height:100px;">
      </div>
    </footer>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2013/07/30/thrift-async-client/" data-id="cja9q2adm002rnh5ijpbvpj5d" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Catégories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Algorithm/">Algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Architecture/">Architecture</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/DevTools/">DevTools</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/DevTools-Eclipse/">DevTools Eclipse</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java-Btrace/">Java Btrace</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java-JVM/">Java JVM</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java-MultiThreading/">Java MultiThreading</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java-NIO/">Java NIO</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java-Reflection/">Java Reflection</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java-Unicode/">Java Unicode</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux-Shell/">Linux Shell</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MongoDB/">MongoDB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/NSQ-golang/">NSQ golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Solr/">Solr</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Solr-Lucene/">Solr Lucene</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Unicode-Python/">Unicode Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git-DevTools/">git DevTools</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/jafka-zookeeper/">jafka zookeeper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/jsonp-security/">jsonp security</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/thrift/">thrift</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/zookeeper/">zookeeper</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02/">February 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">August 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">July 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">March 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">December 2012</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Articles récents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/11/21/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2015/01/16/process-task-by-queue/">process task by queue</a>
          </li>
        
          <li>
            <a href="/2015/01/15/threadpoolexecutor/">ThreadPoolExecutor 学习笔记</a>
          </li>
        
          <li>
            <a href="/2014/02/19/nsq-internals/">nsq internals</a>
          </li>
        
          <li>
            <a href="/2014/02/18/nsq-design/">nsq design</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
 	<div id="footer-info" class="inner">
     咨询QQ：<a title="点击这里给我发消息" href="http://wpa.qq.com/msgrd?v=3&amp;uin=2727291807&amp;site=www.cactussoft.cn&amp;menu=yes" target="_blank"><img src="http://wpa.qq.com/pa?p=2:2727291807:41"></a>
 	</div>
   	<div id="footer-info" class="inner">
     	<a href="http://www.618shoe.com/">莆田高仿鞋批发</a>&nbsp;&nbsp;
     	<a href="http://www.618shoe.com/">1：1高仿鞋批发</a>&nbsp;&nbsp;
     	<a href="http://www.618shoe.com/">高仿鞋批发市场</a>&nbsp;&nbsp;
     	<a href="http://www.618shoe.com/">高仿鞋网</a>&nbsp;&nbsp;
     	<a href="http://www.618shoe.com/">广州高仿鞋批发</a>&nbsp;&nbsp;
    	<a href="http://www.618shoe.com/">外贸尾单鞋批发</a>&nbsp;&nbsp;
    	<a href="http://www.618shoe.com/">精仿鞋专线</a>&nbsp;&nbsp;
	</div>
 	<div id="footer-info" class="inner">
         <a href="http://www.618shoe.com/">莆田高仿鞋批发微信号</a>&nbsp;&nbsp;
         公司网站:&nbsp;&nbsp;<a href="http://www.618shoe.com//" target="_blank">http://www.618shoe.com/</a>&nbsp;&nbsp;
         <a href="http://www.618shoe.com/">高仿鞋批发市场</a>
         微信 <img src="/pics/qrcode.jpg" style="width:100px;height:100px;">
 	</div>
    <div id="footer-info" class="inner">
      &copy; 2017 Sharewind<br>
      Propulsé by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>